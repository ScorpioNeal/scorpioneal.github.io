<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="AndroidView,">










<meta name="description" content="https://www.jianshu.com/p/131faec834d1https://www.jianshu.com/p/2f19fe1e3ca1 本文将从一个实际问题出发，带领大家分析Android动画的原理(ValueAnimator), 以及动画集合(AnimatorSet)在不同平台上的不一样的组织形式。 Contents:  一段代码在不同设备上的不同表现 代码 Android23">
<meta name="keywords" content="AndroidView">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 动画原理分析">
<meta property="og:url" content="http://blog.scions.cn/posts/4ea354ae/index.html">
<meta property="og:site_name" content="ScorpioNeal&#39;s Blog">
<meta property="og:description" content="https://www.jianshu.com/p/131faec834d1https://www.jianshu.com/p/2f19fe1e3ca1 本文将从一个实际问题出发，带领大家分析Android动画的原理(ValueAnimator), 以及动画集合(AnimatorSet)在不同平台上的不一样的组织形式。 Contents:  一段代码在不同设备上的不同表现 代码 Android23">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-12-09T13:01:07.137Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 动画原理分析">
<meta name="twitter:description" content="https://www.jianshu.com/p/131faec834d1https://www.jianshu.com/p/2f19fe1e3ca1 本文将从一个实际问题出发，带领大家分析Android动画的原理(ValueAnimator), 以及动画集合(AnimatorSet)在不同平台上的不一样的组织形式。 Contents:  一段代码在不同设备上的不同表现 代码 Android23">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.scions.cn/posts/4ea354ae/">





  <title>Android 动画原理分析 | ScorpioNeal's Blog</title>
  








  <link rel="stylesheet" href="/live2d/css/live2d.css">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
<div class="bg_content">
<canvas id="canvas"></canvas>
</div>
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ScorpioNeal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            todo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/4ea354ae/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android 动画原理分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-12T09:37:04+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/4ea354ae/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/4ea354ae/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://www.jianshu.com/p/131faec834d1" target="_blank" rel="noopener">https://www.jianshu.com/p/131faec834d1</a><br><a href="https://www.jianshu.com/p/2f19fe1e3ca1" target="_blank" rel="noopener">https://www.jianshu.com/p/2f19fe1e3ca1</a></p>
<p>本文将从一个实际问题出发，带领大家分析Android动画的原理(<code>ValueAnimator</code>), 以及动画集合(<code>AnimatorSet</code>)在不同平台上的不一样的组织形式。</p>
<p>Contents:</p>
<ul>
<li>一段代码在不同设备上的不同表现<ul>
<li>代码</li>
<li>Android23上的表现</li>
<li>Android24上的表现</li>
<li>现象描述</li>
</ul>
</li>
<li>动画源码分析<ul>
<li>ValueAnimator源码分析</li>
<li>AnimatorSet源码分析(based on Android 23)</li>
<li>AnimatorSet源码分析(based on Android 24)</li>
</ul>
</li>
<li>回归问题，导致不同表现的原因</li>
</ul>
<h2 id="一段代码在不同设备上的不同表现"><a href="#一段代码在不同设备上的不同表现" class="headerlink" title="一段代码在不同设备上的不同表现"></a>一段代码在不同设备上的不同表现</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">mFirstValueAnimator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">2000</span>);</span><br><span class="line">mFirstValueAnimator.setDuration(<span class="number">1000</span>);</span><br><span class="line">mFirstValueAnimator.setInterpolator(<span class="keyword">new</span> AccelerateDecelerateInterpolator());</span><br><span class="line">mFirstValueAnimator.addUpdateListener(<span class="keyword">new</span> ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationUpdate..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">mFirstValueAnimator.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationStart..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationEnd...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationCancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationRepeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">mFirstValueAnimator.start();</span><br><span class="line">Debug.i(TAG, <span class="string">"first anim anim start...."</span>);</span><br><span class="line"></span><br><span class="line">mSecondValueAnimator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">2000f</span>);</span><br><span class="line">mSecondValueAnimator.setDuration(<span class="number">1000</span>);</span><br><span class="line">mSecondValueAnimator.setInterpolator(<span class="keyword">new</span> AccelerateDecelerateInterpolator());</span><br><span class="line">mSecondValueAnimator.addUpdateListener(<span class="keyword">new</span> ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationUpdate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">mSecondValueAnimator.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationStart..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationEnd...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationCancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationRepeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</span><br><span class="line">set.setDuration(<span class="number">500</span>);</span><br><span class="line">set.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet start..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet end..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet cancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet repeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">set.play(mFirstValueAnimator).with(mSecondValueAnimator);</span><br><span class="line">set.start();</span><br><span class="line">Debug.i(TAG, <span class="string">"animator set start..."</span>);</span><br></pre></td></tr></table></figure>

<h3 id="在Android-23-上输出"><a href="#在Android-23-上输出" class="headerlink" title="在Android 23 上输出"></a>在Android 23 上输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationStart:<span class="number">34</span>&gt; first anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity:onCreate:<span class="number">54</span>&gt; first anim anim start....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.396</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.396</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationStart:<span class="number">92</span>&gt; animatorSet start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.397</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity:onCreate:<span class="number">112</span>&gt; animator set start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.417</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.418</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.491</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.491</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.950</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.950</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.951</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationEnd:<span class="number">39</span>&gt; first anim onAnimationEnd....</span><br></pre></td></tr></table></figure>

<h3 id="在Android-24上输出"><a href="#在Android-24上输出" class="headerlink" title="在Android 24上输出"></a>在Android 24上输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationStart:<span class="number">34</span>&gt; first anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity:onCreate:<span class="number">54</span>&gt; first anim anim start....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">4</span>:onAnimationStart:<span class="number">68</span>&gt; second anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.944</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationStart:<span class="number">92</span>&gt; animatorSet start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.944</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity:onCreate:<span class="number">112</span>&gt; animator set start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.967</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.427</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.445</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.477</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.492</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationEnd:<span class="number">39</span>&gt; first anim onAnimationEnd....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">4</span>:onAnimationEnd:<span class="number">73</span>&gt; second anim onAnimationEnd....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.494</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationEnd:<span class="number">97</span>&gt; animatorSet end...</span><br></pre></td></tr></table></figure>

<h3 id="现象描述"><a href="#现象描述" class="headerlink" title="现象描述"></a>现象描述</h3><p>简单的2个<code>ValueAnimator</code>动画, <code>ValueAnimator1</code>和<code>ValueAnimator2</code>，以后简称<code>anim1</code>, <code>anim2</code>, 通过<code>AnimatorSet</code>动画集合按照<code>play anim1 with anim2</code>的规则组织在一起，也就是<code>anim1</code>和<code>anim2</code>一起<code>start</code>.</p>
<p>按照我们的预期, <code>anim1</code>和<code>anim2</code>的执行应该是<br><code>anim1 start -&gt; anim1 update -&gt; anim1 end</code><br><code>anim2 start -&gt; anim2 update -&gt; anim2 end</code><br>交替在一起，像两个线程并发执行一样.</p>
<p>但实际上:</p>
<ul>
<li>在Android23上只有anim1的start, update, end. anim2完全被屏蔽了</li>
<li>在Android 24上， anim1和anim2貌似是符合预期的</li>
</ul>
<p>下面我们将会一步步的从源码来分析这个现象产生的原因。</p>
<h2 id="动画源码分析"><a href="#动画源码分析" class="headerlink" title="动画源码分析"></a>动画源码分析</h2><h3 id="ValueAnimator源码分析"><a href="#ValueAnimator源码分析" class="headerlink" title="ValueAnimator源码分析"></a>ValueAnimator源码分析</h3><p>首先进入<code>start</code>方法, 前面几行都是对一些状态进行的初始化，不细说，最后一块代码比较关键</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  AnimationHandler animationHandler = getOrCreateAnimationHandler();</span><br><span class="line">  animationHandler.mPendingAnimations.add(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// This sets the initial value of the animation, prior to actually starting it running</span></span><br><span class="line">      <span class="keyword">if</span> (prevPlayingState != SEEKED) &#123;</span><br><span class="line">          setCurrentPlayTime(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      mPlayingState = STOPPED;</span><br><span class="line">      mRunning = <span class="keyword">true</span>;</span><br><span class="line">      notifyStartListeners();</span><br><span class="line">  &#125;</span><br><span class="line">animationHandler.start();</span><br></pre></td></tr></table></figure>

<p>如果<code>mStartDelay==0</code>, 也就是启动动画没有延迟, <code>notifyStartListeners()</code>, 进入这个方法可以看到熟悉的<code>onAnimationStart</code>回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStartListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    tmpListeners.get(i).onAnimationStart(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着来看<code>animationHandler.start()</code>, 这里是动画执行的核心. <code>AnimationHandler</code>是一个静态的内部类，里面定义了以下关键变量<code>mAnimations</code>, <code>mTmpAnimations</code>, <code>mPendingAnimations</code>, <code>mDelayedAnims</code>, <code>mEndingAnims</code>, <code>mReadyAnims</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used in doAnimationFrame() to avoid concurrent modifications of mAnimations</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mTmpAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// The per-thread set of animations to be started on the next animation frame</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mPendingAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Internal per-thread collections used to avoid set collisions as animations start and end</span></span><br><span class="line"><span class="comment">* while being processed.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mDelayedAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mEndingAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mReadyAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br></pre></td></tr></table></figure>

<p>接着进入前文中的<code>animationHandler.start()</code>方法里, 里面调用了<code>scheduleAnimation()</code>这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mAnimationScheduled) &#123;</span><br><span class="line">      mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="keyword">null</span>);</span><br><span class="line">      mAnimationScheduled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>mChoreographer.postCallback</code>用法类似于mHandler.post方法，也就是这个方法具体执行在<code>mAnimate</code>这个runnable里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mAnimate = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mAnimationScheduled = <span class="keyword">false</span>;</span><br><span class="line">            doAnimationFrame(mChoreographer.getFrameTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>这儿简单介绍下<code>mchoreographer</code>是个跟系统时钟相关的类，系统每过16ms会发出<code>VSYNC</code>信号, 触发屏幕渲染, 刷新一次UI, 当然也可以手动的更改刷新频率。这里的<code>mChoreographer.getFrameTime()</code>就是获取这一次刷新的时间，进入到<code>doAnimationFrame</code>方法里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    mLastFrameTime = frameTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mPendingAnimations holds any animations that have requested to be started</span></span><br><span class="line">    <span class="comment">// We're going to clear mPendingAnimations, but starting animation may</span></span><br><span class="line">    <span class="comment">// cause more to be added to the pending list (for example, if one animation</span></span><br><span class="line">    <span class="comment">// starting triggers another starting). So we loop until mPendingAnimations</span></span><br><span class="line">    <span class="comment">// is empty.</span></span><br><span class="line">    <span class="keyword">while</span> (mPendingAnimations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ArrayList&lt;ValueAnimator&gt; pendingCopy =</span><br><span class="line">                        (ArrayList&lt;ValueAnimator&gt;) mPendingAnimations.clone();</span><br><span class="line">        mPendingAnimations.clear();</span><br><span class="line">        <span class="keyword">int</span> count = pendingCopy.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">            ValueAnimator anim = pendingCopy.get(i);</span><br><span class="line">            <span class="comment">// If the animation has a startDelay, place it on the delayed list</span></span><br><span class="line">            <span class="keyword">if</span> (anim.mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                anim.startAnimation(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDelayedAnims.add(anim);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, process animations currently sitting on the delayed queue, adding</span></span><br><span class="line">    <span class="comment">// them to the active animations if they are ready</span></span><br><span class="line">    <span class="keyword">int</span> numDelayedAnims = mDelayedAnims.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDelayedAnims; ++i) &#123;</span><br><span class="line">        ValueAnimator anim = mDelayedAnims.get(i);</span><br><span class="line">        <span class="keyword">if</span> (anim.delayedAnimationFrame(frameTime)) &#123;</span><br><span class="line">            mReadyAnims.add(anim);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> numReadyAnims = mReadyAnims.size();</span><br><span class="line">    <span class="keyword">if</span> (numReadyAnims &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numReadyAnims; ++i) &#123;</span><br><span class="line">            ValueAnimator anim = mReadyAnims.get(i);</span><br><span class="line">            anim.startAnimation(<span class="keyword">this</span>);</span><br><span class="line">            anim.mRunning = <span class="keyword">true</span>;</span><br><span class="line">            mDelayedAnims.remove(anim);</span><br><span class="line">        &#125;</span><br><span class="line">        mReadyAnims.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now process all active animations. The return value from animationFrame()</span></span><br><span class="line">    <span class="comment">// tells the handler whether it should now be ended</span></span><br><span class="line">    <span class="keyword">int</span> numAnims = mAnimations.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">        mTmpAnimations.add(mAnimations.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">        ValueAnimator anim = mTmpAnimations.get(i);</span><br><span class="line">        <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</span><br><span class="line">            mEndingAnims.add(anim);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mTmpAnimations.clear();</span><br><span class="line">    <span class="keyword">if</span> (mEndingAnims.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mEndingAnims.size(); ++i) &#123;</span><br><span class="line">            mEndingAnims.get(i).endAnimation(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mEndingAnims.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule final commit for the frame.</span></span><br><span class="line">    mChoreographer.postCallback(Choreographer.CALLBACK_COMMIT, mCommit, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are still active or delayed animations, schedule a future call to</span></span><br><span class="line">    <span class="comment">// onAnimate to process the next frame of the animations.</span></span><br><span class="line">    <span class="keyword">if</span> (!mAnimations.isEmpty() || !mDelayedAnims.isEmpty()) &#123;</span><br><span class="line">        scheduleAnimation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法里可以看到之前定义过的那一系列的变量</p>
<ol>
<li>首先来看<code>mPendingAnimations</code>. 如果<code>anim.mStartDelay == 0</code>那么就直接<code>start</code>, <code>anim.startAnimation(this);</code>(这里一会回过来看)否则，就把有延迟的动画添加到<code>mDelayAnims</code>里</li>
<li>接下来处理<code>mDelayAnims</code>, 如果<code>anim.delayedAnimationFrame(frameTime)</code>也就是如果delayed的动画延迟时间到了, 那么就<code>mReadyAnims.add(anim)</code>把动画放到<code>mReadyAnims</code>里</li>
<li>然后处理<code>mReadyAnims</code>， 同样的循环<code>mReadyAnims</code>然后去<code>start</code>, <code>anim.startAnimation(this)</code>, 与第一条的<code>start</code>一样</li>
</ol>
<p>我们来看下<code>anim.startAnimation(this)</code>里究竟做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">(AnimationHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_VIEW)) &#123;</span><br><span class="line">        Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, getNameForTrace(),</span><br><span class="line">                System.identityHashCode(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    initAnimation();</span><br><span class="line">    handler.mAnimations.add(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (mStartDelay &gt; <span class="number">0</span> &amp;&amp; mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Listeners were already notified in start() if startDelay is 0; this is</span></span><br><span class="line">        <span class="comment">// just for delayed animations</span></span><br><span class="line">        notifyStartListeners();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里把<code>start</code>的动画添加到了<code>handler.mAnimations</code>里，跟进去看，也就是添加到了<code>AnimationHandler</code>里面的<code>mAnimations</code>变量里, 注意这一块! 然后<code>notifyStartListener</code>也就是之前提到过的，回调<code>onAnimationStart</code>方法。</p>
<p>跳出来， 我们回到之前的流程中</p>
<ol>
<li>处理完<code>mReadyAnims</code>中的动画后，我们知道那些<code>start</code>了的动画都跑到了<code>mAnimations</code>里，接下来把<code>mAnimations</code>里的动画复制一份放到了<code>mTmpAnimations</code>中</li>
<li>接着处理<code>mTmpAnimations</code>, <code>anim.doAnimationFrame(frameTime)</code>这里就是真正实现动画的部分，等下细说， 然后把完成了的动画放到<code>mEndingAnims</code>中</li>
<li>接下来遍历<code>mEndingAnims</code>, 执行<code>mEndingAnims.get(i).endAnimation(this)</code>，显而易见，这儿的<code>endAnimation</code>就是回调了<code>onAnimationEnd</code>方法</li>
<li>最后递归调用<code>scheduleAnimation()</code>一遍遍的走这个流程，每次传过来的<code>frameTime</code>都是当前刷新的时间，这样就完成了整个动画</li>
</ol>
<p>前文把整个动画的流程和回调时机大致介绍了下， 除了一个<code>anim.doAnimationFrame(frameTime)</code>， 这是动画执行的关键过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    ... 关键的代码是最后一行 ...</span><br><span class="line">    <span class="keyword">return</span> animationFrame(currentTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>animationFrame()</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">animationFrame</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">switch</span> (mPlayingState) &#123;</span><br><span class="line">        <span class="keyword">case</span> RUNNING:</span><br><span class="line">        <span class="keyword">case</span> SEEKED:</span><br><span class="line">            <span class="keyword">float</span> fraction = mDuration &gt; <span class="number">0</span> ? (<span class="keyword">float</span>)(currentTime - mStartTime) / mDuration : <span class="number">1f</span>;</span><br><span class="line">            <span class="keyword">if</span> (mDuration == <span class="number">0</span> &amp;&amp; mRepeatCount != INFINITE) &#123;</span><br><span class="line">                <span class="comment">// Skip to the end</span></span><br><span class="line">                mCurrentIteration = mRepeatCount;</span><br><span class="line">                <span class="keyword">if</span> (!mReversing) &#123;</span><br><span class="line">                    mPlayingBackwards = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fraction &gt;= <span class="number">1f</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCurrentIteration &lt; mRepeatCount || mRepeatCount == INFINITE) &#123;</span><br><span class="line">                    <span class="comment">// Time to repeat</span></span><br><span class="line">                    <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> numListeners = mListeners.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                            mListeners.get(i).onAnimationRepeat(<span class="keyword">this</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mRepeatMode == REVERSE) &#123;</span><br><span class="line">                        mPlayingBackwards = !mPlayingBackwards;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mCurrentIteration += (<span class="keyword">int</span>) fraction;</span><br><span class="line">                    fraction = fraction % <span class="number">1f</span>;</span><br><span class="line">                    mStartTime += mDuration;</span><br><span class="line">                    <span class="comment">// Note: We do not need to update the value of mStartTimeCommitted here</span></span><br><span class="line">                    <span class="comment">// since we just added a duration offset.</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    done = <span class="keyword">true</span>;</span><br><span class="line">                    fraction = Math.min(fraction, <span class="number">1.0f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPlayingBackwards) &#123;</span><br><span class="line">                fraction = <span class="number">1f</span> - fraction;</span><br><span class="line">            &#125;</span><br><span class="line">            animateValue(fraction);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> done;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>fraction</code>是时间因子， 从第一行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> fraction = mDuration &gt; <span class="number">0</span> ? (<span class="keyword">float</span>)(currentTime - mStartTime) / mDuration : <span class="number">1f</span>;</span><br></pre></td></tr></table></figure>

<p>可以知道, <code>fraction</code>表示动画已经开始消耗了的时间，如果是单次动画，<code>fraction</code>就是[0, 1], 如果超过了一次, fraction就可能 <code>&gt;=1</code>, 也就会执行下面的代码。 注意里面的<code>onAnimationRepeat</code>回调，每重复一次动画，会回调一次. 最后进入到<code>animateValue(fraction)</code>这个函数里， 把时间因子<code>fraction</code>传了进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">    mCurrentFraction = fraction;</span><br><span class="line">    <span class="keyword">int</span> numValues = mValues.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">        mValues[i].calculateValue(fraction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUpdateListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> numListeners = mUpdateListeners.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">            mUpdateListeners.get(i).onAnimationUpdate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行的<code>fraction</code>, 通过<code>mInterpolator.getInterpolation(fraction)</code>这个接口来进行了一次计算，把简单的线性的<code>fraction</code>转化为各种可能的数值从而达到不同的动画效果，我们知道，使用动画时， 我们就是通过<code>setInterpolator()</code>来进行不同样式的动画的， 比如<code>AccelerateDecelerateInterpolator</code>, <code>LinearInterpolator</code>等，原理就是在这里。 <code>Intepolator</code>源码如下，传入一个<code>float</code>输出一个<code>float</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A time interpolator defines the rate of change of an animation. This allows animations</span></span><br><span class="line"><span class="comment"> * to have non-linear motion, such as acceleration and deceleration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TimeInterpolator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maps a value representing the elapsed fraction of an animation to a value that represents</span></span><br><span class="line"><span class="comment">     * the interpolated fraction. This interpolated value is then multiplied by the change in</span></span><br><span class="line"><span class="comment">     * value of an animation to derive the animated value at the current elapsed animation time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input A value between 0 and 1.0 indicating our current point</span></span><br><span class="line"><span class="comment">     *        in the animation where 0 represents the start and 1.0 represents</span></span><br><span class="line"><span class="comment">     *        the end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The interpolation value. This value can be more than 1.0 for</span></span><br><span class="line"><span class="comment">     *         interpolators which overshoot their targets, or less than 0 for</span></span><br><span class="line"><span class="comment">     *         interpolators that undershoot their targets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后<code>mValues</code>里面的值会跟这个<code>fraction</code>因子进行计算<br>接下来就是<code>onAnimationUpdate</code>回调。 我们经常在这个回调里，把上一部计算后的结果拿到(<code>getAnimatedValue()</code>)</p>
<p>以上就是<code>ValueAnimator</code>大致的执行流程， 和关键的回调， 接下来， 我们分析<code>Android-23源码下</code>的<code>AnimatorSet</code>类， 也就是动画集合类。</p>
<h3 id="AnimatorSet源码分析-based-on-Android-23"><a href="#AnimatorSet源码分析-based-on-Android-23" class="headerlink" title="AnimatorSet源码分析(based on Android 23)"></a>AnimatorSet源码分析(based on Android 23)</h3><p>在<code>AnimatorSet</code>源码中我们发现, 他的一些方法如<code>playTogether</code>, <code>playSequentially</code>, <code>play</code>等方法实际上都是通过<code>Builder</code>模式来构建的这个<code>AnimatorSet</code>的。 进入<code>Builder</code>内部类，继续分析这里的<code>with</code>, <code>before</code>, <code>after</code>方法，也就是我们经常用到的构建动画顺序的方法，里面都是通过<code>Node</code>和<code>Dependency</code>这两个类组合起来的，这里设计的很巧妙，具体来看下这里的代码,  先从<code>Dependency</code>开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Dependency</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WITH = <span class="number">0</span>; <span class="comment">// dependent node must start with this dependency node</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AFTER = <span class="number">1</span>; <span class="comment">// dependent node must start when this dependency node finishes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The node that the other node with this Dependency is dependent upon</span></span><br><span class="line">    <span class="keyword">public</span> Node node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The nature of the dependency (WITH or AFTER)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> rule;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dependency</span><span class="params">(Node node, <span class="keyword">int</span> rule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.node = node;</span><br><span class="line">        <span class="keyword">this</span>.rule = rule;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>Dependency</code>里定义了2中依赖关系, <code>WITH</code>和<code>AFTER</code>,可能有人好奇<code>Builder</code>里的<code>before</code>怎么没了。 原因是, <code>before</code>和<code>after</code>其实是一种逆向的过程, <code>A before B</code> 也就是<code>B after A</code>. 所以这里源码作者忽略了<code>before</code>，简化了代码，但是增加了逻辑复杂度，让第一次阅读的人一头雾水<br><code>Dependency</code>里除了定义了依赖关系，还声明了另一个关键的变量<code>Node</code>, <code>Node</code>的英文注释这儿是<code>// The node that the other note with this Dependency is dependent upon</code>. 这里很巧妙，意思是其他的<code>Node</code>与这个<code>Node</code>的依赖关系是这个<code>Dependency</code><br>接下来来看下比较复杂的<code>Node</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Animator animation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  These are the dependencies that this node's animation has on other</span></span><br><span class="line"><span class="comment">     *  nodes. For example, if this node's animation should begin with some</span></span><br><span class="line"><span class="comment">     *  other animation ends, then there will be an item in this node's</span></span><br><span class="line"><span class="comment">     *  dependencies list for that other animation's node.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Dependency&gt; dependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tmpDependencies is a runtime detail. We use the dependencies list for sorting.</span></span><br><span class="line"><span class="comment">     * But we also use the list to keep track of when multiple dependencies are satisfied,</span></span><br><span class="line"><span class="comment">     * but removing each dependency as it is satisfied. We do not want to remove</span></span><br><span class="line"><span class="comment">     * the dependency itself from the list, because we need to retain that information</span></span><br><span class="line"><span class="comment">     * if the AnimatorSet is launched in the future. So we create a copy of the dependency</span></span><br><span class="line"><span class="comment">     * list when the AnimatorSet starts and use this tmpDependencies list to track the</span></span><br><span class="line"><span class="comment">     * list of satisfied dependencies.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Dependency&gt; tmpDependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * nodeDependencies is just a list of the nodes that this Node is dependent upon.</span></span><br><span class="line"><span class="comment">     * This information is used in sortNodes(), to determine when a node is a root.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Node&gt; nodeDependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * nodeDepdendents is the list of nodes that have this node as a dependency. This</span></span><br><span class="line"><span class="comment">     * is a utility field used in sortNodes to facilitate removing this node as a</span></span><br><span class="line"><span class="comment">     * dependency when it is a root node.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Node&gt; nodeDependents = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>这里声明了<code>ArrayList&lt;Dependency&gt; dependencies</code>, <code>ArrayList&lt;Dependency&gt; tmpDependencies</code>, <code>ArrayList&lt;Node&gt; nodeDependencies</code>, <code>ArrayList&lt;Node&gt; nodeDependents</code>, 这里的定义只<code>dependents</code>和<code>dependencies</code>就比较容易搞混了, 我们结合例子来看</p>
<p>先举一个普通的<code>AnimatorSet</code>的用法，也就是最开始的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AnimatorSet set = <span class="keyword">new</span> AnimatorSet()</span><br><span class="line">set.play(mFirstValueAnimator).with(mSecondValueAnimator);</span><br></pre></td></tr></table></figure>

<p>进入<code>play</code>方法，我们可以看到直接返回的是一个<code>new Builder(anim1)</code>接着进入<code>Builder</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Builder(Animator anim) &#123;</span><br><span class="line">            mCurrentNode = mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (mCurrentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mCurrentNode = <span class="keyword">new</span> Node(anim);</span><br><span class="line">                mNodeMap.put(anim, mCurrentNode);</span><br><span class="line">                mNodes.add(mCurrentNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里把<code>anim1</code>赋值给<code>mCurrentNode</code>, 可以这么理解，一个<code>Node</code>对应一个<code>anim</code>, 接着是<code>with(anim2)</code>, 也就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">with</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">        Node node = mNodeMap.get(anim);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">            node = <span class="keyword">new</span> Node(anim);</span><br><span class="line">            mNodeMap.put(anim, node);</span><br><span class="line">            mNodes.add(node);</span><br><span class="line">        &#125;</span><br><span class="line">        Dependency dependency = <span class="keyword">new</span> Dependency(mCurrentNode, Dependency.WITH);</span><br><span class="line">        node.addDependency(dependency);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>新建一个<code>Dependency</code>把<code>mCurrentNode</code>也就是<code>anim1</code>和依赖关系<code>Dependency</code>也就是<code>WITH</code>作为<code>Dependency</code>的构造函数传进来, 然后<code>node</code>也就是<code>anim2</code>添加这个<code>Dependency(anim1, with)</code><br>接着进入<code>addDependency</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDependency</span><span class="params">(Dependency dependency)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dependencies == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dependencies = <span class="keyword">new</span> ArrayList&lt;Dependency&gt;();</span><br><span class="line">            nodeDependencies = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        dependencies.add(dependency);</span><br><span class="line">        <span class="keyword">if</span> (!nodeDependencies.contains(dependency.node)) &#123;</span><br><span class="line">            nodeDependencies.add(dependency.node);</span><br><span class="line">        &#125;</span><br><span class="line">        Node dependencyNode = dependency.node;</span><br><span class="line">        <span class="keyword">if</span> (dependencyNode.nodeDependents == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dependencyNode.nodeDependents = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        dependencyNode.nodeDependents.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>估计看到这块代码一头雾水，先介绍下这里的变量分别是做什么的</p>
<ul>
<li>List<dependency> dependencies 记录当前节点的所有依赖关系</dependency></li>
<li>List<node> nodeDependencies 记录当前节点的依赖节点</node></li>
<li>List<node> nodeDependents 记录依赖当前节点的节点</node></li>
</ul>
<p>以上<code>addDependency</code>函数内做的就是这事，把这三个变量给赋值。 再举个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">anim1.before(anim2)</span><br><span class="line">顺序是anim1, anim2</span><br><span class="line">映射到代码中就是</span><br><span class="line">node(anim2), dependency(anim1, after)</span><br><span class="line">中文描述: 动画<span class="number">2</span>在动画<span class="number">1</span>之后</span><br><span class="line"></span><br><span class="line">anim3.after(anim4)</span><br><span class="line">顺序是anim4, anim3</span><br><span class="line">映射到代码中就是</span><br><span class="line">node(currentNode也就是anim3), dependency(anim4, after)</span><br><span class="line">中文描述: 动画<span class="number">3</span>在动画<span class="number">4</span>之后</span><br><span class="line"></span><br><span class="line">我们再来串起来看下。</span><br><span class="line"></span><br><span class="line">`e.g`</span><br><span class="line"></span><br><span class="line">play(anim1).before(anim2).before(anim3)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. anim1</span><br><span class="line"><span class="number">2</span>. anim2的NodeDependencies 是 anim1</span><br><span class="line"><span class="number">3</span>. anim1的NodeDependents 是 anim2</span><br><span class="line"><span class="number">4</span>. anim3的NodeDependencies 是 anim2</span><br><span class="line"><span class="number">5</span>. anim2的NodeDependencts 是 anim3</span><br><span class="line"></span><br><span class="line">最终结果就是</span><br><span class="line"></span><br><span class="line">anim1的nodeDependencies是<span class="keyword">null</span>, nodeDependents是anim2</span><br><span class="line">anim2的nodeDependencies是anim1, nodeDependents是anim3</span><br><span class="line">anim3的nodeDependencies是anim2, nodeDependents是<span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p><code>AnimatorSet</code>就是通过这样的依赖关系把添加进来的动画组织起来，接下来，我们看下他们是如何<code>start</code>的，进入<code>AnimatorSet</code>的<code>start</code>方法里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mTerminated = <span class="keyword">false</span>;</span><br><span class="line">            mStarted = <span class="keyword">true</span>;</span><br><span class="line">            mPaused = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                node.animation.setAllowRunningAsynchronously(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (mDuration &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// If the duration was set on this AnimatorSet, pass it along to all child animations</span></span><br><span class="line">                <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> don't set the duration of the timing-only nodes created by AnimatorSet to</span></span><br><span class="line">                    <span class="comment">// insert "play-after" delays</span></span><br><span class="line">                    node.animation.setDuration(mDuration);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mInterpolator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                    node.animation.setInterpolator(mInterpolator);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// First, sort the nodes (if necessary). This will ensure that sortedNodes</span></span><br><span class="line">            <span class="comment">// contains the animation nodes in the correct order.</span></span><br><span class="line">            sortNodes();</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">int</span> numSortedNodes = mSortedNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">                Node node = mSortedNodes.get(i);</span><br><span class="line">                <span class="comment">// First, clear out the old listeners</span></span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; oldListeners = node.animation.getListeners();</span><br><span class="line">                <span class="keyword">if</span> (oldListeners != <span class="keyword">null</span> &amp;&amp; oldListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ArrayList&lt;AnimatorListener&gt; clonedListeners = <span class="keyword">new</span></span><br><span class="line">                            ArrayList&lt;AnimatorListener&gt;(oldListeners);</span><br><span class="line">    </span><br><span class="line">                    <span class="keyword">for</span> (AnimatorListener listener : clonedListeners) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> DependencyListener ||</span><br><span class="line">                                listener <span class="keyword">instanceof</span> AnimatorSetListener) &#123;</span><br><span class="line">                            node.animation.removeListener(listener);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// nodesToStart holds the list of nodes to be started immediately. We don't want to</span></span><br><span class="line">            <span class="comment">// start the animations in the loop directly because we first need to set up</span></span><br><span class="line">            <span class="comment">// dependencies on all of the nodes. For example, we don't want to start an animation</span></span><br><span class="line">            <span class="comment">// when some other animation also wants to start when the first animation begins.</span></span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;Node&gt; nodesToStart = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">                Node node = mSortedNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (mSetListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSetListener = <span class="keyword">new</span> AnimatorSetListener(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies == <span class="keyword">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    nodesToStart.add(node);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> numDependencies = node.dependencies.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                        Dependency dependency = node.dependencies.get(j);</span><br><span class="line">                        dependency.node.animation.addListener(</span><br><span class="line">                                <span class="keyword">new</span> DependencyListener(<span class="keyword">this</span>, node, dependency.rule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    node.tmpDependencies = (ArrayList&lt;Dependency&gt;) node.dependencies.clone();</span><br><span class="line">                &#125;</span><br><span class="line">                node.animation.addListener(mSetListener);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Now that all dependencies are set up, start the animations that should be started.</span></span><br><span class="line">            <span class="keyword">if</span> (mStartDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node node : nodesToStart) &#123;</span><br><span class="line">                    node.animation.start();</span><br><span class="line">                    mPlayingSet.add(node.animation);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDelayAnim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                mDelayAnim.setDuration(mStartDelay);</span><br><span class="line">                mDelayAnim.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> canceled = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">                        canceled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!canceled) &#123;</span><br><span class="line">                            <span class="keyword">int</span> numNodes = nodesToStart.size();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                                Node node = nodesToStart.get(i);</span><br><span class="line">                                node.animation.start();</span><br><span class="line">                                mPlayingSet.add(node.animation);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mDelayAnim = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                mDelayAnim.start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                        (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    tmpListeners.get(i).onAnimationStart(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mNodes.size() == <span class="number">0</span> &amp;&amp; mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Handle unusual case where empty AnimatorSet is started - should send out</span></span><br><span class="line">                <span class="comment">// end event immediately since the event will not be sent out at all otherwise</span></span><br><span class="line">                mStarted = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                            (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                        tmpListeners.get(i).onAnimationEnd(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>首先我们可以看到如果<code>AnimatorSet</code>设置了<code>duration</code>, 那么里面所有的<code>animation</code>都会强制地设置为<code>AnimatorSet</code>的<code>duration</code>, <code>Interpolator</code>也一样。<br>接着来看51行。这块代码意思是, 如果<code>当前Node</code>没有<code>dependencies</code>，也就是没有依赖，那么当前节点就是<code>rootNode</code>。如果<code>当前Node</code>有<code>dependencies</code>， 那么<code>当前Node</code>的<code>dependencies里面的Node, 也就是当前的Node</code>, 添加DependencyListener回调。具体来看DependencyLister这个类</p>
<ul>
<li>如果<code>mRule == Dependency.AFTER</code>, 也就是如果依赖规则是<code>after</code>, 那么在<code>onAnimationEnd</code>方法里，去<code>start</code>下一个动画的。</li>
<li>如果<code>mRule == Dependency.WITH</code>, 也就是依赖规则是<code>With</code>, 那么就在<code>onAnimationStart</code>里去<code>start</code>下一个动画</li>
</ul>
<p>总结来说就是，一系列的节点首先是通过<code>Dependency</code>这个依赖关系关联起来，在<code>start</code>的方法里，给所有有依赖的节点添加<code>DependencyListener</code>这个回调方法。如果规则是<code>with</code>, 那么第二个节点在第一个节点的<code>onAnimationStart</code>回调里去<code>start</code>, 如果第二个节点与第一个节点的关系是<code>after</code>, 那么第二个节点在第一个节点的<code>onAnimationEnd</code>回调里去<code>start</code>。</p>
<p>// TODO 类似双向链表实现的树结构??</p>
<p>AnimatorSet 在Android23源码中就是像这样把所有的动画组合起来。可以说非常巧妙，非常的精妙。但是令我们思考的是，这是最好的方法么？这种结构是不是很熟悉？或者说有什么结构可以替代这种很巧妙但是很复杂的结构?</p>
<p>AnimatorSet在Android-24源码中就是用了更加巧妙的方法来实现这块功能。下面我们来分析下AnimatorSet在24里面的源码实现。</p>
<h3 id="AnimatorSet源码分析-based-on-Android-24"><a href="#AnimatorSet源码分析-based-on-Android-24" class="headerlink" title="AnimatorSet源码分析(based on Android 24)"></a>AnimatorSet源码分析(based on Android 24)</h3><p>与23中一样，都是通过<code>Builder</code>模式来构建这个<code>AnimatorSet</code>的，所以我们直接进入到<code>Builder</code>内部类里面。可以看到与23中明显不同的是，这里的<code>with</code>, <code>after</code>, <code>before</code>里面的实现，没有复杂的<code>Dependency</code>这个东西了，取而代之的是<code>Node</code>的<code>addChild</code>, <code>addSibling</code>, <code>addParent</code>。是的，新的结构就是树，<code>with</code>就是添加兄弟节点，<code>before</code>就是添加子节点, <code>after</code>就是添加父节点。非常的清晰。<br>同时Node类里面也是定义了以下3个变量来存储添加进来的动画。<br><code>List&lt;Node&gt; mSiblings, List&lt;Node&gt; mParents, List&lt;Node&gt; mChildNodes</code><br>接着来看<code>start方法</code>,关键部分是这里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mStartDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        start(mRootNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mNodes.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// No delay, but there are other animators in the set</span></span><br><span class="line">        onChildAnimatorEnded(mDelayAnim);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Set is empty, no delay, no other animation. Skip to end in this case</span></span><br><span class="line">        setIsEmpty = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里把开始的延迟时间作为一个<code>delayAnim</code>，如果有开始延迟的话就先执行这个<code>delayAnim</code>也就是<code>mRootNode</code>。这点可以从<code>mRootNode</code>的定义看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node mRootNode = <span class="keyword">new</span> Node(mDelayAnim);</span><br></pre></td></tr></table></figure>

<p>接着进入<code>onChildAnimatorEnded(mDelayAnim)</code>方法里看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onChildAnimatorEnded</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Node animNode = mNodeMap.get(animation);</span><br><span class="line">        animNode.mEnded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mTerminated) &#123;</span><br><span class="line">            List&lt;Node&gt; children = animNode.mChildNodes;</span><br><span class="line">            <span class="comment">// Start children animations, if any.</span></span><br><span class="line">            <span class="keyword">int</span> childrenSize = children == <span class="keyword">null</span> ? <span class="number">0</span> : children.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (children.get(i).mLatestParent == animNode) &#123;</span><br><span class="line">                    start(children.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Listeners are already notified of the AnimatorSet ending in cancel() or</span></span><br><span class="line">            <span class="comment">// end(); the logic below only kicks in when animations end normally</span></span><br><span class="line">            <span class="keyword">boolean</span> allDone = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// Traverse the tree and find if there's any unfinished node</span></span><br><span class="line">            <span class="keyword">int</span> size = mNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mNodes.get(i).mEnded) &#123;</span><br><span class="line">                    allDone = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (allDone) &#123;</span><br><span class="line">                <span class="comment">// If this was the last child animation to end, then notify listeners that this</span></span><br><span class="line">                <span class="comment">// AnimatorSet has ended</span></span><br><span class="line">                <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                            (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                        tmpListeners.get(i).onAnimationEnd(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mStarted = <span class="keyword">false</span>;</span><br><span class="line">                mPaused = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为传过来的是<code>mRootNode</code>，这里第一次循环的就是<code>mRootNode的mChildNodes</code>。也就是第一级的所有动画动过<code>for</code>循环去<code>start</code>。进入到<code>start</code>方法里看，这里就是动画的<code>start</code>和回调方法<code>AnimatorSetListener</code>。在这个回调方法里可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        animation.removeListener(<span class="keyword">this</span>);</span><br><span class="line">        mAnimatorSet.mPlayingSet.remove(animation);</span><br><span class="line">        mAnimatorSet.onChildAnimatorEnded(animation);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了<code>onChildAnimationEnded</code>方法，也就是上文中的相同的方法，到这里的时候只是由原来传过来的<code>mRootNode</code>变为<code>mRootNode的childNode</code>了。 经过多次递归，同一层级的通过<code>for</code>循环来<code>start</code>, 子层级的在上一级的<code>onAnimEnd</code>回调里去递归的调用。就这样，<code>AnimatorSet</code>把所有动画组织起来。</p>
<h2 id="回归问题-导致不同表现的原因"><a href="#回归问题-导致不同表现的原因" class="headerlink" title="回归问题, 导致不同表现的原因"></a>回归问题, 导致不同表现的原因</h2><p>先总结一下。</p>
<ul>
<li><code>AnimatorSet</code>在<code>Android23</code>中是通过类似双向链表实现的树结构把所有的动画以及他们的关系给组织起来。在播放的时候, 如果后一个动画如果与前一个动画是同时播放，那么后一个动画就是在前一个动画<code>onAnimationStart</code>回调里去<code>start</code>, 如果后一个动画与前一个动画是后先顺序，那么后一个动画就在前一个动画的<code>onAnimationEnd</code>回调里去<code>start</code>。</li>
<li><code>AnimatorSet</code>在<code>Android24</code>中是通过树的结构把所有的动画组织起来。在播放的时候从跟节点一层一层的往树叶方向播放。</li>
<li>相比来说，虽然23中的做法很巧妙，但是树形结构更加合理。</li>
</ul>
<p>回归到问题, 在<code>23</code>中为什么<code>anim1</code>在播放完之后没有进行<code>anim2</code>的动画?</p>
<p>从之前的原理分析我们知道, <code>play(anim1).with(anim2)</code>也就是<code>anim1</code>与<code>anim2</code>的<code>Dependency</code>关系是<code>WITH</code>, 在<code>AnimatorSet</code>里播放时也就是, <code>anim2</code>在<code>anim1</code>的<code>onAnimationStart</code>回调里去<code>start</code>。</p>
<p>从日志上可以看到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01-17 15:22:27.395 I/MainActivity(13521): &lt;MainActivity:onCreate:54&gt; first anim anim start....</span><br><span class="line">01-17 15:22:27.396 I/MainActivity(13521): &lt;MainActivity$1:onAnimationUpdate:28&gt; first anim onAnimationUpdate...</span><br><span class="line">01-17 15:22:27.396 I/MainActivity(13521): &lt;MainActivity$5:onAnimationStart:92&gt; animatorSet start...</span><br><span class="line">01-17 15:22:27.397 I/MainActivity(13521): &lt;MainActivity:onCreate:112&gt; animator set start...</span><br></pre></td></tr></table></figure>

<p><code>AnimatorSet</code>start之前<code>anim1</code>的<code>onAnimationStart</code>早已经调用过了，后面再没有看到<code>anim1</code>的<code>onAnimationStart</code>的回调记录了 ，所以<code>anim2</code>就没法去<code>start</code>。而在<code>24</code>中，因为是<code>for循环执行的</code>，所以<code>anim2</code>可以正确的<code>start</code>。</p>
<p>至于为什么这块代码里<code>anim1</code>的<code>start</code>会在<code>AnimatorSet</code>的<code>start</code>之前就回调，是因为我们在使用的过程中，不小心把已经<code>start</code>过了的<code>anim1</code>添加到了<code>AnimatorSet</code>中，所以造成了这么比较奇怪的问题。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.jpg" alt="ScorpioNeal WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="ScorpioNeal Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/AndroidView/" rel="tag"># AndroidView</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/21792e63/" rel="next" title="Java-《Java编程的逻辑》读书笔记">
                <i class="fa fa-chevron-left"></i> Java-《Java编程的逻辑》读书笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/c8a24b3d/" rel="prev" title="Java-《Java编程的逻辑》- 并发">
                Java-《Java编程的逻辑》- 并发 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ScorpioNeal</p>
              <p class="site-description motion-element" itemprop="description">体系(点 - 线 - 面)</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">229</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一段代码在不同设备上的不同表现"><span class="nav-number">1.</span> <span class="nav-text">一段代码在不同设备上的不同表现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#代码"><span class="nav-number">1.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在Android-23-上输出"><span class="nav-number">1.2.</span> <span class="nav-text">在Android 23 上输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在Android-24上输出"><span class="nav-number">1.3.</span> <span class="nav-text">在Android 24上输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#现象描述"><span class="nav-number">1.4.</span> <span class="nav-text">现象描述</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动画源码分析"><span class="nav-number">2.</span> <span class="nav-text">动画源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ValueAnimator源码分析"><span class="nav-number">2.1.</span> <span class="nav-text">ValueAnimator源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AnimatorSet源码分析-based-on-Android-23"><span class="nav-number">2.2.</span> <span class="nav-text">AnimatorSet源码分析(based on Android 23)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AnimatorSet源码分析-based-on-Android-24"><span class="nav-number">2.3.</span> <span class="nav-text">AnimatorSet源码分析(based on Android 24)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#回归问题-导致不同表现的原因"><span class="nav-number">3.</span> <span class="nav-text">回归问题, 导致不同表现的原因</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ScorpioNeal</span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Bp6gNEmnfgAF2Ci7moO9v4Rm-gzGzoHsz',
        appKey: 'xNstrbz0DRkVzIMvuDNrkAOh',
        placeholder: '要不要说点啥',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/js/src/dynamic_bg.js"></script>
  <script type="text/javascript" src="/js/src/love-click.js"></script>
</body>
</html>
