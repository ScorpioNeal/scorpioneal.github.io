<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="体系(点 - 线 - 面)">
<meta property="og:type" content="website">
<meta property="og:title" content="ScorpioNeal&#39;s Blog">
<meta property="og:url" content="http://blog.scions.cn/page/20/index.html">
<meta property="og:site_name" content="ScorpioNeal&#39;s Blog">
<meta property="og:description" content="体系(点 - 线 - 面)">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ScorpioNeal&#39;s Blog">
<meta name="twitter:description" content="体系(点 - 线 - 面)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.scions.cn/page/20/">





  <title>ScorpioNeal's Blog</title>
  








  <link rel="stylesheet" href="/live2d/css/live2d.css">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
<div class="bg_content">
<canvas id="canvas"></canvas>
</div>
  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ScorpioNeal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            todo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/a6157931/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/a6157931/" itemprop="url">Android 常见内存泄漏</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T23:43:24+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/a6157931/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/a6157931/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.toptal.com/java/hunting-memory-leaks-in-java" target="_blank" rel="noopener">https://www.toptal.com/java/hunting-memory-leaks-in-java</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/b5608f0f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/b5608f0f/" itemprop="url">Android App启动过程和Activity启动过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T23:39:34+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/b5608f0f/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/b5608f0f/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://blog.csdn.net/qian520ao/article/details/78156214" target="_blank" rel="noopener">https://blog.csdn.net/qian520ao/article/details/78156214</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/d2b4a3fc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/d2b4a3fc/" itemprop="url">Android-RecyclerView与ListView的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T23:38:45+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/d2b4a3fc/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/d2b4a3fc/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://blog.csdn.net/guolin_blog/article/details/44996879" target="_blank" rel="noopener">https://blog.csdn.net/guolin_blog/article/details/44996879</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/72e1c46d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/72e1c46d/" itemprop="url">Android StartService和bindService的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T23:36:07+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/72e1c46d/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/72e1c46d/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SampleService"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Debug.i(TAG, <span class="string">"onCreate..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"onBind..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"onStartCommand"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Debug.i(TAG, <span class="string">"onDestroy..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startService</code></p>
<p>第一次会走<code>onCreate</code>, <code>onStartCommand</code> (<code>onStart</code>已经<code>deprecated</code>了, 取而代之的是<code>onStartComand</code>), 之后每次在<code>start</code> 都只会走<code>onStartCommand</code>. 退出Activity, Service的<code>onDestroy</code>不会走到, 会一直在后台运行</p>
<p><code>bindService</code><br>第一次会走<code>onCreate</code>, <code>onBind</code>, 之后每次<code>bind</code>都只触发<code>onBind</code>和<code>onCreate</code>， Activity推出后, 会执行<code>onDestroy</code></p>
<p><code>start()</code>方式，很难在Activity中对<code>Service</code>进行控制， 因此，会有<code>bindService</code>方式, 在Service里创建一个类继承Binder, 然后会回调会bindService的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> Service.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LocalBinder binder = <span class="keyword">new</span> LocalBinder();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         Debug.i(TAG, <span class="string">"test..."</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">     Debug.i(TAG, <span class="string">"onBind..."</span>);</span><br><span class="line">     <span class="keyword">return</span> binder;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> Activity.java</span><br><span class="line"> </span><br><span class="line"> bindService(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, SampleService.class), <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">                     Debug.i(TAG, <span class="string">"onServiceConnected "</span>);</span><br><span class="line">                     SampleService.LocalBinder binder = (SampleService.LocalBinder)service;</span><br><span class="line">                     binder.test();</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">                     Debug.i(TAG, <span class="string">"onServiceDisconnected "</span>);</span><br><span class="line"></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;, Context.BIND_AUTO_CREATE);</span><br></pre></td></tr></table></figure>

<h1 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h1><p>Android Interface Definition Language. 可以让某个Service与多个应用程序组件之间进行跨进程通讯, 从而实现多个应用程序共享一个Service的功能. 也是通过bindService来实现，流程与上述差不多。 具体细节有待分析.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/f7f3c028/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/f7f3c028/" itemprop="url">Java HashMap & HashTable, HashMap & ConcurrentHashMap'</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T23:22:18+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/f7f3c028/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/f7f3c028/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><h3 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h3><p>惯例，先从构造函数开始看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(initialCapacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> + initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(initialCapacity &gt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                loadFactor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回大于输入参数且最近的2的整数次幂的数。比如10，则返回16</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要注意几个参数</p>
<ul>
<li>loadFactor </li>
<li>threshold // next size value at which to resize (capacity * load factor) 就是size超过多少时数组需要resize </li>
<li>capacity</li>
</ul>
<h3 id="put"><a href="#put" class="headerlink" title="put"></a>put</h3><p>接下来看下重要的put方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>)  ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里核心就是<code>putVal</code>函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent, <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K, V&gt;[] tab;</span><br><span class="line">    Node&lt;K, V&gt; p;</span><br><span class="line">    <span class="keyword">int</span> n; <span class="comment">// 记录数组的length</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">//记录存放node所在数组的index</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>) &#123; <span class="comment">// hash通过与数组size做&amp;运算，找到对应到index</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>); <span class="comment">//当前数组i无节点</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K, V&gt; e;</span><br><span class="line">        K k;</span><br><span class="line">        <span class="comment">// p 指向数组中index位置，第一个节点</span></span><br><span class="line">        <span class="keyword">if</span>(p.hash == hash &amp;&amp; ((k = p.key) == key) || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))) &#123;</span><br><span class="line">            e = p; <span class="comment">//直接替换</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(p <span class="keyword">instanceof</span> TreeNode) &#123;</span><br><span class="line">            e = ((TreeNode&lt;K, V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span>((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 查询到最后都没找到，就在链表的最后newNode一个</span></span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//长度超过TREEIFY_THRESHOLD后就重新treeifyBin， 把链表改为红黑树</span></span><br><span class="line">                    <span class="keyword">if</span>(binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) &#123;</span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    <span class="comment">//因为前面e = p.next, 所以这里的e就是在链表里找到了一个相同的</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//p指向下一个</span></span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span>(!onlyIfAbsent || oldValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                e.value = value;</span><br><span class="line">            &#125;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span>(++size &gt; threshold) &#123;</span><br><span class="line">        <span class="comment">//长度超过阈值，resize</span></span><br><span class="line">        resize();</span><br><span class="line">    &#125;</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是把Node放入hashmap里的过程，hashmap就是数组和链表的结合。有着2种数据结构的优势，首先选取数组位置的时候通过(hash &amp; capacity - 1)获取index, 然后在遍历单找到是直接替换还是放在最后, 如果链表长度超过<code>TREEIFY_THRESHOLD</code>就会转化为红黑树,  <code>treeifyBin</code>和<code>TreeNode</code>相关，后续再议。</p>
<h3 id="resize"><a href="#resize" class="headerlink" title="resize"></a>resize</h3><p>然后我们看下比较重要的<code>resize</code>过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Node&lt;K, V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K, V&gt;[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> newThr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY) &#123; <span class="comment">//新的capacity也变为2倍</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">//变为2倍</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldThr &gt; <span class="number">0</span>) &#123; <span class="comment">// initial capacity was placed in threshold ??</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ? (<span class="keyword">int</span>)ft : Integer.MAX_VALUE); <span class="comment">//newThr = ft</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    threshold = newThr;</span><br><span class="line">    Node&lt;K, V&gt;[] newTab = (Node&lt;K, V&gt;[]) <span class="keyword">new</span> Node[newCap]; <span class="comment">//新建一个newCap容量的array</span></span><br><span class="line">    table = newTab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K, V&gt; e;</span><br><span class="line">            <span class="keyword">if</span>((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(e.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e; <span class="comment">//重新计算hash并放置对应index位置</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span>  TreeNode) &#123;</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 比如oldCap=8,hash是3，11，19，27时，(e.hash &amp; oldCap)的结果是0，8，0，8，这样3，19组成新的链表，index为3；而11，27组成新的链表，新分配的index为3+8；</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     * JDK1.7中重写hash是(e.hash &amp; newCap-1)，也就是3，11，19，27对16取余，也是3，11，3，11，和上面的结果一样，但是index为3的链表是19，3，index为3+8的链表是</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     * 27，11，也就是说1.7中经过resize后数据的顺序变成了倒叙，而1.8没有改变顺序。</span></span><br><span class="line"><span class="comment">                     * ---------------------</span></span><br><span class="line"><span class="comment">                     * 作者：bnmb888</span></span><br><span class="line"><span class="comment">                     * 来源：CSDN</span></span><br><span class="line"><span class="comment">                     * 原文：https://blog.csdn.net/bnmb888/article/details/77164485</span></span><br><span class="line"><span class="comment">                     * 版权声明：本文为博主原创文章，转载请附上博文链接！</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    Node&lt;K, V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K, V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K, V&gt; next;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span>((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(loTail == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span>(hiTail == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>最后，经常用的还有<code>get</code>方法，理解了上述之后，这儿就很简单了， 遍历链表或者树，找到后就返回即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/xorxos/article/details/49781677" target="_blank" rel="noopener">https://blog.csdn.net/xorxos/article/details/49781677</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/d7e77019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/d7e77019/" itemprop="url">Android-对象池的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-01T13:07:52+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/d7e77019/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/d7e77019/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Android中为了避免多次重复的创建对象，可以通过使用对象池技术来减少对象的创建，从而达到减少占用内存的效果。</p>
<p>Android源码里也有很多地方用到:</p>
<p>比如Handler的Message里，使用obtain()而不是每次new. </p>
<p>AsyncLayoutInflator中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Pools.SynchronizedPool&lt;InflateRequest&gt; mRequestPool = <span class="keyword">new</span> Pools.SynchronizedPool&lt;InflateRequest&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> InflateRequest <span class="title">obtainRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InflateRequest obj = mRequestPool.acquire();</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        obj = <span class="keyword">new</span> InflateRequest();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseRequest</span><span class="params">(InflateRequest obj)</span> </span>&#123;</span><br><span class="line">    obj.callback = <span class="keyword">null</span>;</span><br><span class="line">    obj.inflater = <span class="keyword">null</span>;</span><br><span class="line">    obj.parent = <span class="keyword">null</span>;</span><br><span class="line">    obj.resid = <span class="number">0</span>;</span><br><span class="line">    obj.view = <span class="keyword">null</span>;</span><br><span class="line">    mRequestPool.release(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，这里我们详细的分析下Android系统提供的支持对象池的工具<code>SynchronizedPool</code>的代码:</p>
<p>整体代码很简单。里面定义了一个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pool</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">acquire</span><span class="params">()</span></span>; <span class="comment">//获取</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">release</span><span class="params">(T instance)</span></span>; <span class="comment">//释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，构造函数为private, 因此只能通过内部两个类来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Pools</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePool</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Pool</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedPool</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">SimplePool</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>其中SncrhonizedPool是继承自SimplePool, 我们先分析SimplePool:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePool</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Pool</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//存放object的位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] mPool;</span><br><span class="line">    <span class="comment">//记录当前释放或者获取的是哪个对象对应的index</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimplePool</span><span class="params">(<span class="keyword">int</span> maxPoolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(maxPoolSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The max pool size must be &gt; 0"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mPool = <span class="keyword">new</span> Object[maxPoolSize];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mPoolSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> lastPooledIndex = mPoolSize - <span class="number">1</span>;</span><br><span class="line">            T instance = (T)mPool[lastPooledIndex];</span><br><span class="line">            mPool[lastPooledIndex] = <span class="keyword">null</span>;</span><br><span class="line">            mPoolSize--;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isInPool(instance)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already in the pool!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mPoolSize &lt; mPool.length) &#123;</span><br><span class="line">            mPool[mPoolSize] = instance;</span><br><span class="line">            mPoolSize++;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInPool</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPoolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPool[i] == instance) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里定义了一个数组，用来存放最大放在池子里的对象的个数. 代码也很简单，实现了Pool接口，实现acquire和release方法。 相比着看SynchronizePool:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedPool</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">SimplePool</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SynchronizedPool</span><span class="params">(<span class="keyword">int</span> maxPoolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(maxPoolSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.acquire();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(T element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.release(element);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是多了个synchronized同步代码.</p>
<p>总结下，对象池对于多次的创建和销毁大对象的情景来说用处还是很大的，但是对于小对象，可能维护对象池的成本都大于创建对象的成本了。因此要看实际的情况而抉择。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/a692d70a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/a692d70a/" itemprop="url">Translatioin-Shrink, obfuscate, and optimize your app</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-30T13:41:43+08:00">
                2019-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/a692d70a/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/a692d70a/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Shrink-Obfuscate-and-optimize-your-app"><a href="#Shrink-Obfuscate-and-optimize-your-app" class="headerlink" title="Shrink, Obfuscate, and optimize your app"></a>Shrink, Obfuscate, and optimize your app</h1><p>To make your app as small as possible, you should enable shrinking in your release build to remove unused code and resources. When enabling shrinking, you also benefit from obfuscation, which shortens the names of your app’s classes and members, and optimization, which applies more aggressive strategies for further reduce the size of your app. This page describes how R8 performs these compile-time tasks for your project and how you can customize them. (为了让减小你的app体积，你可以开启shrinking， 把app里没用到的代码和资源删除. 开启shrinking的同时，你也会从obfucsation中受益，因为obfuscation会把你的类和方法名缩短. 而且，optmizitaion里也有很多好策略可以进一步的减少app大小. 本文讲介绍R8是如何在编译时优化你的app的.)</p>
<p>When you build your project using <a href>Android Gradle plugin 3.4.0</a> or higher, the plugin no longer uses ProGuard to peform compile-time code optimization. Instead, the plugin works with the R8 compiler to handle the following compile-time tasks:  </p>
<p>(在Android Gradle Plugin 3.4.0以上， 使用R8编译器替代ProGuard来执行以下的优化: )</p>
<ul>
<li>Code shrinking(or tree-shrinking)<br>  detects and safely remove unused classes, fields, methods, and attributes from your app and its library dependencies(making it a valuable tool for working around the <a href="https://developer.android.com/studio/build/multidex.html" target="_blank" rel="noopener">64K reference limit</a>). For example, if you use only a few APIs of a library dependency, shrinking can identify library code that your app is not using and remove only that code from your app. To learn more ,go to teh section about how to <a href="https://developer.android.com/studio/build/shrink-code#shrink-code" target="_blank" rel="noopener">shrink yoru code</a>.  (检测代码里无用的类，方法，字段，属性等，以及依赖的库里的代码。 会把这些无用的全给删掉，这是个很有效的工具，应对64K的问题)</li>
<li>Resources shrinking:<br>  remove unused resources from your package app, including unused resources in your app’s library dependencies. It works in conjunction with code shrinking such that once unused code has been removed, any resources no longer referenced can be safely removed as well. To learn more, go to the section about how to <a href="https://developer.android.com/studio/build/shrink-code#shrink-resources" target="_blank" rel="noopener">shrink your resources</a>. (检测无用的资源，包含依赖中的。 这个与code shrinking配合使用，如果无用的代码删除了，那么这些代码里引用的资源如果没有其他引用的化，也会一起删除.)</li>
<li>Obfuscation:<br>  shortens the name of classes and members, which results in reduced DEX file size. To learn more , go to the section about how to <a href="https://developer.android.com/studio/build/shrink-code#obfuscate" target="_blank" rel="noopener">obfuscate your code</a>.  (通过缩短类和字段名来来减少dex大小)</li>
<li>Optimization:<br>  inspects and rewrites your code to further reduce the size of your app’s DEX files. For example, if R8 detects that <code>else{}</code> branch for a given if/else statement is never taken, R8 removes the code for the <code>else {}</code> branch. To learn more, go to the section about <a href="https://developer.android.com/studio/build/shrink-code#optimization" target="_blank" rel="noopener">code optimization</a>.  (Optimization, 会对你的代码进行深层次检查，比如如果R8检查到else块里永远不会执行，那么他会直接把这个分支删除.)</li>
</ul>
<p>When building the release version of your app, by default, R8 automatically performs the compile-time tasks described above for you. However, you can disable certain tasks or customize R8’s behavior through ProGuard rules files. In fact, R8 works with all of your existing ProGuard rules files, so updating the Android Gradle Plugin to use R8 should not require you to change your existing rules.   (当你构建release版本时, R8默认会执行上述的优化方案。当然你可以通过ProGuard文件来手动禁止某个task和更改它的配置. 实际上，R8对ProGurad是兼容的，因此你可以直接升级使用R8而不必更改你的ProGuard rules 文件)</p>
<h2 id="Enable-shrinking-obfuscation-and-optimization"><a href="#Enable-shrinking-obfuscation-and-optimization" class="headerlink" title="Enable shrinking, obfuscation, and optimization"></a>Enable shrinking, obfuscation, and optimization</h2><p>When you use Android Studio 3.4 or Android Gradle plugin 3.4.0 and higher, R8 is the default compiler that converts your project’s Java bytecode into the DEX format that runs on the Android platform. However, when you create a new project using Android Studio, shrinking, obfuscation, and code optimization is not enabled by default. That’s because these compile-time optimizations increase the build time of your project and might introduce bugs if you do not sufficiently <a href="https://developer.android.com/studio/build/shrink-code#keep-code" target="_blank" rel="noopener">customize which code to keep</a>. (当你使用Android Studio3.4或者Android Gradle Plugin 3.4.0+的话，R8是默认的把Java字节码编译为DEX的编译器. 当你创建一个新的工程时，默认shrinking, obfuscation, code optimization是关闭的，因为这些编译时的优化可能会增加编译时间，以及引入一些bug, 如果你不充分了解<a href="https://developer.android.com/studio/build/shrink-code#keep-code" target="_blank" rel="noopener">customize which code to keep</a>的话)</p>
<p>So, it’s best to enable these compile-time tasks when building the final version of your app that you test prior to publishing. To enable shrinking, obfuscation, and optimization, include the following in your project-level build.gradle file. (所以，最好在编译最终版本时再去打开这个. 打开方式如下: )</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            // Enables code shrinking, obfuscation, and optimization for only</span><br><span class="line">            // your project's release build type.</span><br><span class="line">            // 这儿是针对代码的</span><br><span class="line">            minifyEnabled true</span><br><span class="line"></span><br><span class="line">            // Enables resource shrinking, which is performed by the</span><br><span class="line">            // Android Gradle plugin.</span><br><span class="line">            //这儿是针对资源的</span><br><span class="line">            shrinkResources true</span><br><span class="line"></span><br><span class="line">            // Includes the default ProGuard rules files that are packaged with</span><br><span class="line">            // the Android Gradle plugin. To learn more, go to the section about</span><br><span class="line">            // R8 configuration files.</span><br><span class="line">            proguardFiles getDefaultProguardFile(</span><br><span class="line">                    'proguard-android-optimize.txt'),</span><br><span class="line">                    'proguard-rules.pro'</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="R8-configuration-files"><a href="#R8-configuration-files" class="headerlink" title="R8 configuration files"></a>R8 configuration files</h2><p>R8 uses ProGuard rules files to modify its default behavior and better understand your app’s structure, such as the classes that serve as entry points into your app’s code. Although you can modify some of these rules files, some rules may be generated automatically by compile-time tools, such as AAPT2, or inherited from your app’s library dependencies. The table below describes the sources of ProGuard rules files that R8 uses.<br>(R8使用ProGuard rules文件来配合优化。 有些文件是系统生成的，有些你可以自行修改。以下的表格里记录了R8用到的ProGurad rules文件)</p>
<table>
<thead>
<tr>
<th>Source</th>
<th>Location</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Android Studio</td>
<td><module-dir>/proguard-rules.pro</module-dir></td>
<td>When you create a new module using Android Studio, the IDE creates a proguard-rules.pro file in the root directory of that module. By default, this file does not apply any rules. So, include your own ProGuard rules here, such as your custom keep rules.</td>
</tr>
<tr>
<td>Android Gradle plugin</td>
<td>Generated by the Android Gradle plugin at compile time.</td>
<td>The Android Gradle plugin generates proguard-android-optimize.txt, which includes rules that are useful to most Android projects and enables @Keep* annotations. By default, when creating a new module using Android Studio, the module-level build.gradle file includes this rules file in your release build for you.</td>
</tr>
<tr>
<td>Library dependencies</td>
<td>AAR libraries: <library-dir>/proguard.txt JAR libraries: <library-dir>/META-INF/proguard/</library-dir></library-dir></td>
<td>If an AAR library is published with its own ProGuard rules file, and you include that AAR as a compile-time dependency, R8 automatically applies its rules when compiling your project. Using rules files that are packaged with AAR libraries is useful if certain keep rules are required for the library to function properly—that is, the library developer has performed the troubleshooting steps for you. However, you should be aware that, because ProGuard rules are additive, certain rules that an AAR library dependency includes cannot be removed and might impact the compilation of other parts of your app. For example, if a library includes a rule to disable code optimizations, that rule disables optimizations for your entire project.</td>
</tr>
<tr>
<td>Android Asset Package Tool 2 (AAPT2)</td>
<td>After building your project with minifyEnabled true: <module-dir>/build/intermediates/proguard-rules/debug/aapt_rules.txt</module-dir></td>
<td>AAPT2 generates keep rules based on references to classes in your app’s manifest, layouts, and other app resources. For example, AAPT2 includes a keep rule for each Activity that you register in your app’s manifest as an entry point.</td>
</tr>
<tr>
<td>Custom configuration files</td>
<td>By default, when you create a new module using Android Studio, the IDE creates <module-dir>/proguard-rules.pro for you to add your own rules.</module-dir></td>
<td>You can include additional configurations, and R8 applies them at compile-time.</td>
</tr>
</tbody></table>
<p>When you set the <code>minifyEnabled</code> property to <code>true</code>, R8 combines rules from all the avaiblable sources listed above. This is important to remember when you <a href>troubleshoot with R8</a>, because other compile-time dependencies, such as library dependencies, may introduce changes to the R8 behavior that you donot know about. </p>
<p>(当你设置minifyEnable为true的时候，R8会把以上文件结合起来. 你需要注意这一点，因为如果你依赖的一个东西更改了R8的设置， 着对你可能是无感的.)</p>
<p>To output a full report of all the rules that R8 applies when building your project, include the following in your module’s <code>proguard-rules.pro</code> file:</p>
<p>(打印R8用到的所有的rules)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// You can specify any path and filename.</span><br><span class="line">-printconfiguration ~/tmp/full-r8-config.txt</span><br></pre></td></tr></table></figure>

<h3 id="Include-additional-configurations"><a href="#Include-additional-configurations" class="headerlink" title="Include additional configurations"></a>Include additional configurations</h3><p>When you create a new project or module using Android Studio, the IDE creates a <code>&lt;module-dir&gt;/proguard-rules.pro</code> file for you to include your own rules. You can also include additional rules from other files by adding them to the <code>proguardFiles</code> property in your module’s build.gradle file. </p>
<p>(使用Android studio会默认在<code>module-dir/</code>下创建<code>proguard-rules.pro</code>文件， 你可以在里面写自己的一些规则， 当然你也可以自己增加文件， 然后在<code>proguardFiles</code>里添加进来)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="string">'proguard-android-optimize.txt'</span>)</span>,</span></span><br><span class="line"><span class="function">              <span class="comment">// List additional ProGuard rules for the given build type here. By default,</span></span></span><br><span class="line"><span class="function">              <span class="comment">// Android Studio creates and includes an empty rules file for you (located</span></span></span><br><span class="line"><span class="function">              <span class="comment">// at the root directory of each module).</span></span></span><br><span class="line"><span class="function">              'proguard-rules.pro'</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    flavorDimensions "version"</span></span><br><span class="line"><span class="function">    productFlavors </span>&#123;</span><br><span class="line">        flavor1 &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">        flavor2 &#123;</span><br><span class="line">            proguardFile <span class="string">'flavor2-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Shrink-your-code"><a href="#Shrink-your-code" class="headerlink" title="Shrink your code"></a>Shrink your code</h2><p>Code shrinking with R8 is enabled by default when you set the minifyEnabled property to true. (设置minifyEnabled为true默认就会开启代码优化)</p>
<p>Code shrinking (also known as tree shaking), is the process of removing code that R8 determines is not required at runtime. This process can greatly reduce your app’s size if, for example, your app includes many library dependencies but utilizes only a small part of their functionality. (它对减少app大小很有效，尤其是如果你引用了一个很大的库但是只使用了很少一部分的时候)</p>
<p>To shrink your app’s code, R8 first determines all entry points into your app’s code based on the combined <a href="https://developer.android.com/studio/build/shrink-code#configuration-files" target="_blank" rel="noopener">set of configuration files</a>. These entry points include all classes that the Android platform may use to open your app’s Activities or services. Starting from each entry point, R8 inspects your app’s code to build a graph of all methods, member variables, and other classes that your app might access at runtime. Code that is not connected to that graph is considered unreachable and may be removed from the app. (类似垃圾清理，没有依赖到的会被删除掉)</p>
<p>Figure 1 shows an app with a runtime library dependency. While inspecting the app’s code, R8 determines that methods foo(), faz(), and bar() are reachable from the MainActivity.class entry point. However, class OkayApi.class or its method baz() is never used by your app at runtime, and R8 removes that code when shrinking your app.</p>
<p><img src="https://developer.android.com/studio/images/build/r8/tree-shaking.png" alt></p>
<p>R8 determines entry points through -keep rules in the project’s <a href="https://developer.android.com/studio/build/shrink-code#configuration-files" target="_blank" rel="noopener">R8 configuration files</a>. That is, keep rules specify classes that R8 should not discard when shrinking your app, and R8 considers those classes as possible entry points into your app. The Android Gradle plugin and AAPT2 automatically generate keep rules that are required by most app projects for you, such as your app’s activities, views, and services. However, if you need to customize this default behavior with additional keep rules, read the section about how to <a href="https://developer.android.com/studio/build/shrink-code#keep-code" target="_blank" rel="noopener">customize which code to keep</a>. (Android Gradle Plugin 和 APPT2会自动生成为你程序里使用到的大部分类生成keep规则, 比如activity, view, service等. 当然，你可以自己去更改这些)</p>
<p>If instead you are interested only in reducing the size of your app’s resources, skip to the section about how to <a href="https://developer.android.com/studio/build/shrink-code#shrink-resources" target="_blank" rel="noopener">shrink your resources</a>. (如果你只对减少资源大小感兴趣, 跳过这块去看链接的部分)</p>
<h3 id="Customize-which-code-to-keep"><a href="#Customize-which-code-to-keep" class="headerlink" title="Customize which code to keep"></a>Customize which code to keep</h3><p>For most situations, the default ProGuard rules file (proguard-android- optimize.txt) is sufficient for R8 to remove only the unused code. However, some situations are difficult for R8 to analyze correctly and it might remove code your app actually needs. Some examples of when it might incorrectly remove code include: </p>
<p>(默认的ProGuard rules文件,proguard-android- optimize.txt, 可能会删除一些你程序需要的代码，比如以下情况: )</p>
<ul>
<li>When your app calls a method from the Java Native Interface (JNI) </li>
<li>When your app looks up code at runtime (such as with reflection)</li>
</ul>
<p>Testing your app should reveal any errors caused by inappropriately removed code, but you can also inspect what code was removed by <a href="https://developer.android.com/studio/build/shrink-code#usage" target="_blank" rel="noopener">generating a report of removed code</a>.</p>
<p>To fix errors and force R8 to keep certain code , add a <code>-keep</code> line in the ProGuard rules file. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br></pre></td></tr></table></figure>

<p>Alternatively, you can add the <code>@Keep</code> annotation to the code you want to keep. Adding <code>@Keep</code> on a class keeps the entire class as-is. Adding it on a method or field will keep the method/field (and its name) as well as the class name intact. Note that this annotation is available only when using the <a href="https://developer.android.com/reference/androidx/annotation/package-%0Asummary" target="_blank" rel="noopener">AndroidX Annotations Library</a> and when you include the ProGuard rules file that is packaged with the Android Gradle plugin, as described in the section about how to <a href="https://developer.android.com/studio/build/shrink-code#enable" target="_blank" rel="noopener">enable shrinking</a>. 
(你也可以使用AndroidX包里的相关注解，来注解方法或者类或者字段)</p>
<p>There are many considerations you should make when using the -keep option; for more information about customizing your rules file, read the <a href="https://www.guardsquare.com/en/products/proguard/manual/usage" target="_blank" rel="noopener">ProGuard Manual</a>. The <a href="https://www.guardsquare.com/en/products/proguard/manual/troubleshooting" target="_blank" rel="noopener">Troubleshooting</a> section outlines other common problems you might encounter when your code gets stripped away.</p>
<h2 id="Shrink-your-resources"><a href="#Shrink-your-resources" class="headerlink" title="Shrink your resources"></a>Shrink your resources</h2><p>Resource shrinking works only in conjunction with code shrinking. After the code shrinker removes all unused code, the resource shrinker can identify which resources the app still uses. This is especially true when you add code libraries that include resources—you must remove unused library code so the library resources become unreferenced and, thus, removable by the resource shrinker. (Code shrinker 删除掉无用的代码后, resource Shrinker会把unreferenced的资源给删掉)</p>
<p>To enable resource shrinking, set the <code>shrinkResources</code> property to true in your build.gradle file (alongside minifyEnabled for code shrinking). For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>,</span></span><br><span class="line"><span class="function">                    'proguard-rules.pro'</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>If you haven’t already built your app using <code>minifyEnabled</code> for code shrinking, then try that before enabling <code>shrinkResources</code>, because you might need to edit your <code>proguard-rules.pro</code> file to keep classes or methods that are created or invoked dynamically before you start removing resources. (最好开启shrinkResource时也要开启minifyEnable, 因为如果你删除某个资源，但是proguard-rules.pro把相关的类给keep了，就会出现问题)</p>
<h3 id="Customize-which-resources-to-keep"><a href="#Customize-which-resources-to-keep" class="headerlink" title="Customize which resources to keep"></a>Customize which resources to keep</h3><p>If there are specific resources you wish to keep or discard, create an XML file in your project with a <code>&lt;resources&gt;</code> tag and specify each resource to keep in the <code>tools:keep</code> attribute and each resource to discard in the <code>tools:discard</code> attribute. Both attributes accept a comma-separated list of resource names. You can use the asterisk character as a wild card.  (在工程里创建一个<code>resources</code>, 然后通过<code>tools:keep</code>, <code>tools:discard</code>来指定那些需要keep, 那些discard)</p>
<p>For example:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span> <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:keep</span>=<span class="string">"@layout/l_used*_c,@layout/l_used_a,@layout/l_used_b*"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:discard</span>=<span class="string">"@layout/unused2"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>Save this file in your project resources, for example, at <code>res/raw/keep.xml</code>. The build does not package this file into your APK.</p>
<p>Specifying which resources to discard might seem silly when you could instead delete them, but this can be useful when using build variants. For example, you might put all your resources into the common project directory, then create a different <code>keep.xml</code> file for each build variant when you know that a given resource appears to be used in code (and therefore not removed by the shrinker) but you know it actually won’t be used for the given build variant. It’s also possible that the build tools incorrectly identified a resource as needed, which is possible because the compiler adds the resource IDs inline and then the resource analyzer might not know the difference between a genuinely referenced resource and an integer value in the code that happens to have the same value. (你可能以为那些资源要discard会很傻，因为你可以直接删除它， 但是这个在多渠道打包的时候会很有用.)</p>
<h3 id="Enable-strict-reference-checks"><a href="#Enable-strict-reference-checks" class="headerlink" title="Enable strict reference checks"></a>Enable strict reference checks</h3><p>Normally, the resource shrinker can accurately determine whether a resource is used. However, if your code makes a call to <code>Resources.getIdentifier()</code> (or if any of your libraries do that—the AppCompat library does), that means your code is looking up resource names based on dynamically-generated strings. When you do this, the resource shrinker behaves defensively by default and marks all resources with a matching name format as potentially used and unavailable for removal. (如果你的程序里使用了动态获取资源的话， resource shrinker会保守的把所有可能匹配的资源全部保留)</p>
<p>For example, the following code causes all resources with the <code>img_</code> prefix to be marked as used.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String name = String.format(<span class="string">"img_%1d"</span>, angle + <span class="number">1</span>);</span><br><span class="line">res = getResources().getIdentifier(name, <span class="string">"drawable"</span>, getPackageName());</span><br></pre></td></tr></table></figure>

<p>The resource shrinker also looks through all the string constants in your code, as well as various res/raw/ resources, looking for resource URLs in a format similar to file:///android_res/drawable//ic_plus_anim_016.png. If it finds strings like this or others that look like they could be used to construct URLs like this, it doesn’t remove them.</p>
<p>These are examples of the safe shrinking mode that is enabled by default. You can, however, turn off this <code>&quot;better safe than sorry&quot;</code> handling, and specify that the resource shrinker keep only resources that it’s certain are used. To do this, set <code>shrinkMode</code> to <code>strict</code> in the <code>keep.xml</code> file, as follows:</p>
<p>（你可以使用严格模式， 不支持这种匹配, 通过keep.xml里如下设置)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span> <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:shrinkMode</span>=<span class="string">"strict"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>If you do enable strict shrinking mode and your code also references resources with dynamically-generated strings, as shown above, then you must manually keep those resources using the <code>tools:keep</code> attribute.</p>
<p>(如果你用了严格的模式，然后某些动态引用的就需要你手动的去keep)</p>
<h3 id="Remove-unused-alternative-resources"><a href="#Remove-unused-alternative-resources" class="headerlink" title="Remove unused alternative resources"></a>Remove unused alternative resources</h3><p>The Gradle resource shrinker removes only resources that are not referenced by your app code, which means it will not remove <a href="https://developer.android.com/guide/topics/resources/providing-resources.html#AlternativeResources" target="_blank" rel="noopener">alternative resources</a> for different device configurations. If necessary, you can use the Android Gradle plugin’s resConfigs property to remove alternative resource files that your app does not need. </p>
<p>(resource shrinker只会删除没有引用到的资源， 而不会删除<code>alternative resources</code>, 比如不同配置下的资源。 如果你需要删除不用的配置下的资源，你可以如下设置: )</p>
<p>For example, if you are using a library that includes language resources (such as AppCompat or Google Play Services), then your APK includes all translated language strings for the messages in those libraries whether the rest of your app is translated to the same languages or not. If you’d like to keep only the languages that your app officially supports, you can specify those languages using the <code>resConfig</code> property. Any resources for languages not specified are removed.</p>
<p>The following snippet shows how to limit your language resources to just English and French:</p>
<p>(只保留英文和法语资源)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        resConfigs "en", "fr"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Similarly, you can customize which screen density or ABI resources to include in your APK by <a href="https://developer.android.com/studio/build/configure-apk-splits.html" target="_blank" rel="noopener">building multiple APKs</a> that each target a different device configuration.</p>
<h3 id="Merge-duplicate-resources"><a href="#Merge-duplicate-resources" class="headerlink" title="Merge duplicate resources"></a>Merge duplicate resources</h3><p>By default, Gradle also merges identically named resources, such as drawables with the same name that might be in different resource folders. This behavior is not controlled by the <code>shrinkResources</code> property and cannot be disabled, because it is necessary to avoid errors when multiple resources match the name your code is looking up. (系统会自动merge重名的resources, 不然查找资源的时候可能会出现问题)</p>
<p>Resource merging occurs only when two or more files share an identical resource name, type, and qualifier. Gradle selects which file it considers to be the best choice among the duplicates (based on a priority order described below) and passes only that one resource to the AAPT for distribution in the APK file.</p>
<p>Gradle looks for duplicate resources in the following locations:</p>
<p>(Gradle会从以下几个地方找resources)</p>
<ul>
<li>The main resources, associated with the main source set, generally located in src/main/res/.</li>
<li>The variant overlays, from the build type and build flavors.</li>
<li>The library project dependencies.</li>
</ul>
<p>Gradle merges duplicate resources in the following cascading priority order:</p>
<p>Dependencies → Main → Build flavor → Build type (Gralde merge资源的优先级顺序， 右侧会覆盖左侧)</p>
<p>For example, if a duplicate resource appears in both your main resources and a build flavor, Gradle selects the one in the build flavor.</p>
<p>If identical resources appear in the same source set, Gradle cannot merge them and emits a resource merge error. This can happen if you define multiple source sets in the sourceSet property of your <code>build.gradle</code> file—for example if both <code>src/main/res/</code> and <code>src/main/res2/</code> contain identical resources. (如果同级别下两个相同名称的资源，系统会报错)</p>
<h2 id="Obfuscate-your-code"><a href="#Obfuscate-your-code" class="headerlink" title="Obfuscate your code"></a>Obfuscate your code</h2><p>The purpose of obfuscation is to reduce your app size by shortening the names of your app’s classes, methods, and fields. The following is an example of obfuscation using R8:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">androidx.appcompat.app.ActionBarDrawerToggle$DelegateProvider -&gt; a.a.a.b:</span><br><span class="line">androidx.appcompat.app.AlertController -&gt; androidx.appcompat.app.AlertController:</span><br><span class="line">    android.content.Context mContext -&gt; a</span><br><span class="line">    <span class="keyword">int</span> mListItemLayout -&gt; O</span><br><span class="line">    <span class="keyword">int</span> mViewSpacingRight -&gt; l</span><br><span class="line">    android.widget.Button mButtonNeutral -&gt; w</span><br><span class="line">    <span class="keyword">int</span> mMultiChoiceItemLayout -&gt; M</span><br><span class="line">    <span class="keyword">boolean</span> mShowTitle -&gt; P</span><br><span class="line">    <span class="keyword">int</span> mViewSpacingLeft -&gt; j</span><br><span class="line">    <span class="keyword">int</span> mButtonPanelSideLayout -&gt; K</span><br></pre></td></tr></table></figure>

<p>While obfuscation does not remove code from your app, significant size savings can be seen in apps with DEX files that index many classes, methods, and fields. However, as obfuscation renames different parts of your code, certain tasks, such as inspecting stack traces, require additional tools. To understand your stacktrace after obfuscation, read the next section about how to <a href="https://developer.android.com/studio/build/shrink-code#decode-stack-trace" target="_blank" rel="noopener">decode an obfuscated stack trace</a>.</p>
<p>Additionally, if your code relies on predictable naming for your app’s methods and classes—when using reflection, for example, you should treat those signatures as entry points and specify keep rules for them, as described in the section about how to <a href="https://developer.android.com/studio/build/shrink-code#customize-which-code-to-keep" target="_blank" rel="noopener">customize which code to keep</a>. Those keep rules tell R8 to not only keep that code in your app’s final DEX but also retain its original naming.  (反射的话， 需要手动去keep)</p>
<h3 id="Decode-an-obfuscated-stack-trace"><a href="#Decode-an-obfuscated-stack-trace" class="headerlink" title="Decode an obfuscated stack trace"></a>Decode an obfuscated stack trace</h3><p>After R8 obfuscates your code, understanding a stack trace is difficult (if not impossible) because names of classes and methods might have been changed. Besides renaming, R8 can also change the line numbers present in the stack traces to achieve additional size savings when writing the DEX files. Fortunately, R8 creates a <code>mapping.txt</code> file each time it runs, which contains the obfuscated class, method, and field names mapped to the original names. This mapping file also contain information to map the line numbers back to the original source file line numbers. R8 saves the file in the <code>&lt;module- name&gt;/build/outputs/mapping/&lt;build-type&gt;/</code> directory. (每次R8混淆代码时候，会在上述目录中创建mapping文件，用于解析难懂的代码)</p>
<p>When publishing your app on Google Play, you can upload the <code>mapping.txt</code> file for each version of your APK. Then Google Play will deobfuscate incoming stack traces from user-reported issues so you can review them in the Google Play Console. For more information, see the Help Center article about how to <a href="https://support.google.com/googleplay/android-developer/answer/6295281" target="_blank" rel="noopener">deobfuscate crash stack traces</a>.</p>
<p>To convert an obfuscated stack trace to a readable one yourself, use the <a href="https://www.guardsquare.com/en/products/proguard/manual/retrace" target="_blank" rel="noopener">ReTrace</a> script, which comes packaged with <a href="https://www.guardsquare.com/en/products/proguard" target="_blank" rel="noopener">ProGuard</a>. </p>
<p>(把混淆后的代码复原可以用ReTrace工具)</p>
<h2 id="Code-optimization"><a href="#Code-optimization" class="headerlink" title="Code optimization"></a>Code optimization</h2><p>In order to shrink your app even further, R8 inspects your code at a deeper level to remove more unused code or, where possible, rewrite your code to make it less verbose. The following are a few examples of such optimizations:</p>
<p>(R8还会对你的代码进行深层优化)</p>
<ul>
<li>If your code never takes the <code>else {}</code> branch for a given <code>if/else</code> statement, R8 might remove the code for the <code>else {}</code> branch.</li>
<li>If your code calls a method in only one place, R8 might remove the method and inline it at the single call site.  (只有一个地方调用的函数，R8会把它内联进来)</li>
<li>If R8 determines that a class has only one unique subclass, and the class itself is not instantiated (for example, an abstract base class only used by one concrete implementation class), then R8 can combine the two classes and remove a class from the app. (如果一个类和它子类，如果父类只是被继承的话， 那么R8会把两个类合并)</li>
<li>To learn more, read the <a href="https://jakewharton.com/blog/" target="_blank" rel="noopener">R8 optimization blog </a> posts by Jake Wharton.</li>
</ul>
<p>R8 does not allow you to disable or enable discrete optimizations, or modify the behavior of an optimization. In fact, R8 ignores any ProGuard rules that attempt to modify default optimizations, such as <code>-optimizations</code> and <code>-optimizationpasses</code>. This restriction is important because, as R8 continues to improve, maintaining a standard behavior for optimizations helps the Android Studio team easily troubleshoot and resolve any issues that you might encounter. (R8不允许你进行一些自定义的optimization行为)</p>
<h3 id="Enable-more-aggressive-optimizations"><a href="#Enable-more-aggressive-optimizations" class="headerlink" title="Enable more aggressive optimizations"></a>Enable more aggressive optimizations</h3><p>R8 includes a set of additional optimizations that are not enabled by default. You can enable these additional optimizations by including the following in your project’s gradle.properties file:</p>
<p>(R8包含了一些可选的优化选项，你可以打开或者关闭)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.enableR8.fullMode=true</span><br></pre></td></tr></table></figure>

<p>Because the additional optimizations make R8 behave differently from ProGuard, they may require you to include additional ProGuard rules to avoid runtime issues. For example, say that your code references a class through the Java Reflection API. By default, R8 assumes that you intend to examine and manipulate objects of that class at runtime—even if you code actually does not—and it automatically keeps the class and its static initializer.</p>
<p>However, when using “full mode”, R8 does not make this assumption and, if R8 asserts that your code otherwise never uses the class at runtime, it removes the class from your app’s final DEX. That is, if you want to keep the class and its static initializer, you need to include a keep rule in your rules file to do that.</p>
<p>If you encounter any issues while using R8’s “full mode”, refer to the <a href="https://r8.googlesource.com/r8/+/refs/heads/master/compatibility-faq.md" target="_blank" rel="noopener">R8 FAQ page</a> for a possible solution. If you are unable to resolve the issue, please <a href="https://issuetracker.google.com/issues/new?component=326788&template=1025938" target="_blank" rel="noopener">report a bug</a>.</p>
<h2 id="Troubleshoot-with-R8"><a href="#Troubleshoot-with-R8" class="headerlink" title="Troubleshoot with R8"></a>Troubleshoot with R8</h2><p>This section describes some strategies for troubleshooting issues when enabling shrinking, obfuscation, and optimization using R8. If you do not find a solution to your issue below, also read the <a href="https://r8.googlesource.com/r8/+/refs/heads/master/compatibility-faq.md" target="_blank" rel="noopener">R8 FAQ page</a> and <a href="https://www.guardsquare.com/en/products/proguard/manual/troubleshooting" target="_blank" rel="noopener">ProGuard’s troubleshooting guide</a>.</p>
<p>(这块描述了如果你在优化过程中遇到了一些问题的一些策略)</p>
<h3 id="Generate-a-report-of-removed-or-kept-code"><a href="#Generate-a-report-of-removed-or-kept-code" class="headerlink" title="Generate a report of removed (or kept) code"></a>Generate a report of removed (or kept) code</h3><p>To help you troubleshoot certain R8 issues, it may be useful to see a report of all the code that R8 removed from your app. For each module for which you want to generate this report, add -printusage <output-dir>/usage.txt to your custom rules file. When you <a href="https://developer.android.com/studio/build/shrink-code#enable" target="_blank" rel="noopener">enable R8</a> and build your app, R8 outputs a report with the path and file name you specified. The report of removed code looks similar to the following:</output-dir></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    androidx.drawerlayout.R$attr</span><br><span class="line">androidx.vectordrawable.R</span><br><span class="line">androidx.appcompat.app.AppCompatDelegateImpl</span><br><span class="line">    public void setSupportActionBar(androidx.appcompat.widget.Toolbar)</span><br><span class="line">    public boolean hasWindowFeature(int)</span><br><span class="line">    public void setHandleNativeActionModesEnabled(boolean)</span><br><span class="line">    android.view.ViewGroup getSubDecor()</span><br><span class="line">    public void setLocalNightMode(int)</span><br><span class="line">    final androidx.appcompat.app.AppCompatDelegateImpl$AutoNightModeManager getAutoNightModeManager()</span><br><span class="line">    public final androidx.appcompat.app.ActionBarDrawerToggle$Delegate getDrawerToggleDelegate()</span><br><span class="line">    private static final boolean DEBUG</span><br><span class="line">    private static final java.lang.String KEY_LOCAL_NIGHT_MODE</span><br><span class="line">    static final java.lang.String EXCEPTION_HANDLER_MESSAGE_SUFFIX</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>If instead you want to see a report of the entry points that R8 determines from your project’s keep rules , include -printseeds <output-dir>/seeds.txt in your custom rules file. When you enable R8 and build your app, R8 outputs a report with the path and file name you specified. The report of kept entry points looks similar to the following:</output-dir></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    com.example.myapplication.MainActivity</span><br><span class="line">androidx.appcompat.R$layout: int abc_action_menu_item_layout</span><br><span class="line">androidx.appcompat.R$attr: int activityChooserViewStyle</span><br><span class="line">androidx.appcompat.R$styleable: int MenuItem_android_id</span><br><span class="line">androidx.appcompat.R$styleable: int[] CoordinatorLayout_Layout</span><br><span class="line">androidx.lifecycle.FullLifecycleObserverAdapter</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Troubleshoot-resource-shrinking"><a href="#Troubleshoot-resource-shrinking" class="headerlink" title="Troubleshoot resource shrinking"></a>Troubleshoot resource shrinking</h3><p>When you shrink resources, the <code>Build</code>   window shows a summary of the resources that are removed from the APK. (You need to first click <code>Toggle view</code>   on the left side of the window to display detailed text output from Gradle.) For example:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:android:shrinkDebugResources</span><br><span class="line">Removed unused resources: Binary resource data reduced from 2570KB to 1711KB: Removed 33%   </span><br><span class="line">:android:validateDebugSigning</span><br></pre></td></tr></table></figure>

<p>Gradle also creates a diagnostic file named <code>resources.txt</code> in <code>&lt;module-name&gt;/build/outputs/mapping/release/</code> (the same folder as ProGuard’s output files). This file includes details such as which resources reference other resources and which resources are used or removed.</p>
<p>For example, to find out why @drawable/ic_plus_anim_016 is still in your APK, open the <code>resources.txt</code> file and search for that file name. You might find that it’s referenced from another resource, as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">16:25:48.005 [QUIET] [system.out] &amp;#64;drawable/add_schedule_fab_icon_anim : reachable=true</span><br><span class="line">16:25:48.009 [QUIET] [system.out]     &amp;#64;drawable/ic_plus_anim_016</span><br></pre></td></tr></table></figure>

<p>(可以从resources.txt里查看某个resource是为啥没被删除)</p>
<p>You now need to know why <code>@drawable/add_schedule_fab_icon_anim</code> is reachable—and if you search upwards you’ll find that resource is listed under “The root reachable resources are:”. This means there is a code reference to <code>add_schedule_fab_icon_anim</code> (that is, its R.drawable ID was found in the reachable code).</p>
<p>If you are not using strict checking, resource IDs can be marked as reachable if there are string constants that look like they might be used to construct resource names for dynamically loaded resources. In that case, if you search the build output for the resource name, you might find a message like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10:32:50.590 [QUIET] [system.out] Marking drawable:ic_plus_anim_016:2130837506</span><br><span class="line">used because it format-string matches string pool constant ic_plus_anim_%1$d.</span><br></pre></td></tr></table></figure>

<p>If you see one of these strings and you are certain that the string is not being used to load the given resource dynamically, you can use the <code>tools:discard</code> attribute to inform the build system to remove it, as described in the section about how to <a href="https://developer.android.com/studio/build/shrink-code#keep-resources" target="_blank" rel="noopener">customize which resources to keep</a>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/8daa0b89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/8daa0b89/" itemprop="url">Translation-Configure your build-Overview</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-30T10:36:02+08:00">
                2019-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/8daa0b89/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/8daa0b89/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Configure-your-build"><a href="#Configure-your-build" class="headerlink" title="Configure your build"></a>Configure your build</h1><p>The Android build system compiles app resources and source code, and packages them into APKs that you can test, deploy, sign, and distribute. Android Studio uses <a href="http://www.gradle.org/" target="_blank" rel="noopener">Gradle</a>, an advanced build toolkit, to automate and manage the build process, while allowing your to define flexible custom build configurations. Each build configuration can define its own set of code and resources, while reusing the parts common to all versions of your app. The Android plugin for Gradle works with the build toolkit to provide processes and configurable settings that are specific to building and testing Android applications.<br>(Android编译系统通过Gradle把app资源和代码，编译进APK里。Gradle是一个高级的工具，可以自动管理编译过程，而且提供了丰富的可配置选项.)</p>
<p>Gradle and the Android plugin run independent of Android Studio. This means that you can build your Android apps from within Android Studio, the command line on your machine, or on machines where Android Studio is not installed(such as continuous integration servers.). If you are not using Android Studio, you can learn how to <a href="https://developer.android.com/studio/build/building-cmdline.html" target="_blank" rel="noopener">biuld and run your app from the command line</a>. The output of the build is the same whether you are building a project from the command line, on a remote machine, or using Android Studio.<br>(Gralde和Android Gradle插件是独立的。 你可以使用Android Studio或命令行或其他没有安装AndroidStudio的机器上来编译程序.)</p>
<p>The flexibility of the Android build system enables you to perform custom build configurations without modifying your app’s core source files. This section helps you understand how the Android build system works, and how it can help you customize and automate multiple build configurations. If you simply want to learn more about deploying your app, see <a href="https://developer.android.com/studio/run/index.html" target="_blank" rel="noopener">Building and Running from Android Studio</a>. To start creating custom build configurations right away using Android Studio, see<a href="https://developer.android.com/studio/build/build-variants.html" target="_blank" rel="noopener">Configuring Build Variants</a>.</p>
<h2 id="The-build-process"><a href="#The-build-process" class="headerlink" title="The build process"></a>The build process</h2><p>The build process involves many tools and processes that convert your project into an Android Application Package(APK). The build process is very flexible, so it’s useful to understand some of what is happening under the hood.<br>(APK编译过程包含很多工具和程序)</p>
<p><img src="https://developer.android.com/images/tools/studio/build-process_2x.png" alt="build process"><br>The build process for a typical Android app module, as shown in figure 1, follows these general steps:</p>
<ol>
<li>The compilers convert your source code into DEX(Dalvik Executable) files, which include the bytecode that runs on Android devices, and everything else into compiled resources.  (首先编译器会把你的代码编译为DEX文件，这里包含了可在Android设备上执行的字节码和其他编译后的资源文件)</li>
<li>The APK Packager combines the DEX files and compiled resources into a single APK. Before your app can be installed and deployed onto an Android device, however, the APK must be signed. (APK Packager把dex和编译后的资源文件打包为APK. 但是这时还不能安装，APK还需要被签名)</li>
<li>The APK Packager signs your APK using either the debug or release keystore:<ol>
<li>If you are building a debug version of your app, that is , an app you intent only for testing and profiling, the packager signs your app with the debug keystoe. Android Studio atomicatically configures new projects with a debug keystore. (如果你只需要为了测试，你编译个debug程序就够了， Android Studio会自动的给价格debug签名)</li>
<li>If you are building a release version of your app that you intent to release externally, the packager signs your app with the release keystore. To create a release keystore, read about <a href="https://developer.android.com/studio/publish/app-signing.html#studio" target="_blank" rel="noopener">signing your app in Android Studio</a> (如果你需要发布程序，那么你需要编译release包，这就需要release签名文件)</li>
</ol>
</li>
<li>Before generating your final APK, the packager uses the <a href="https://developer.android.com/studio/command-line/zipalign.html" target="_blank" rel="noopener">zipalign</a> tool to optimize your app to use less memory when running on a device. (最终生成APK之前，<code>zipalign</code>工具还会对app再次优化下程序内存。)</li>
</ol>
<p>At the end of the build process, you have either a debug APK or relase APK of your app that you can use to deply, test, or release to external users.</p>
<h2 id="Custom-build-configurations"><a href="#Custom-build-configurations" class="headerlink" title="Custom build configurations"></a>Custom build configurations</h2><p>Gradle and the Android plugin help you configure the following aspects of your build:</p>
<ul>
<li><p>Build Types<br>  Build types define certain properties that Gradle uses when building and packaging your app, and are typically configured for different stages of your development lifecycle. For example, the debug type enables debug options and signs the APK with the debug key, while the release build type may shrink, obfuscate, and sign your APK with a release key for distribution. You must define at least one build type in order to build your app- Android Studio creates the debug and release build types by default. To start customizing packaging settings for your app, learn how to <a href="https://developer.android.com/studio/build/build-variants.html#build-types" target="_blank" rel="noopener">Configure Build Types</a>  (Build types 定义了Gradle在编译程序时候需要的一些属性, 比如： )</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        manifestPlaceholders = [hostName:<span class="string">"www.example.com"</span>]</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</span></span><br><span class="line"><span class="function">        &#125;   </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        debug </span>&#123;</span><br><span class="line">            applicationIdSuffix <span class="string">".debug"</span></span><br><span class="line">            debuggable <span class="keyword">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The `initWith` property allows you to copy configurations from other build types,</span></span><br><span class="line"><span class="comment">         * then configure only the settings you want to change. This one copies the debug build</span></span><br><span class="line"><span class="comment">         * type, and then changes the manifest placeholder and application ID.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        staging &#123;</span><br><span class="line">            initWith debug</span><br><span class="line">            manifestPlaceholders = [hostName:<span class="string">"internal.example.com"</span>]</span><br><span class="line">            applicationIdSuffix <span class="string">".debugStaging"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Product Flavors<br>Product flavors represent different versions of your app that you may release to users, such as free and paid version of your app. You can customize product flavors to use different code and resources, while sharing and reusing the parts that are common to all versions of yoru app. Product flavors are optional and you must create them manually . To start creating differernt versions of your app, learn how to <a href="https://developer.android.com/studio/build/build-variants.html#product-flavors" target="_blank" rel="noopener">Configure Product Flavors</a>.  (Product Flavors可以控制多渠道编译，比如你可以编译出付费和免费版本，使用同一套代码, 你可以指定程序使用不同的代码和资源)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;...&#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug&#123;...&#125;</span><br><span class="line">        release&#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Specifies one flavor dimension.</span></span><br><span class="line">    flavorDimensions <span class="string">"version"</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        demo &#123;</span><br><span class="line">            <span class="comment">// Assigns this product flavor to the "version" flavor dimension.</span></span><br><span class="line">            <span class="comment">// This property is optional if you are using only one dimension.</span></span><br><span class="line">            dimension <span class="string">"version"</span></span><br><span class="line">            applicationIdSuffix <span class="string">".demo"</span></span><br><span class="line">            versionNameSuffix <span class="string">"-demo"</span></span><br><span class="line">        &#125;</span><br><span class="line">        full &#123;</span><br><span class="line">            dimension <span class="string">"version"</span></span><br><span class="line">            applicationIdSuffix <span class="string">".full"</span></span><br><span class="line">            versionNameSuffix <span class="string">"-full"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build Variants<br>  A build variant is a cross product of a build type and product flavor, and is the configuration Gradle uses to build your app. Using build variant , you can build the debug version of your product flavors during development, or signed release versions of your product flavors for distribution. Although you do not configure build variants directly, you do configure the build types and product flavors that form them. Creating additional build types or product flavors also creates additional build variants. To learn how to create and manage build variants, read the <a href="https://developer.android.com/studio/build/build-variants.html" target="_blank" rel="noopener">Configure Build Variant</a> overview. (Build Variant是build type和product flavor的结合体， 你只能通过更改build type和product flavor来更改build variant， 而不能直接更改。 比如debugPaid, debugFree, releasePaid, releaesFree等这种)</p>
</li>
<li><p>Manifest Entries<br>  You can specify values for some properties of the manifest file in the build variant configuration. These build values override the existing values in the mainfest file . This is useful if you want to generate multiple APKs for your modules where each of the apk files has a differernt application name, minimum SDK version, or target SDK version. When multiple manifests are present, Gradle <a href="https://developer.android.com/studio/build/manifest-merge.html" target="_blank" rel="noopener">merge manifest settings</a>. (你可以在build variant里指定manifest文件的一些配置, 这些配置会覆盖AndroidManifest.xml里的配置。 这对你同一套代码编译多个APK很有用, 不同APK可以有不同的名字, minimumSDK, targetSDk等等。 当多个manifest存在的时候， Gradle会按照链接的规则去merge)</p>
</li>
<li><p>Dependencies<br>  The build system manages project dependencies from your local filesystem and from remote repositories. This prevents you from having to manually search , download, and copy binary packages of your dependencies into your project directory. To find out more , see <a href="https://developer.android.com/studio/build/dependencies.html" target="_blank" rel="noopener">Add build Dependencies</a>. (编译系统通过gradle来管理你的各种依赖包括本地或者远程，而不用你手动去下载)</p>
</li>
<li><p>Signing<br>  The build system enables you to sepecify signing settings in the build configuration, and it can automatically sign your APKs during the build process. The build system signs the debug version with a default key and certificate using known credentials to avoid a password prompt at build time. The build system does not sign the release version unless you explicitly define a signing configuration for this build . If you do not have a release key, you can generate one as described in <a href="https://developer.android.com/studio/publish/app-signing.html" target="_blank" rel="noopener">Sign Your App</a>. (在build configuration里，你也可以配置签名相关东西.)</p>
</li>
<li><p>ProGuard<br>  The build system enables you to specify a different <a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">ProGurad</a> rules file for each build variant. The build system can run ProGurad to shrink and obfuscate your classes during the build process. (编译系统允许你针对不同的渠道指定不同的ProGuard文件, 在编译的过程中运行ProGurad来优化代码.)</p>
</li>
<li><p>Multiple APK Supporting<br>  The build system enables you to automatically build different APKs that each contain only the code and resources needed for a specific screen density or Application Binary Interface(ABI). For more information see <a href="https://developer.android.com/studio/build/configure-apk-splits.html" target="_blank" rel="noopener">Build multiple APKS</a>. (编译系统允许你可以编译出只包含适配特定屏幕的代码和资源的APK, 或者编出ABI. 详见链接)</p>
</li>
</ul>
<h2 id="Build-configuration-files"><a href="#Build-configuration-files" class="headerlink" title="Build configuration files"></a>Build configuration files</h2><p>Creating custom build configurations requires you to make changes to one or more build configuration files, or <code>build.gradle</code> files. These plain text files use Domain Specific Language(DSL) to describe and manipulate the build logic using <a href="http://groovy-lang.org/" target="_blank" rel="noopener">Groovy</a>, which is a dynamic language for the Java Virtual Machine (JVM). You don’t need to know Groovy to start configuring your build because the Android plugin for Gradle introduces most of the DSL elements you need. To learn more about the Android plugin DSL, read the <a href="http://google.github.io/android-gradle-dsl/current/index.html" target="_blank" rel="noopener">DSL reference documentation</a>.</p>
<p>When starting a new project, Android Studio automatically creates some of these files for you, as shown below, and polulates them based on sensible defaults.</p>
<p><img src="https://developer.android.com/images/tools/studio/project-structure_2x.png" alt></p>
<p>There are a few Gradle build configuration files that are a part of the standard project structure for an Android app. Before you can start configuring your build , it is important to understand the scope and purpose of each of these files, and the basic DSL elements they should define.</p>
<h3 id="The-Gradle-settings-file"><a href="#The-Gradle-settings-file" class="headerlink" title="The Gradle settings file"></a>The Gradle settings file</h3><p>The <code>settings.gradle</code> file, located in the root project project directory, tells Gradle which modules it should include when building your app. For most projects, the file is simple and only includes the following:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incldue  : `app`</span><br></pre></td></tr></table></figure>

<p>However, multi-module projects need to specify each module that should go into the final build.<br>(settings.gradle 告诉编译器，那些module会被编译进来)</p>
<h3 id="The-top-level-build-file"><a href="#The-top-level-build-file" class="headerlink" title="The top-level build file"></a>The top-level build file</h3><p>The top-level <code>build.gradle</code> file , located in the root project directory , defines configurations that apply to all modules in your project. By default, the top-level build file uses the <code>buildscript</code> block to define the Gradle repositories and dependencies that are common to all modules in the project. The following code sample describes the default settings and DSL elements you can find in the top-level <code>build.gradle</code> after creating a new project.</p>
<p>(根目录下的<code>build.gradle</code>文件，定义了所有module都用到的配置, 它用<code>buildscript</code>块定义Gradle仓库和依赖. e.g)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The buildscript block is where you configure the repositories and</span></span><br><span class="line"><span class="comment">* dependencies for Gradle itself—meaning, you should not include dependencies</span></span><br><span class="line"><span class="comment">* for your modules here. For example, this block includes the Android plugin for</span></span><br><span class="line"><span class="comment">* Gradle as a dependency because it provides the additional instructions Gradle</span></span><br><span class="line"><span class="comment">* needs to build Android app modules.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The repositories block configures the repositories Gradle uses to</span></span><br><span class="line"><span class="comment">    * search or download the dependencies. Gradle pre-configures support for remote</span></span><br><span class="line"><span class="comment">    * repositories such as JCenter, Maven Central, and Ivy. You can also use local</span></span><br><span class="line"><span class="comment">     * repositories or define your own remote repositories. The code below defines</span></span><br><span class="line"><span class="comment">    * JCenter as the repository Gradle should use to look for its dependencies.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * New projects created using Android Studio 3.0 and higher also include</span></span><br><span class="line"><span class="comment">    * Google's Maven repository.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The dependencies block configures the dependencies Gradle needs to use</span></span><br><span class="line"><span class="comment">     * to build your project. The following line adds Android plugin for Gradle</span></span><br><span class="line"><span class="comment">    * version 3.4.1 as a classpath dependency.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:3.4.1'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The allprojects block is where you configure the repositories and</span></span><br><span class="line"><span class="comment">* dependencies used by all modules in your project, such as third-party plugins</span></span><br><span class="line"><span class="comment">* or libraries. However, you should configure module-specific dependencies in</span></span><br><span class="line"><span class="comment">* each module-level build.gradle file. For new projects, Android Studio</span></span><br><span class="line"><span class="comment">* includes JCenter and Google's Maven repository by default, but it does not</span></span><br><span class="line"><span class="comment">* configure any dependencies (unless you select a template that requires some).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(buildscripts.repositories和allprojects.repositories里的区别?  buildscript里是gradle脚本执行所需依赖，分别是对应的maven库和插件. allprojects里是项目本身需要的依赖，比如我现在要依赖我自己maven库的toastutils库，那么我应该将maven {url ‘<a href="https://dl.bigit" target="_blank" rel="noopener">https://dl.bigit</a> ntray.com/calvinning/maven‘}写在这里，而不是buildscript 中,不然找不到。)</p>
<h4 id="Configure-project-wide-properties"><a href="#Configure-project-wide-properties" class="headerlink" title="Configure project-wide properties"></a>Configure project-wide properties</h4><p>For Android projects that include multiple modules, it may be useful to define certain properties at the project level and share them across all the modules. You can do this by adding <a href>extra properties</a> to the <code>ext</code> block in the top-level <code>build.gradle</code> file.<br>(你可以在根目录下的<code>build.gradle</code>里配置<code>ext</code>选项，让所有<code>module</code>都可以引用到)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;...&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;...&#125;</span><br><span class="line"></span><br><span class="line">// This block encapsulates custom properties and makes them available to all</span><br><span class="line">// modules in the project.</span><br><span class="line">ext &#123;</span><br><span class="line">    // The following are only a few examples of the types of properties you can define.</span><br><span class="line">    compileSdkVersion = 28</span><br><span class="line">    // You can also create properties to specify versions for dependencies.</span><br><span class="line">    // Having consistent versions between modules can avoid conflicts with behavior.</span><br><span class="line">    supportLibVersion = "28.0.0"</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>To access these properties from a module in the same project, use the following syntax in the modules’s <code>build.gradle</code> file(you can learn more about this file in the section below).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    // Use the following syntax to access properties you defined at the project level:</span><br><span class="line">    // rootProject.ext.property_name</span><br><span class="line">    compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation "com.android.support:appcompat-v7:$&#123;rootProject.ext.supportLibVersion&#125;"</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="The-module-level-build-file"><a href="#The-module-level-build-file" class="headerlink" title="The module-level build file"></a>The module-level build file</h3><p>The module-level <code>build.gradle</code> file, located in each <code>project/module</code> directory, allows you to configure build settings for the sepcific module it is located in. Configuring these build settings allows you to provide custom packaging options, such as additional build types and product flavors, and override settings in the <code>main/</code> app manifest or top-level <code>build.gradle</code>. (你可以在每个module下的<code>build.gradle</code>自己定义一些参数，这些会覆盖根目录下的<code>build.gradle</code>)</p>
<p>This sample Android app module <code>build.gradle</code> file outlines some of the basic DSL elements and settings that you should know.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">    /**</span><br><span class="line">    * The first line in the build configuration applies the Android plugin for</span><br><span class="line">    * Gradle to this build and makes the android block available to specify</span><br><span class="line">    * Android-specific build options.</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    apply plugin: 'com.android.application'</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * The android block is where you configure all your Android-specific</span><br><span class="line">    * build options.</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    android &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * compileSdkVersion specifies the Android API level Gradle should use to</span><br><span class="line">    * compile your app. This means your app can use the API features included in</span><br><span class="line">    * this API level and lower.</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    compileSdkVersion 28</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * buildToolsVersion specifies the version of the SDK build tools, command-line</span><br><span class="line">    * utilities, and compiler that Gradle should use to build your app. You need to</span><br><span class="line">    * download the build tools using the SDK Manager.</span><br><span class="line">    *</span><br><span class="line">    * This property is optional because the plugin uses a recommended version of</span><br><span class="line">    * the build tools by default.</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    buildToolsVersion "29.0.0"</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * The defaultConfig block encapsulates default settings and entries for all</span><br><span class="line">    * build variants, and can override some attributes in main/AndroidManifest.xml</span><br><span class="line">    * dynamically from the build system. You can configure product flavors to override</span><br><span class="line">    * these values for different versions of your app.</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * applicationId uniquely identifies the package for publishing.</span><br><span class="line">     * However, your source code should still reference the package name</span><br><span class="line">     * defined by the package attribute in the main/AndroidManifest.xml file.</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    applicationId 'com.example.myapp'</span><br><span class="line"></span><br><span class="line">    // Defines the minimum API level required to run the app.</span><br><span class="line">    minSdkVersion 15</span><br><span class="line"></span><br><span class="line">    // Specifies the API level used to test the app.</span><br><span class="line">    targetSdkVersion 28</span><br><span class="line"></span><br><span class="line">    // Defines the version number of your app.</span><br><span class="line">    versionCode 1</span><br><span class="line"></span><br><span class="line">    // Defines a user-friendly version name for your app.</span><br><span class="line">    versionName "1.0"</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * The buildTypes block is where you can configure multiple build types.</span><br><span class="line">   * By default, the build system defines two build types: debug and release. The</span><br><span class="line">   * debug build type is not explicitly shown in the default build configuration,</span><br><span class="line">   * but it includes debugging tools and is signed with the debug key. The release</span><br><span class="line">   * build type applies Proguard settings and is not signed by default.</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  buildTypes &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * By default, Android Studio configures the release build type to enable code</span><br><span class="line">     * shrinking, using minifyEnabled, and specifies the Proguard settings file.</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled true // Enables code shrinking for the release build type.</span><br><span class="line">        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * The productFlavors block is where you can configure multiple product flavors.</span><br><span class="line">   * This allows you to create different versions of your app that can</span><br><span class="line">   * override the defaultConfig block with their own settings. Product flavors</span><br><span class="line">   * are optional, and the build system does not create them by default.</span><br><span class="line">   *</span><br><span class="line">   * This example creates a free and paid product flavor. Each product flavor</span><br><span class="line">   * then specifies its own application ID, so that they can exist on the Google</span><br><span class="line">   * Play Store, or an Android device, simultaneously.</span><br><span class="line">   *</span><br><span class="line">   * If you declare product flavors, you must also declare flavor dimensions</span><br><span class="line">   * and assign each flavor to a flavor dimension.</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  flavorDimensions "tier"</span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    free &#123;</span><br><span class="line">      dimension "tier"</span><br><span class="line">      applicationId 'com.example.myapp.free'</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paid &#123;</span><br><span class="line">      dimension "tier"</span><br><span class="line">      applicationId 'com.example.myapp.paid'</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * The splits block is where you can configure different APK builds that</span><br><span class="line">   * each contain only code and resources for a supported screen density or</span><br><span class="line">   * ABI. You'll also need to configure your build so that each APK has a</span><br><span class="line">   * different versionCode.</span><br><span class="line">   */</span><br><span class="line"></span><br><span class="line">  splits &#123;</span><br><span class="line">    // Settings to build multiple APKs based on screen density.</span><br><span class="line">    density &#123;</span><br><span class="line"></span><br><span class="line">      // Enable or disable building multiple APKs.</span><br><span class="line">      enable false</span><br><span class="line"></span><br><span class="line">      // Exclude these densities when building multiple APKs.</span><br><span class="line">      exclude "ldpi", "tvdpi", "xxxhdpi", "400dpi", "560dpi"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The dependencies block in the module-level build configuration file</span><br><span class="line"> * specifies dependencies required to build only the module itself.</span><br><span class="line"> * To learn more, go to Add build dependencies.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation project(":lib")</span><br><span class="line">    implementation 'com.android.support:appcompat-v7:28.0.0'</span><br><span class="line">    implementation fileTree(dir: 'libs', include: ['*.jar'])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Gradle-properties-files"><a href="#Gradle-properties-files" class="headerlink" title="Gradle properties files"></a>Gradle properties files</h3><p>Gradle also includes two properties files, located in your root project directory, that you can use to specify settings for the Gradle build toolkit itself:</p>
<ul>
<li>gradle.properties<br>  This is where you can configure project-wide Gradle settings, such as the Gradle daemon’s maximum heap size. For more information , see <a href="https://docs.gradle.org/current/userguide/build_environment.html" target="_blank" rel="noopener">The Build Envirnment</a></li>
<li>local.properties<br>  Configures local environment properties for the build system, such as the path to the SDK installation. Beacuse the content of this file is automatically generated by Android Studio and is specific to the lcoal developer environment, you should not modify this file manually or check it into your version control system.</li>
</ul>
<h3 id="Synciing-project-with-Gradle-files"><a href="#Synciing-project-with-Gradle-files" class="headerlink" title="Synciing project with Gradle files"></a>Synciing project with Gradle files</h3><p>When you make changes to the build configuration files in your project, Android Studio requires that you sync your project files so that it can import your biuld configuration changes and run some checks to make sure your configuration won’t create build errors.</p>
<p>To sync your project files, click Sync Now in the notification bar that appears when you make a change, as shown in figure 3, or click Sync Project  from the menu bar. If Android Studio notices any errors with your configuration, for example, your source code uses API features that are only available in an API level higher than your compileSdkVersion, the Messages window appears to describe the issue.</p>
<p><img src="https://developer.android.com/images/tools/as-gradlesync.png" alt></p>
<h3 id="Source-sets"><a href="#Source-sets" class="headerlink" title="Source sets"></a>Source sets</h3><p>Android Studio logically groups source code and resources for each module into source sets. A module’s <code>main/</code> source set includes the code and resources used by all its build variant. Additional source set directories are optional, and Android Studio does not automatically create them for you when you configure new build variants. However, creating source sets, similar to <code>main/</code>, helps organize files and resources that Gradle should only use when building certain version of your app:</p>
<ul>
<li>src/main/<br>  This source set includes code and resources common to all build variants. (这个目录下的代码和资源，所有的build variants都可以用到)</li>
<li>src/buildType/<br>  Create this source set to include code and resources only for a specific build type. (存放特定build type用到的资源和代码)</li>
<li>src/productFlavor/<br>  Create this source set to include code and resource only for a specific product flavor. (存放特定的product flavor用到的资源和代码)</li>
<li>src/productFlavorBuildType<br>  Create this source set to include code and resources only for a specific build variant. (存放特定build variant用到的资源和代码)</li>
</ul>
<p>For example, to generate the “fullDebug” version of your app, the build system merges code, settings, and resources from following source sets:</p>
<pre><code>* src/fullDebug(the build variant source set)
* src/debug(the build type source set)
* src/full (the product flavor source set)
* src/main (the main source set)</code></pre><p>If different source sets contain different versions of the same file, Gradle uses the following priority order when deciding which file to use (source sets on the left override the files and settings of source sets to the right):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//左边的代码资源会覆盖右边的代码和资源</span><br><span class="line">build variant &gt; build type &gt; product flavor &gt; main source set &gt; library dependencies</span><br></pre></td></tr></table></figure>

<p>This allows Gradle to use files that are specific to the build variant you are trying to build while reusing activities, application logic, and resources that are common to other versions of your app. When <a href="https://developer.android.com/studio/build/manifest-merge.html" target="_blank" rel="noopener">merging multiple manifests</a>, Gradle uses the same priority order, so each build variant can define different components or permissions in the final manifest. To learn more about creating custom source sets, go to <a href="https://developer.android.com/studio/build/build-variants.html#sourcesets" target="_blank" rel="noopener">Create Source Sets for Build Variants</a>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/f8021ed8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/f8021ed8/" itemprop="url">Translation-Reduce your app size</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-28T15:09:48+08:00">
                2019-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/f8021ed8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/f8021ed8/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Reduce-your-app-size"><a href="#Reduce-your-app-size" class="headerlink" title="Reduce your app size"></a>Reduce your app size</h1><p>Users often avoid downloading apps that seem too large, particularly in emerging markets where devices connect to often-spotty 2G and 3G networks or work on pay-by-the-byte plans. This page describes how to reduce yoru app’s download size, which enables more users to download your app.</p>
<p>(有些地方使用2G/3G或者需要按流量付费的地方，会不愿意去下载太大的程序。 本文讲告诉你如何减少app大小.)</p>
<h2 id="Upload-yoru-app-with-Android-App-Bundles"><a href="#Upload-yoru-app-with-Android-App-Bundles" class="headerlink" title="Upload yoru app with Android App Bundles"></a>Upload yoru app with Android App Bundles</h2><p>The easiest way to gain immediate app size savings when publishing to Google Play is by uploading your app as an <a href="https://developer.android.com/guide/app-bundle" target="_blank" rel="noopener">Android App Bundle</a>, which is a new upload format that includes all your app’s compiled code and resources, but defers APK generation and signing to Google Play.</p>
<p>Google Play’s new app serving model, called Dynamic Delivery, then uses your app bundle to generate and serve optimized APKs for each user’s device configuration, so they download only the code and resources they need to run your app. You no longer have to build, sign, and manage multiple APKs to support different devices, and users get smaller, more optimized downloads</p>
<p>Keep in mind, because Google Play enforces a <a href="https://developer.android.com/guide/app-bundle#size_restrictions" target="_blank" rel="noopener">compressed downloaded size restriction</a> of 150MB or less for apps published with app bundles, it’s still a good idea to apply the guidelines described on this to reduce your app’s download size as much as possible.</p>
<p>(这里介绍了使用Android App Bundles方式，是最简单快速的压缩体积的方式，具体实现细节需要参考<a href="https://developer.android.com/guide/app-bundle" target="_blank" rel="noopener">Android App Bundle</a>)</p>
<h2 id="Use-the-Android-Size-Analyzer"><a href="#Use-the-Android-Size-Analyzer" class="headerlink" title="Use the Android Size Analyzer"></a>Use the Android Size Analyzer</h2><p>The Android Size Analyzer tool is an easy way to identify and implement many strategies for reducing the size of your app. It is available as both an Android Studio plugin as well as a standalone JAR.</p>
<p>(Android Size Analyzer，这个工具里面包含了很多减少App体积的方法，你可以通过Android Studio或jar来使用它。)</p>
<h3 id="Use-the-analyzer-in-Android-Studio"><a href="#Use-the-analyzer-in-Android-Studio" class="headerlink" title="Use the analyzer in Android Studio"></a>Use the analyzer in Android Studio</h3><p>You can download the Android Size Analyzer plugin using the plugin marketplace in Android Studio, as shown in figure 1. To open the plugin marketplace and install the plugin, proceed as follows:</p>
<ol>
<li>Select File &gt; Settings (or on Mac, Android Studio &gt; Preferences.)</li>
<li>Select the Plugins section in the left panel</li>
<li>Click the marketplace tab</li>
<li>Search for the “Android Size Analyzer” plugin.</li>
<li>Click the Install button for the analyzer plugin.</li>
</ol>
<p><img src="https://developer.android.com/topic/performance/images/plugin-marketplace.png" alt="img"></p>
<p>After you install the plugin, run a app size analysis on your current project by selecting Analyze &gt; Analyze App Size from the menu bar. After analyzing your project, a tool window appears with recommendations on how to reduce the size of your app, as shown in figure 2.</p>
<p><img src="https://developer.android.com/topic/performance/images/plugin-recommendations.png" alt="img"></p>
<p>(安装Android Size Analyzer插件, Mac下Android Studio &gt; Preferenes &gt; Plugin &gt; marketplace &gt; Android Size Analyzer, 安装完后Android Studio可能会重启, 然后在当前工程下选择 Analyze &gt; Analyze App Size执行分析…但是我试了几次，都会报错，不知道为什么)</p>
<h3 id="Use-the-analyzer-from-the-command-line"><a href="#Use-the-analyzer-from-the-command-line" class="headerlink" title="Use the analyzer from the command line"></a>Use the analyzer from the command line</h3><p>You can download the latest version of the Android Size Analyzer, either as a TAR or ZIP file, from <a href="https://github.com/android/size-analyzer/releases/latest" target="_blank" rel="noopener">Github</a>. After extracting the archive, run the size-analyzer script(on Linux or MacOS) or the size-analyzer.bat script(on Windows) on your Android project or Android App Bundle using one of the following commands:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./size-analyzer check-bundle &lt;path-to-aab&gt;</span><br><span class="line">./size-analyzer check-project &lt;path-to-project-directory&gt;</span><br></pre></td></tr></table></figure>

<p>(在<a href="https://github.com/android/size-analyzer/releases/latest" target="_blank" rel="noopener">Github</a>上下载Android Size Analyzer脚本，然后执行上述命令也是可以的)</p>
<h2 id="Understand-the-APK-structure"><a href="#Understand-the-APK-structure" class="headerlink" title="Understand the APK structure"></a>Understand the APK structure</h2><p>Before discussing how to reduce the size of your app, it’s helpful to understand the structure of an app’s APK. An APK file consists of a ZIP archive that contains all hte files that comprise your app. These files include Java class files, resource files, and a file containing compiled resources.</p>
<p>An APK contains the following directories:</p>
<p>(APK就是一个压缩包，下面介绍下它的组成: )</p>
<ul>
<li>META-INFO /: Contains the CERF.SF and CERT.RSA signature iles, as well as the MANIFEST.MF manifest file. (包含CERF.SF, CERT.RSA签名文件和MANIFEST.MF文件)</li>
<li>assets/ : Contains the app’s assets, which the app can retrieve using an [AssetManager][<a href="https://developer.android.com/reference/android/content/res/AssetManager.html]" target="_blank" rel="noopener">https://developer.android.com/reference/android/content/res/AssetManager.html]</a> object. (包含app的资源，也就是AssetManager可以获取到的资源)</li>
<li>res/ : Contains resources that aren’t compiled into resources.arsc (编译不进resources.arsc里的剩余res)</li>
<li>lib/ : contains the compiled code that is specific to the software layer of a processor. This directory contains a subdirectory for each platform type, like armeabi, armeabi-v7a, arm64-v8a, x86, x86_64 and mips. (编译的.so这些文件，里面的子文件夹分各个架构)</li>
</ul>
<p>An Apk also contains the following files. Among them, only <code>AndroidManifest.xml</code> is mandatory. (APK还包含以下文件，除了AndroidManifest.xml之外，其他都不是必须的。)</p>
<ul>
<li>resoures.arsc: Contains compiled resources. This file contains the XML content from all configurations of the res/value/ folder. The packaging tool extracts this XML content, compiles it to binary form, and archives the content. This content includes language strings and styles, as well as paths to content that is not included directly in the resources.arsc file, such as layout files and images. (编译后的资源文件, 包含res/value/文件夹下所有配置的xml内容。packaging tool把这些内容编译为二进制格式， 还包含language strings, styles, 和没有编译进resources.arsc文件的布局和图片文件的路径)</li>
<li>classes.dex: Contains the classes compiled in the DEX file format understood by the Dalvik/ART virtual machine. (包含编译进DEX文件的类文件，DEX文件是可以被Dalvik/ART虚拟机识别的文件类型)</li>
<li>AndroidManifest.xml: Contains the core Android manifest file. This file lists the name, version, access rights, and referenced library files of the app. The file uses Android’s binary XML format. (包含AndroidManifest.xml文件)</li>
</ul>
<h2 id="Reduce-resource-count-and-size"><a href="#Reduce-resource-count-and-size" class="headerlink" title="Reduce resource count and size"></a>Reduce resource count and size</h2><p>The size of your APK has an impact on how fast your app loads, how much memory it uses, and how much power it consumes. One of thesimple ways to make your APK smaller is to reduce the number and size of the resources it contains. In particular, you can remove resources that your app no longer uses, and you can use scalable <code>Drawable</code> objects in place of image files. This section discusses these methods as well as several other ways that you can reduce the resources in your app to decrease the overall size of your APK.<br>(APK体积越大， 启动速度越慢，内存占用越大，电量消耗越多. 一个简单的办法就是减少app里使用到的资源，尤其是不再使用到的，或者使用drawable替代图片文件等。 这章将会讨论为了减少app的大小还可以通过哪些方法来减少资源的大小.)</p>
<h3 id="Remove-unused-resources"><a href="#Remove-unused-resources" class="headerlink" title="Remove unused resources"></a>Remove unused resources</h3><p>The <a href="https://developer.android.com/studio/write/lint.html" target="_blank" rel="noopener">lint</a> tool, a static code analyzer included in Android Studio, detects resources in your res/ folder that your code doesn’t reference. When the <code>lint</code> tool discovers a potentially unused resource in your project, it prints a message like the following example. (<a href="https://developer.android.com/studio/write/lint.html" target="_blank" rel="noopener">lint</a>静态代码分析工具，可以检测res/文件夹下所有代码没有引用到的资源。)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res/layout/preferences.xml: Warning: The resource R.layout.preferences appears</span><br><span class="line">to be unused [UnusedResources]</span><br></pre></td></tr></table></figure>

<p>Libraries that you add to your code may include unused resources. Gradle can automatically remove resources on your behalf if you enable <a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">shrinkResources</a> in your app’s <code>build.gradle</code> file. (gradle可以通过在<code>build.gradle</code>里设置<a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">shrinkResources</a>来自动移除无用的资源文件).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    android &#123;</span><br><span class="line">    <span class="comment">// Other settings</span></span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            shrinkResources <span class="keyword">true</span></span><br><span class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>To use <code>shrinkResources</code>, you must enable code shrinking. During the build process, first <a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">ProGuard</a> removes unused code but leaves unused resources. Then Gradle removes the unused resources.  (为了使用<code>shrinkResources</code>, 你必须先要允许code shrinking. 在编译期， <a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">ProGuard</a> 会把未用到的code给移除，但是resource没有移除，而是留给Gradle去移除没用到的资源)</p>
<p>For more information about ProGuard and other way Android Studio helps you reduce APK size, see <a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="noopener">Shrink Your Code and Resources</a> </p>
<p>In Android Gradle Plugin 0.7 and higher, you can declare the configurations that your app supports. Gradle passes this information to the build system using the <code>resConfig</code> and <code>resConfigs</code> flavors and the <code>defaultConfig</code> option. The build system then prevents resources from other, unsupported configurations from appearing in the APK, reducing the APK’s size. For more information about this feature, see <a href="https://developer.android.com/studio/build/shrink-code.html#unused-alt-resources" target="_blank" rel="noopener">Remove unused alternative resources</a>  (在Android Gradle Plugin 0.7及以上，你可以定义app支持的配置, 通过<code>resConfig</code>和<code>resConfigs</code>以及<code>defaultConfig</code>。 编译系统会把这配置里以外的资源去掉，不参与编译, 从而减少size)</p>
<h3 id="Minimize-resource-use-from-libraries"><a href="#Minimize-resource-use-from-libraries" class="headerlink" title="Minimize resource use from libraries"></a>Minimize resource use from libraries</h3><p>When developing an Android app, you usually use external libraries to improve your app’s usability and versatility. For example, you might reference the <a href="https://developer.android.com/topic/libraries/support-library/index.html" target="_blank" rel="noopener">Android Support Library</a> to improve the user experience on older devices, or you could use <a href="https://developers.google.com/android/guides/overview" target="_blank" rel="noopener">Google Play Services</a> to retrieve automatic translations for text within your app.</p>
<p>If a library was designed for a server or desktop, it can include many objects and methods that your app doesn’t need. To include only the parts of the library that your app needs, you can edit the library’s files if the license allows you to modify the library. You can also use an alternative, mobile-friendly library to add specific functionality to your app.</p>
<p>(如果你的app引用了其他三方库，你可以要么自己修改源码来减少些没用的代码， 或者可以使用三方库的mobile版本)</p>
<h3 id="Support-only-specific-densities"><a href="#Support-only-specific-densities" class="headerlink" title="Support only specific densities"></a>Support only specific densities</h3><p>Android supports a very large set of devices, encompassing a variety of screen densities. In Android 4.4 and higher, the framework supports various densities: ldpi, mdpi, tvdpi, hdpi, xhdpi, xxhdpi, and xxxhdpi. Although Android supports all these densities, you don’t need to export your rasterized assets to each density. </p>
<p>If you know that only a small percentage of your users have devices with specific densities, consider whether you need to bundle those densities into your app. If you don’t include resources for a specific screen density, Android automatically scales existing resources originally designed for other screen densities.</p>
<p>If your app needs only scaled images, you can save even more space by having a single variant of an image in drawable-nodpi/. We recommend that every app include at least an xxhdpi image variant.</p>
<p>For more information screen densities, see <a href="https://developer.android.com/about/dashboards/index.html#Screens" target="_blank" rel="noopener">Screen Sizes and Densities</a></p>
<p>(没必要适配所有density的设备, 如果只有很少部分的用户有某一种density的设备，那么就可以考虑不去适配这个density.)</p>
<h3 id="Use-drawable-objects"><a href="#Use-drawable-objects" class="headerlink" title="Use drawable objects"></a>Use drawable objects</h3><p>Some iamge don’t require a static image resource; the framework can dynamically draw the image at runtime instead. <code>Drawable</code> object(<shape> in xml) can take up a tiny amount of space in your APK. In addition, XML <code>Drawable</code> objects produce monochromatic images compliant with material design guideline. (不知道啥意思，大概就是能用drawable就不要用图片)</shape></p>
<h3 id="Reuse-resources"><a href="#Reuse-resources" class="headerlink" title="Reuse resources"></a>Reuse resources</h3><p>You can include a separate resource for variations of an image, such as tinted, shaded, or rotated version of the same image. We recommend, however, that you reuse the same set of resources, customizing them as needed at runtime.</p>
<p>Android provides several utilities to change the color of an asset, either using the <code>android:tint</code> and <code>tintMode</code> attributes on Android 5.0 and higher. For lower versions of the platform, use the <code>ColorFilter</code> class.</p>
<p>You can also omit resources that are only a rotated equivalent of another resource. The following code snippet provides an example of turning a “tumb up” into a “thumb down” by pivoting at the middle of the image and rotating it 180 degrees:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rotate</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:drawable</span>=<span class="string">"@drawable/ic_thumb_up"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:pivotX</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:pivotY</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fromDegrees</span>=<span class="string">"180"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>(重用resource, 能通过tint, 旋转解决的，就不要新的资源)</p>
<h3 id="Render-from-code"><a href="#Render-from-code" class="headerlink" title="Render from code"></a>Render from code</h3><p>You can also reduce your APK size by procedurally rendering your images. Procedural rendering frees up space because you no longer store an image file in your APK.<br>(程序绘图，不用图片)</p>
<h3 id="Crunch-PNG-files"><a href="#Crunch-PNG-files" class="headerlink" title="Crunch PNG files"></a>Crunch PNG files</h3><p>The <code>aapt</code> tool can optimize the image resources placed in <code>res/drawable</code> with lossless compression during the build process. For example, the <code>aapt</code> tool can convert a true-color PNG that does not require more than 256 colors to a 8-bit PNG with a color palette. Doing so results in an image of equal quality but a smaller memory footprint.</p>
<p>Keep in mind that the <code>aapt</code> has the following limitations: </p>
<ul>
<li>The <code>aapt</code> tool does not shrink PNG files contained in the <code>asset/</code> folder</li>
<li>Image files need to use 256 or fewer colors for the <code>aapt</code> tool to optimize them</li>
<li>The <code>aapt</code> tool may inflate PNG files that have already been compressed. To prevent this, you can use the <code>cruncherEnabled</code> flag in Gradle to disable this process for PNG files;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aaptOptions &#123;</span><br><span class="line">    cruncherEnabled = <span class="keyword">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compress-PNG-and-JPEG-files"><a href="#Compress-PNG-and-JPEG-files" class="headerlink" title="Compress PNG and JPEG files"></a>Compress PNG and JPEG files</h3><p>You can reduce PNG file sizes without losing image quality using tools like <a href="http://pmt.sourceforge.net/pngcrush/" target="_blank" rel="noopener">pngcrush</a>, <a href="https://pngquant.org/" target="_blank" rel="noopener">pngquant</a>, or <a href="https://github.com/google/zopfli" target="_blank" rel="noopener">zopflipng</a>. All of these tools can reduce PNG file size while preserving the perceptive image quality. </p>
<p>The <code>pngcrush</code> tool is particularly effective: This tool iterates over PNG filters and zlib parameters, using each combination of filters and parameters to compress the image. It then clooses the configuration that yields the smallest compressed output .</p>
<p>To compress JPEG files, you can use tools like <a href="http://www.elektronik.htw-aalen.de/packjpg/" target="_blank" rel="noopener">packJPG</a> and <a href="https://github.com/google/guetzli" target="_blank" rel="noopener">guetzli</a></p>
<p>(压缩图片文件，可以用上述的几个工具)</p>
<h3 id="Use-WebP-file-format"><a href="#Use-WebP-file-format" class="headerlink" title="Use WebP file format"></a>Use WebP file format</h3><p>Instead of using PNG or JPEG files, you can also use the <a href="https://developers.google.com/speed/webp/" target="_blank" rel="noopener">WebP</a> file format for your images, when targeting Android 3.2(API level 13) and higher. The WebP format provides lossy compression(like JPEG) as well as transparency(like PNG) but can provide better compression than either JPEG or PNG.</p>
<p>You can convert existing BMP, JPG, PNG or static GIF images to WebP format using Android Studio. For more information, see <a href="https://developer.android.com/studio/write/convert-webp.html" target="_blank" rel="noopener">Creating WebP Images Using Android Studio</a></p>
<p>(你可以使用webp文件来替代PNG 或者 JPEG， webp支持JPEG的有损压缩和PNG的透明通道，而且压缩效率更高)</p>
<h3 id="Use-vector-graphics"><a href="#Use-vector-graphics" class="headerlink" title="Use vector graphics"></a>Use vector graphics</h3><p>You can use vector graphics to create resolution-independent icons and other scalable media. Using these graphics can greatly reduce your APK footprint. Vector images are represented in Android as <code>VectorDrawable</code> objects. With a <code>VectorDrawable</code> object, a 100-byte file can generate a sharp image the size of the screen.</p>
<p>However, it takes a significant amount of time for the system to render each <code>VectorDrawable</code> object, and larger images take even longer to appear on the screen. Therefore, consider using these vector graphics only when displaying small images.</p>
<p>For more information on working with <code>VectorDrawable</code> objects, see <a href="https://developer.android.com/training/material/drawables.html" target="_blank" rel="noopener">Working with Drawables</a><br>(你可以使用矢量图来表是图片，但是这种绘制起来很耗时而且占内存，因此，最好使用矢量图来展示小图片。)</p>
<h3 id="Use-vector-graphics-for-animated-images"><a href="#Use-vector-graphics-for-animated-images" class="headerlink" title="Use vector graphics for animated images"></a>Use vector graphics for animated images</h3><p>Do not use <code>AnimationDrawable</code> to create frame-by-frame animations because doing so requires that you include a separate bitmap file for each frame of the animation, which drastically increase the size of your APk.</p>
<p>Instead, you should use <code>AnimatedVectorDrawableCompat</code> to create <a href="https://developer.android.com/training/material/animations.html#AnimVector" target="_blank" rel="noopener">animated vector drawables</a>.
(不要使用<code>AnimationDrawable</code>来绘制帧动画，这需要很多的图片。 你应该用<code>AnimatedVectorDrawableCompact</code>)</p>
<h2 id="Reduce-native-and-Java-code"><a href="#Reduce-native-and-Java-code" class="headerlink" title="Reduce native and Java code"></a>Reduce native and Java code</h2><p>There are several methods you can use to reduce the size of the Java and natvie codebase in your app.</p>
<h3 id="Remove-unnecessary-generated-code"><a href="#Remove-unnecessary-generated-code" class="headerlink" title="Remove unnecessary generated code"></a>Remove unnecessary generated code</h3><p>Make sure to understand the footprint of any code which is automatically generated. For example, many protocal buffer tools generate an excessive number of methdods and classes, which can double or triple the size of your app.<br>(删除无用的代码)</p>
<h3 id="Avoid-enumerations"><a href="#Avoid-enumerations" class="headerlink" title="Avoid enumerations"></a>Avoid enumerations</h3><p>A single enum can add about 1.0 to 1.4KB of size to your app’s <code>classes.dex</code> file. These additions can quickly accumulate for complex systems or shared libraries. If possible, consider using the <code>@IntDef</code> annotation and <a href>ProGuard</a> to strip enumerations out and convert them to integers. This type conersion preserves all of the type safety benefits of enums.<br>(尽量使用<code>@IntDef</code>来替代Enum, 因为enum可以增加1.0-1.4KB的大小, 或者使用ProGuard来把Enum转换为integer)</p>
<h3 id="Reduce-the-size-of-native-binaries"><a href="#Reduce-the-size-of-native-binaries" class="headerlink" title="Reduce the size of native binaries"></a>Reduce the size of native binaries</h3><p>If your app uses native code and the Android NDK, you can also reduce the size of the release version of your app by optimizing your code. Two useful techniques are removing debug symbols and not extracting native libraries.</p>
<h4 id="Remove-debug-symbos"><a href="#Remove-debug-symbos" class="headerlink" title="Remove debug symbos"></a>Remove debug symbos</h4><p>Using debug symbols make sense if your application is in development and still requires debugging. Use the <code>armeabi-strip</code> tool, privided in the Android NDk, to remove unnecessary debug symbols from native libraries. After that, you can compile your release build.</p>
<h4 id="Avoid-extracting-native-libraries"><a href="#Avoid-extracting-native-libraries" class="headerlink" title="Avoid extracting native libraries"></a>Avoid extracting native libraries</h4><p>When building the release version of your app, package unucompressed <code>.so</code> files in the APK by setting <code>android:extractNativeLibs=&quot;false&quot;</code> in the <code>&lt;application&gt;</code> element of your app’s manifest. Disabling this flag prevents PackageManager from copying .so files from the APK to the filesystem during installation and has the added benefit of making updates of your app smaller.</p>
<h2 id="Maintain-multiple-lean-APKs"><a href="#Maintain-multiple-lean-APKs" class="headerlink" title="Maintain multiple lean APKs"></a>Maintain multiple lean APKs</h2><p>Your APK might contain content that users download but never use, like additional language or per-screen-density resources. To ensure a minimal download for your users, you should upload your app to Google Play using <a href="https://developer.android.com/topic/performance/reduce-apk-size#app_bundle" target="_blank" rel="noopener">Android App Bundles</a>. Uploading app bundles let’s Google Play generate and serve optimized APKs for each user’s device configuration, so they download only with the code and resources they need to run your app. You no longer have to build, sign, and manage multiple APKs to support different devices, and users get smaller, more optimized downloads.</p>
<p>If you’re not publishing your app to Google Play, you can segment your app into several APKs, differerntiated by factors such as screen size or GPU texture support.</p>
<p>When a user downloads your app, their device receives the correct APK based on the devices’s features and settings. This way devices don’t receive assets for features that the devices don’t have. For example, if a user has a <code>hdpi</code> device, they don’t need <code>xxxhdpi</code> resources that you might include for devices with higher density displays.</p>
<p>For more information, see <a href="https://developer.android.com/studio/build/configure-apk-splits.html" target="_blank" rel="noopener">configure APK Splits</a> and <a href="https://developer.android.com/training/multiple-apks/index.html" target="_blank" rel="noopener">Maintaining Multiple APKs</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/posts/a445691e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/a445691e/" itemprop="url">Android-IntentService的使用和原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-27T19:11:36+08:00">
                2019-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/a445691e/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/a445691e/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先要知道<code>IntentService</code>本质上是一个<code>Service</code>, 目的是可以像线程一样执行一些异步操作. </p>
<p>既然目的是为了执行异步操作，为什么不直接通过Thread或者AsyncTask这种来实现，而是继承自Service呢? </p>
<p>因为<code>Android</code>在面对使用<code>IntentService</code>的应用优先级会高些， 主动杀掉的可能性会降低点。</p>
<p>所以， <code>IntentService</code>就是结合了<code>Service</code>与线程的好处而来的一个工具类，分析代码可以很容易的看到:</p>
<p>首先从构造函数来看, 只是传了一个名字</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String mName;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IntentService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    mName = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后看Service的第一个回调方法. <code>onCreate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HandlerThread里面的Looper</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Looper mServiceLooper;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程中的Handler</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ServiceHandler mServiceHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//抽象方法，也是经常需要在次回调里做工作的地方</span></span><br><span class="line">        onHandleIntent((Intent)msg.obj);</span><br><span class="line">        <span class="comment">//执行完之后主动关闭自己</span></span><br><span class="line">        stopSelf(msg.arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    </span><br><span class="line">    HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"IntentService["</span> + mName + <span class="string">"]"</span>);</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    mServiceLooper = thread.getLooper();</span><br><span class="line">    mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里新建了一个<code>HandlerThread</code>, 以及一个子线程的<code>Handler</code>, <code>mServiceHandler</code>. 也就是这个<code>mServiceHandler</code>的回调也是在子线程. 也就是<code>IntentService</code>的原理就是<code>HandlerThread</code>.</p>
<p>然后不管是onStart或者onStartCommand， 都会执行这些方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId;</span><br><span class="line">    msg.obj = intent;</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    onStart(intent, startId);</span><br><span class="line">    <span class="keyword">return</span> mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们启动<code>IntentService</code>最好是通过<code>start</code>方法，而不是<code>bind</code>方法启动，就是为了触发<code>onStart()</code>回调. 这里就是把消息发送给<code>mServiceHandler</code>.</p>
<p>也就是，我们使用<code>startService</code>会触发<code>onStart</code> -&gt; <code>handle</code>收到消息 -&gt; 子线程里的<code>onHandleIntent</code>回调。 我们只要在这个回调里处理需要的逻辑就可以了。</p>
<p>这里补充下<code>startService</code>和<code>bindService</code>的区别:</p>
<p>TODO: <a href="https://www.jianshu.com/p/d870f99b675c" target="_blank" rel="noopener">https://www.jianshu.com/p/d870f99b675c</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ScorpioNeal</p>
              <p class="site-description motion-element" itemprop="description">体系(点 - 线 - 面)</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">219</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ScorpioNeal</span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Bp6gNEmnfgAF2Ci7moO9v4Rm-gzGzoHsz',
        appKey: 'xNstrbz0DRkVzIMvuDNrkAOh',
        placeholder: '要不要说点啥',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/js/src/dynamic_bg.js"></script>
  <script type="text/javascript" src="/js/src/love-click.js"></script>
</body>
</html>
