<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">

<script data-ad-client="ca-pub-3610947468348159" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="体系(点 - 线 - 面)">
<meta property="og:type" content="website">
<meta property="og:title" content="ScorpioNeal&#39;s Blog">
<meta property="og:url" content="http://www.scions.cn/page/3/index.html">
<meta property="og:site_name" content="ScorpioNeal&#39;s Blog">
<meta property="og:description" content="体系(点 - 线 - 面)">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ScorpioNeal&#39;s Blog">
<meta name="twitter:description" content="体系(点 - 线 - 面)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.scions.cn/page/3/">





  <title>ScorpioNeal's Blog</title>
  








  <link rel="stylesheet" href="/live2d/css/live2d.css">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
<div class="bg_content">
<canvas id="canvas"></canvas>
</div>
  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ScorpioNeal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            todo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/6e07d535/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/6e07d535/" itemprop="url">Android-PopupWindow源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-01T10:40:33+08:00">
                2020-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/6e07d535/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/6e07d535/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.jianshu.com/p/2386b314714c" target="_blank" rel="noopener">https://www.jianshu.com/p/2386b314714c</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/cbdad96c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/cbdad96c/" itemprop="url">Translation Dependency Injection - Using Dagger in Android apps</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-17T14:28:38+08:00">
                2020-01-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/cbdad96c/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/cbdad96c/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Using-Dagger-in-Android-apps"><a href="#Using-Dagger-in-Android-apps" class="headerlink" title="Using Dagger in Android apps"></a>Using Dagger in Android apps</h2><p>The <a href="https://developer.android.com/training/dependency-injection/dagger-basics" target="_blank" rel="noopener">Dagger basics</a> page explained how Dagger can help you automate dependency injection in your app. With Dagger, you don’t have to write tedious and error-prone boilerplate code.</p>
<h2 id="Best-practices-summary"><a href="#Best-practices-summary" class="headerlink" title="Best practices summary"></a>Best practices summary</h2><ul>
<li>Use constructor injection with <code>@Inject</code> to add types to the Dagger graph whenever it’s possible. When it’s not:<ul>
<li>Use <code>@Binds</code> to tell Dagger which implementation an interface should have</li>
<li>Use <code>@Provides</code> to tell Dagger how to provide classes that your project doesn’t own</li>
</ul>
</li>
<li>You should only declare modules once in a component</li>
<li>Name the scope annotations depending on the lifetime where the annotation is used. Example include <code>@ApplicationScope</code>, <code>@LoggedUserScope</code> and <code>@ActivityScope</code></li>
</ul>
<h2 id="Adding-dependencies"><a href="#Adding-dependencies" class="headerlink" title="Adding dependencies"></a>Adding dependencies</h2><p>To use Dagger in your project, add these dependencies to your application in your <code>build.gradle</code> file. You can find the latest version of Dagger <a href="https://github.com/google/dagger/releases" target="_blank" rel="noopener">in this Github project</a>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">'com.google.dagger:dagger:2.x'</span></span><br><span class="line">    annotationProcessor <span class="string">'com.google.dagger:dagger-compiler:2.x'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dagger-in-Android"><a href="#Dagger-in-Android" class="headerlink" title="Dagger in Android"></a>Dagger in Android</h2><p>Consider an example Android app with the dependency graph from Figure 1.</p>
<p><img src="https://developer.android.com/images/training/dependency-injection/4-application-graph.png" alt></p>
<p>In Android, you usually create a Dagger graph that lives in your application class because you want an instance of the graph to be in memory as long as the app is running. In this way, the graph is attached to the app lifecycle. In some cases, you might also want to have the application context available in the graph. For that, you would also need the graph to be in the application class. One advantage of this approach is that the graph is available to other Android framework classes. Additionally, it simplifies testing by allowing you to use a custom application class in tests.</p>
<p>Because the interface that generates the graph is annotated with <code>@Component</code>, you can call it <code>ApplicationComponent</code> or <code>ApplicationGraph</code>. You usually keep an instance of that component in your custom application class and call it every time you need the application graph, as shown in the following code snippet:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Definition of the Application graph</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationComponent</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// appComponent lives in the Application class to share its lifecycle</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reference to the application graph that is used across the whole app</span></span><br><span class="line">    ApplicationComponent appComponent = DaggerApplicationComponent.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because certain Android framework classes such as activities and fragments are instantiated by the system, Dagger can’t create them for you. For activities specifically, any initialization code needs to go into the <code>onCreate()</code> method. That means you cannot use the <code>@Inject</code> annotation in the constructor of the class(constructor injection) as you did in the previous example. Instead, you have to use field injection.</p>
<p>Instead of creating the dependencies an activity requires in the <code>onCreate()</code> method, you want Dagger to populate those dependencies for you. For field injection, you instead apply the <code>@Inject</code> annotation to the fields that you want to get from the Dagger graph.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// You want Dagger to provide an instance of LoginViewModel from the graph</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginViewModel loginViewModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For simplicity, <code>LoginViewModel</code> is not an <a href="https://developer.android.com/topic/libraries/architecture/viewmodel" target="_blank" rel="noopener">Android Architecture Components ViewModel</a>; it’s just a regular class that acts as a ViewModel. For more information about how to inject these classes, check out the code in the official <a href="https://github.com/android/architecture-samples/tree/dagger-android" target="_blank" rel="noopener">Android Blueprints Dagger</a> implementation.</p>
<p>One of the considerations with Dagger is that injected fields cannot be private. They need to have at least package-private visibility like in the preceding code.</p>
<h3 id="Injecting-activities"><a href="#Injecting-activities" class="headerlink" title="Injecting activities"></a>Injecting activities</h3><p>Dagger needs to know that <code>LoginActiity</code> has to access the graph in order to provide the <code>ViewModel</code> it requires. In the <a href="https://developer.android.com/training/dependency-injection/dagger-basics" target="_blank" rel="noopener">Dagger basics</a> page, you use the <code>@Component</code> interface to get objects from the graph by exposing functions with the return type of what you want to get from the graph. In this case, you need to tell Dagger about an object (<code>LoginActivity</code> in this case) that requires a dependency to be injected. For that, you expose a function that takes as a parameter the object that requests injection.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This tells Dagger that LoginActivity requests injection so the graph needs to</span></span><br><span class="line">    <span class="comment">// satisfy all the dependencies of the fields that LoginActivity is injecting.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(LoginActivity loginActivity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function tells Dagger that <code>LoginActivity</code> wants to access the graph and requests injection. Dagger needs to satisfy all the dependencies that <code>LoginActivity</code> requires(<code>LoginViewModel</code> with its own dependencies). If you have multiple classes that request injection, you have to specifically declare them all in the component with their exact type. For example, if you had <code>LoginActivity</code> and <code>RegistrationActivity</code> requesting injection, you’d have two <code>inject()</code> method instead of a generic one convering both cases. A generic <code>inject()</code> method doesn’t tell Dagger what needs to be provided. The functions in the interface can have any name, but calling them <code>inject()</code> when they receive the object to inject as a parameter is a convention in Dagger.</p>
<p>To inject an object in the activity, you’d use the <code>appComponent</code> defined in your application class and call the <code>inject()</code> method, passing in an instance of the activity that requests injection.</p>
<p>When using activities, inject Dagger in the activity’s <code>onCreate()</code> method before calling <code>super.onCreate()</code> to avoid issues with fragment restoration. During the restore phase in <code>super.onCreate()</code>, an activity attaches fragments that might want to access activity bindings.</p>
<p>When using fragments, inject Dagger in the fragment’s <code>onAttach()</code> method. In this case, it can be done before or after calling <code>super.onAttach()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// You want Dagger to provide an instance of LoginViewModel from the graph</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginViewModel loginViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Make Dagger instantiate @Inject fields in LoginActivity</span></span><br><span class="line">        ((MyApplication) getApplicationContext()).appComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// Now loginViewModel is available</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Inject tells Dagger how to create instances of LoginViewModel</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginViewModel</span><span class="params">(UserRepository userRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s tell Dagger how to provide the rest of the dependencies to build the graph:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLocalDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserLocalDataSource</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRemoteDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoginRetrofitService loginRetrofitService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRemoteDataSource</span><span class="params">(LoginRetrofitService loginRetrofitService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginRetrofitService = loginRetrofitService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dagger-modules"><a href="#Dagger-modules" class="headerlink" title="Dagger modules"></a>Dagger modules</h3><p>For this example, you’re using the <a href>Retrofit</a> networking library. <code>UserRemoteDataSource</code> has a dependency on <code>LoginRetrofitService</code>. However, the way to create an instance of <code>LoginRetrofitService</code> is different from what you’ve been doing until now. It’s not a class instantiation; it’s the result of calling <code>Retrofit.Builder()</code> and passing in different parameters to configure the login service.</p>
<p>Apart from the <code>@Inject</code> annotation, there’s another way to tell Dagger how to provide an instance of a class: the information inside Dagger modules. A Dagger module is a class that is annotated with <code>@Module</code>. There, you can define dependencies with the <code>@Provides</code> annotation.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// @Module informs Dagger that this class is a Dagger Module</span></span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Provides tell Dagger how to create instances of the type that this function</span></span><br><span class="line">    <span class="comment">// returns (i.e. LoginRetrofitService).</span></span><br><span class="line">    <span class="comment">// Function parameters are the dependencies of this type.</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginRetrofitService <span class="title">provideLoginRetrofitService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Whenever Dagger needs to provide an instance of type LoginRetrofitService,</span></span><br><span class="line">        <span class="comment">// this code (the one inside the @Provides method) is run.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .baseUrl(<span class="string">"https://example.com"</span>)</span><br><span class="line">                .build()</span><br><span class="line">                .create(LoginService.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Modules are a way to semantically encapsulate information on how to provide objects. As you can see, you called the class <code>NetworkModule</code> to group the logic of providing objects related to networking. If the application expands, you can also add how to provide an <a href>OKHttpClient</a> here, or how to configure <a href>Gson</a> or <a href>Moshi</a>.</p>
<p>The dependencies of a <code>@Provides</code> method are the parameters of that method. For the previous method, <code>LoginRetrofitService</code> can be provided with no dependencies because the method has no parameters. If you had declared an <code>OKHttpClient</code> as a parameter, Dagger would need to provide an <code>OKHttpClient</code> instance from the graph to satisfy the dependencies of <code>LoginRetrofitService</code>. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginRetrofitService <span class="title">provideLoginRetrofitService</span><span class="params">(OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In order for the Dagger graph to know about this module, you have to add it to the <code>@Component</code> interface as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// The "modules" attribute in the @Component annotation tells Dagger what Modules</span></span><br><span class="line"><span class="comment">// to include when building the graph</span></span><br><span class="line"><span class="meta">@Component</span>(modules = NetworkModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationComponent</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The recommended way to add types to the Dagger graph is by using constructor injection(i.e. with the <code>@Inject</code> annotation on the constructor of the class). Sometimes, this is not possible and you have to use Dagger modules. One example is when you want Dagger to use the result of a computation to determine how to create an instance of an object. Whenever it has to provide an instance of that type, Dagger runs the code inside the <code>@Provide</code> method. This is how the Dagger graph in the example looks right now:</p>
<p><img src="https://developer.android.com/images/training/dependency-injection/4-graph-login.png" alt></p>
<p>The entry point to the graph is <code>LoginActivity</code>. Because <code>LoginActivity</code> injects <code>LoginViewModel</code>, Dagger builds a graph that knows how to provide an instance of <code>LoginViewModel</code>, and recursively, of its dependencies. Dagger knows  how to do this because of the <code>@Inject</code> annotation on the classes’ constructor.</p>
<p>Inside the <code>ApplicationComponent</code> generated by Dagger, there’s a factory-type method to get instances of all classes it knows how to provide. In this example, Dagger delegates to the <code>NetworkModule</code> included in <code>ApplicationComponent</code> to get an instance of <code>LoginRetrofitService</code></p>
<h3 id="Dagger-scopes"><a href="#Dagger-scopes" class="headerlink" title="Dagger scopes"></a>Dagger scopes</h3><p>Scopes were mentioned on the <a href>Dagger basics</a> page as a way to have a unique instance of a type in component. This is what is meant by scoping a type to the component’s lifecycle.</p>
<p>Because you might want to use <code>UserRepository</code> in other features of the app and might not want to create a new object everytime you need it, you can designate it as a unique instance for the whole app. It is the same for <code>LoginRetrofitService</code>: it can be expensive to create, and you also want a unique instance of that object to be reused. Creating an instance of <code>UserRemoteDataSource</code> is not that expensive, so scoping it to the components’s lifecycle is not necessary.</p>
<p><a href>@Singleton</a> is the only scope annotation that comes with the <code>javax.inject</code> package. You can use it to annotte ‘ApplicationComponent` and the objects you want to reuse across the whole application.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(modules = NetworkModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(LoginActivity loginActivity)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginRetrofitService <span class="title">provideLoginRetrofitService</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Take care not to introduce memory leaks when applying scopes to objects. As long as the scoped component is in memory, the created object is in memory too. Because <code>ApplicationComponent</code> is created when the app is launched(in the application class), it is destroyed when the app gets destroyed. Thus, the unique instance of <code>UserRepository</code> always remains in memory until the application is destroyed.</p>
<h3 id="Dagger-subcomponents"><a href="#Dagger-subcomponents" class="headerlink" title="Dagger subcomponents"></a>Dagger subcomponents</h3><p>If you login flow (managed by a single <code>LoginActivity</code>) consists of multiple fragments, you should reuse the same instance of <code>LoginViewModel</code> in all fragments. <code>@Singleton</code> cannot annotate <code>LoginViewModel</code> to reuse the instance for the following reasons:</p>
<ol>
<li>The instance of <code>LoginViewModel</code> would persistent in memory after the flow has finished</li>
<li>You want a different  instance of <code>LoginViewModel</code> for each login flow. For example, if the user logs out, you want a different instance of <code>LoginViewModel</code>, rather than the same instance as when the user logged in for the first time.</li>
</ol>
<p>To scope <code>LoginViewModel</code> to the lifecycle of <code>LoginActivtiy</code> you need to create a new component(a new subgraph) for the login flow and a new scope.</p>
<p>Let’s create a graph specific to the login flow.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginComponent</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, <code>LoginActivity</code> should get injections from <code>LoginComponent</code> because it has a login-specific configuration. This removes the reponsibility to inject <code>LoginActivity</code> from the <code>ApplicationComponent</code> class.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://developer.android.com/training/dependency-injection/dagger-android#dagger-scopes" target="_blank" rel="noopener"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/5310550a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/5310550a/" itemprop="url">Translation Dependency Injection - Dagger basics</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-17T13:12:13+08:00">
                2020-01-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/5310550a/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/5310550a/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Dagger-basics"><a href="#Dagger-basics" class="headerlink" title="Dagger basics"></a>Dagger basics</h2><p>Manual dependency injection or service locators in an Android app can be problematic depending on the size of your project. You can limit your project’s complexity as it scales up by using <a href="https://dagger.dev/" target="_blank" rel="noopener">Dagger</a> to manage dependencies.</p>
<p>Dagger automatically generates code that mimics the code you would otherwise have hand-written. Because the code is generated at compile time, it’s traceable and more performant than other reflection-based solutions such as <a href="https://en.wikipedia.org/wiki/Google_Guice" target="_blank" rel="noopener">Guice</a>.</p>
<h2 id="Benefits-of-using-Dagger"><a href="#Benefits-of-using-Dagger" class="headerlink" title="Benefits of using Dagger"></a>Benefits of using Dagger</h2><p>Dagger frees you from writing tedious and error-prone boilerplate code by:</p>
<ul>
<li>Generating the <code>AppContainer</code> code (application graph) that you manually implemented in the manual DI section</li>
<li>Creating factories for the classes available in the application graph. This is how dependencies are satisfied internally.</li>
<li>Reusing a dependency or creating new instance of a type depending on how you the configuration of the type using scopes.</li>
<li>Creating containers for specific flows as you did with the login flow in the previous section using Dagger subcomponents. This improves your app’s performance by releasing objects in memory when they’re no longer needed.</li>
</ul>
<p>Dagger automatically does all of this at build time as long as you declare dependencies of a class and specify how to satisfy them using annotations. Dagger generates code similar to what you would have written manually. Internally, Dagger creates a graph of objects that it can reference to find the way to provide an instance of a class. For every class in the graph, Dagger generates a <a href="https://en.wikipedia.org/wiki/Factory_method_pattern" target="_blank" rel="noopener">factory-type</a> class that it uses internally to get instances of that type.</p>
<p>At build time, Dagger walks through your code and :</p>
<ul>
<li>Build and validates dependency graphs, ensuring that:<ul>
<li>Every object’s dependencies can be satisfied, so there are no runtime exceptions</li>
<li>No dependency cycles exist, so there are no infinite loops</li>
</ul>
</li>
<li>Generates the classes that are used at runtime to create the actual objects and their dependencies.</li>
</ul>
<h2 id="A-simple-use-case-in-Dagger-Generating-a-factory"><a href="#A-simple-use-case-in-Dagger-Generating-a-factory" class="headerlink" title="A simple use case in Dagger: Generating a factory"></a>A simple use case in Dagger: Generating a factory</h2><p>To demonstrate how you can work with Dagger, let’s create a simple <a href>factory</a> for the <code>UserRepository</code> class shown in the following diagram.</p>
<p><img src="https://developer.android.com/images/training/dependency-injection/3-factory-diagram.png" alt></p>
<p>Define <code>UserRepository</code> as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add an <code>@Inject</code> annotation to the <code>UserRepository</code> construct so Dagger knows how to create a <code>UserRepository</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Inject lets Dagger know how to create instances of this object</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the above snippet of code, you’re telling Dagger:</p>
<ol>
<li>How to create a <code>UserRepository</code> instance with the <code>@Inject</code> annotated constructor</li>
<li>What its dependencies are: <code>UserLocalDataSource</code> and <code>UserRemoteDataSource</code></li>
</ol>
<p>Now Dagger knows how to create an instance of <code>UserRepository</code>, but it doesn’t know how to create its dependencies. If you annotate the other classes too, Dagger knows how to create them.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLocalDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserLocalDataSource</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRemoteDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRemoteDataSource</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dagger-Components"><a href="#Dagger-Components" class="headerlink" title="Dagger Components"></a>Dagger Components</h2><p>Dagger can create a graph of the dependencies in your project that it can use to find out where it should get those dependencies when they are needed. To make Dagger do this, you need to create an interface and annotate it with <code>@Component</code>. Dagger creates a container as you would have done with manual dependency injection.</p>
<p>Inside the <code>@Component</code> interface, you can define functions that return instances of the classes you need (i.e. <code>UserRepository</code>). <code>@Component</code> tells Dagger to generate a container with all the dependencies required to satisfy the types it exposes. This is called a Dagger component, it contains a graph that consists of the objects that Dagger knows how to provide and their respective dependencies.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// @Component makes Dagger create a graph of dependencies</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationGraph</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The return type  of functions inside the component interface is</span></span><br><span class="line">    <span class="comment">// what can be consumed from the graph</span></span><br><span class="line">    <span class="function">UserRepository <span class="title">userRepository</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When you build the project, Dagger generaets an implementation of the <code>ApplicationGraph</code> interface for you: <code>DaggerApplicationGraph</code>. With its annotation processor, Dagger creates a dependency graph that consists of the relationships between the three classes(<code>UserRepository</code>, <code>UserLocalDataSource</code>, and <code>UserRemoteDataSource</code>) with only one entry point: geeting a <code>UserRepository</code> instance. You can use it as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Create an instance of the application graph</span></span><br><span class="line">ApplicationGraph applicationGraph = DaggerApplicationGraph.create();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Grab an instance of UserRepository from the application graph</span></span><br><span class="line">UserRepository userRepository = applicationGraph.userRepository();</span><br></pre></td></tr></table></figure>

<p>Dagger creates a new instance of <code>UserRepository</code> every time it’s required.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ApplicationGraph applicationGraph = DaggerApplicationGraph.create();</span><br><span class="line"></span><br><span class="line">UserRepository userRepository = applicationGraph.userRepository();</span><br><span class="line">UserRepository userRepository2 = applicationGraph.userRepository();</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(userRepository != userRepository2)</span><br></pre></td></tr></table></figure>

<p>Sometimes, you need to have a unique instance of a dependency in a container. You might want this for several reasons:</p>
<ol>
<li>You want other types that have this type as a dependency to share the same instance, such as multiple <code>ViewModel</code> objects in the login flow using the same <code>LoginUserData</code></li>
<li>An object is expensive to create and you don’t want to create a new instance everytime it’s declared as a dependency(for example, a JSON parser)</li>
</ol>
<p>In the example, you might want to have a unique instance of <code>UserRepository</code> available in the graph so that every time you ask for a <code>UserRepository</code>, you always get the same instance. This is useful in your example because in a real-life application with a more complex application graph, you might have multiple <code>ViewModel</code> objects depending on <code>UserRepository</code> and you don’t want to create new instance of <code>UserLocalDataSource</code> and <code>UserRemoteDataSource</code> everytime <code>UserRepository</code> needs to be provided.</p>
<p>In manual dependency injection, you do this by passing in the same instance of <code>UserRepository</code> to the constructors of the ViewModel classes; but in Dagger, because you are not writing that code manually, you have to let Dagger know you want to use the same instance. This can be done with scope annotations.</p>
<h3 id="Scopeing-with-Dagger"><a href="#Scopeing-with-Dagger" class="headerlink" title="Scopeing with Dagger"></a>Scopeing with Dagger</h3><p>You can use scope annotation to limit the lifetime of an object to the lifetime of its component. This means that the same instance of a dependency is used every time that type needs to be provided.</p>
<p>To have a unique instance of a <code>UserRepository</code> when you ask for the repository in <code>ApplicationGraph</code>, use the same scope annotation for the <code>@Component</code> interface and <code>UserRepository</code>. You can use the <code>@Singleton</code> annotation that already comes with the <code>javax.inject</code> package that Dagger uses:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Scope annotations on a @Component interface informs Dagger that classes annotated</span></span><br><span class="line"><span class="comment">// with this annotation (i.e. @Singleton) are scoped to the graph and the same</span></span><br><span class="line"><span class="comment">// instance of that type is provided every time the type is requested.</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationGraph</span> </span>&#123;</span><br><span class="line">    <span class="function">UserRepository <span class="title">userRepository</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Scope this class to a component using @Singleton scope (i.e. ApplicationGraph)</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Alternatively, you can create and use a custom scope annotation. You can create a scope annotation as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Creates MyCustomScope</span></span><br><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyCustomScope &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Then you can use it as before:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@MyCustomScope</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationGraph</span> </span>&#123;</span><br><span class="line">    <span class="function">UserRepository <span class="title">userRepository</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MyCustomScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In both cases, the object is provided with the same scope used to annotate the <code>@Component</code> interface. Thus, every time you call <code>applicationGraph.repository()</code>, you get the same instance of <code>UserRepository</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ApplicationGraph applicationGraph = DaggerApplicationGraph.create();</span><br><span class="line"></span><br><span class="line">UserRepository userRepository = applicationGraph.userRepository();</span><br><span class="line">UserRepository userRepository2 = applicationGraph.userRepository();</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(userRepository == userRepository2)</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>It is important to be aware of Dagger’s benefits and the basics of how it works before you can use it in more complicated scenarios.</p>
<p>In the <a href="https://developer.android.com/training/dependency-injection/dagger-android" target="_blank" rel="noopener">next page</a>, you’ll learn how to add Dagger to an Android application.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/c13b73f3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/c13b73f3/" itemprop="url">Translation Dependency Injection - Manual dependency injection</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-16T17:36:05+08:00">
                2020-01-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/c13b73f3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/c13b73f3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Manual-dependency-injection"><a href="#Manual-dependency-injection" class="headerlink" title="Manual dependency injection"></a>Manual dependency injection</h2><p><a href>Android’s recommended app architecture</a> encourages dividing your code into classes to benefit from separation of concerns, a principle where each class of the hierarchy has a single defined responsibility. This leads to more, smaller classes that need to be  connected together to fulfill each other’s dependencies.</p>
<p><img src="https://developer.android.com/topic/libraries/architecture/images/final-architecture.png" alt="A model of an Android app&#39;s application graph"></p>
<p>The dependencies between classes can be represented as a graph, in which each class is connected to the classes it depends on. The representation of all your classes and their dependencies makes up the application graph. In figure 1, you can see an abstraction of the application graph. When class A (ViewModel) depends on class B(Repository), there’s a line that points from A to B representing that denpendency.</p>
<p>Dependency injection helps make these connections and enables you to swap out implementations for testing. For example, when testing a <code>ViewModel</code> that depends on a repository, you can pass different implementations of <code>Repository</code> with either fakes or mocks to test the different cases.</p>
<h2 id="Basics-of-manual-dependency-injection"><a href="#Basics-of-manual-dependency-injection" class="headerlink" title="Basics of manual dependency injection"></a>Basics of manual dependency injection</h2><p>This section covers how to apply manual dependency injection in a real Android app scenario. It walks through an iterated approach of how you might start using dependency injection in your app. The approach improves until it reaches a point that is very similar to what Dagger would automatically generate for you. For more information about Dagger, read <a href="https://developer.android.com/training/dependency-injection/dagger-basics" target="_blank" rel="noopener">Dagger basics</a>.</p>
<p>Consider a <code>flow</code> to be a group of screens in your app that corresponds to a feature. Login, registration, and checkout are all examples of flows.</p>
<p>When covering a login flow for a typical Android app, the <code>LoginActvitiy</code> depends on <code>LoginViewModel</code>, which in turn depends on <code>UserRepository</code>. The <code>UserRepository</code> dependends on a <code>UserLocalDataSource</code> and a <code>UserRemoteDataSourcec</code>, which in turn depends on a <a href="https://square.github.io/retrofit/" target="_blank" rel="noopener">Retrofit</a> service.</p>
<p><code>LoginActivity</code> in the entry point to the login flow and the user interacts with the activity. Thus, <code>LoginActivity</code> needs to create the <code>LoginViewModel</code> with all its dependencies.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLocalDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserLocalDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRemoteDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Retrofit retrofit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRemoteDataSource</span><span class="params">(Retrofit retrofit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.retrofit = retrofit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLocalDataSource userLocalDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRemoteDataSource userRemoteDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRepository</span><span class="params">(UserLocalDataSource userLocalDataSource, UserRemoteDataSource userRemoteDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userLocalDataSource = userLocalDataSource;</span><br><span class="line">        <span class="keyword">this</span>.userRemoteDataSource = userRemoteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here’s what <code>LoginActivity</code> looks like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginViewModel loginViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In order to satisfy the dependencies of LoginViewModel, you have to also</span></span><br><span class="line">        <span class="comment">// satisfy the dependencies of all of its dependencies recursively.</span></span><br><span class="line">        <span class="comment">// First, create retrofit which is the dependency of UserRemoteDataSource</span></span><br><span class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .baseUrl(<span class="string">"https://example.com"</span>)</span><br><span class="line">                .build()</span><br><span class="line">                .create(LoginService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Then, satisfy the dependencies of UserRepository</span></span><br><span class="line">        UserRemoteDataSource remoteDataSource = <span class="keyword">new</span> UserRemoteDataSource(retrofit);</span><br><span class="line">        UserLocalDataSource localDataSource = <span class="keyword">new</span> UserLocalDataSource();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now you can create an instance of UserRepository that LoginViewModel needs</span></span><br><span class="line">        UserRepository userRepository = <span class="keyword">new</span> UserRepository(localDataSource, remoteDataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lastly, create an instance of LoginViewModel with userRepository</span></span><br><span class="line">        loginViewModel = <span class="keyword">new</span> LoginViewModel(userRepository);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are issues with this approach:</p>
<ol>
<li>There is a lot of boilerplate code. If you want to create another instance of <code>LoginViewModel</code> in another part of the code, you’d have code duplication.</li>
<li>Dependencies have to be declared in order. You have to instantiate <code>UserRepository</code> before <code>LoginViewModel</code> in order to create it .</li>
<li>It’s difficult to reuse objects. If you wanted to reuse <code>Repository</code> accross multiple feature, you’d have to make it follow the <a href="https://en.wikipedia.org/wiki/Singleton_pattern" target="_blank" rel="noopener">singleton pattern</a>. The singleton pattern makes testing more difficult because all tests share the same singleton instance.</li>
</ol>
<h2 id="Managing-dependencies-with-a-container"><a href="#Managing-dependencies-with-a-container" class="headerlink" title="Managing dependencies with a container"></a>Managing dependencies with a container</h2><p>To solve the issue of reusing objects, you can create your own dependencies container class that you use to get dependencies. All instances provided by this container can be public. In the example, because you only need an instance of <code>UserRepository</code>, you can make its dependencies private with the option of making them public in the future if they need to be provided.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Container of objects shared across the whole app</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since you want to expose userRepository out of the container, you need to satisfy</span></span><br><span class="line">    <span class="comment">// its dependencies as you did before</span></span><br><span class="line">    <span class="keyword">private</span> Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">            .baseUrl(<span class="string">"https://example.com"</span>)</span><br><span class="line">            .build()</span><br><span class="line">            .create(LoginService.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserRemoteDataSource remoteDataSource = <span class="keyword">new</span> UserRemoteDataSource(retrofit);</span><br><span class="line">    <span class="keyword">private</span> UserLocalDataSource localDataSource = <span class="keyword">new</span> UserLocalDataSource();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// userRepository is not private; it'll be exposed</span></span><br><span class="line">    <span class="keyword">public</span> UserRepository userRepository = <span class="keyword">new</span> UserRepository(localDataSource, remoteDataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because these dependencies are used acroos the whole application, they need to be placed in a common place all activities can use: the application class. Create a custom application class that contains an <code>AppContainer</code> instance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Custom Application class that needs to be specified</span></span><br><span class="line"><span class="comment">// in the AndroidManifest.xml file</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of AppContainer that will be used by all the Activities of the app</span></span><br><span class="line">    <span class="keyword">public</span> AppContainer appContainer = <span class="keyword">new</span> AppContainer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now you can get the instance of the <code>AppContainer</code> from the application and obtain the shared of <code>UserRepository</code> instance:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginViewModel loginViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gets userRepository from the instance of AppContainer in Application</span></span><br><span class="line">        AppContainer appContainer = ((MyApplication) getApplication()).appContainer;</span><br><span class="line">        loginViewModel = <span class="keyword">new</span> LoginViewModel(appContainer.userRepository);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this way, you don’t have a singleton <code>UserRepository</code>. Instead, you have an <code>AppContainer</code> shared across all activities that contains objects from the graph and creates instances of those objects that other classes can consume.</p>
<p>If <code>LoginViewModel</code> is needed in more places in the application, having a centralized place where you create instances of <code>LoginViewModel</code> makes sense. You can move the creation of <code>LoginViewModel</code> to the container and provide new objects of that type with a factory. The code for a <code>LoginViewModelFactory</code> looks like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Definition of a Factory interface with a function to create objects of a type</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Factory for LoginViewModel.</span></span><br><span class="line"><span class="comment">// Since LoginViewModel depends on UserRepository, in order to create instances of</span></span><br><span class="line"><span class="comment">// LoginViewModel, you need an instance of UserRepository that you pass as a parameter.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginViewModelFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginViewModelFactory</span><span class="params">(UserRepository userRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginViewModel <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoginViewModel(userRepository);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can include the <code>LoginViewModelFactory</code> in the <code>AppContainer</code> and make the <code>LoginActivity</code> consume it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppContainer can now provide instances of LoginViewModel with LoginViewModelFactory</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppContainer</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserRepository userRepository = <span class="keyword">new</span> UserRepository(localDataSource, remoteDataSource);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LoginViewModelFactory loginViewModelFactory = <span class="keyword">new</span> LoginViewModelFactory(userRepository);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginViewModel loginViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gets LoginViewModelFactory from the application instance of AppContainer</span></span><br><span class="line">        <span class="comment">// to create a new LoginViewModel instance</span></span><br><span class="line">        AppContainer appContainer = ((MyApplication) getApplication()).appContainer;</span><br><span class="line">        loginViewModel = appContainer.loginViewModelFactory.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This approach is better than the previous one, but there are still some challenges to consider:</p>
<ol>
<li>You have to manage <code>AppContainer</code> yourself, creating instances for all dependencies by hand</li>
<li>There is still a lot of boilerplate code. You need to create factories or parameters by hand depending on whether you want to reuse an object or not.</li>
</ol>
<h2 id="Managing-dependencies-in-application-flows"><a href="#Managing-dependencies-in-application-flows" class="headerlink" title="Managing dependencies in application flows"></a>Managing dependencies in application flows</h2><p><code>AppContainer</code> gets complicated when you want to include more functionality in the project. When your app becomes larger and you start introducing different feature flows, there are even more problems that arise:</p>
<ol>
<li>When you have different flows, you might want objects to just live in the scope of that flow. For example, when creating <code>LoginUserData</code>(that might consist of the username and password used only in the login flow) you don’t want to persist data from an old login flow from a different user. You want a new instance for every new flow. You can achieve that by creating <code>FlowContainer</code> objects inside the <code>AppContainer</code> as demonstrated in the next code example.</li>
<li>Optimizing the application graph and flow containers can also be difficult. You need to remember to delete instances that you don’t need, depending on the flow you’re in.</li>
</ol>
<p>Imagine you have a login flow that consists of one activity (<code>LoginActivity</code>) and multiple fragments (<code>LoginusernameFragment</code> and <code>LoginPasswordFragment</code>). These views want to :</p>
<ol>
<li>Access the same <code>LoginUserData</code> instance that needs to be shared until the login flow finishes</li>
<li>Create a new instance of <code>LoginUserData</code> when the flow starts again.</li>
</ol>
<p>You can achieve that with a login flow container. This container needs to be created when the login flow starts and removed from memory when the flow ends.</p>
<p>Let’s add a <code>LoginContainer</code> to the example code. You want to be able to create multiple instances of <code>LoginContainer</code> in the app, so instead of making it a singleton, make it a class with the dependencies the login flow needs from the <code>AppContainer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Container with Login-specific dependencies</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginContainer</span><span class="params">(UserRepository userRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userRepository = userRepository;</span><br><span class="line">        loginViewModelFactory = <span class="keyword">new</span> LoginViewModelFactory(userRepository);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LoginUserData loginData = <span class="keyword">new</span> LoginUserData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LoginViewModelFactory loginViewModelFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AppContainer contains LoginContainer now</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppContainer</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> UserRepository userRepository = <span class="keyword">new</span> UserRepository(localDataSource, remoteDataSource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LoginContainer will be null when the user is NOT in the login flow</span></span><br><span class="line">    <span class="keyword">public</span> LoginContainer loginContainer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once you have a container specific to a flow, you have to decide when to create and delete the container instance. Because your login flow is self-contained in an activity(<code>LoginActivity</code>), the activity is the one managing the lifecycle of that container. <code>LoginActivity</code> can create the instance in <code>onCreate()</code> and delete it in <code>onDestroy()</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginViewModel loginViewModel;</span><br><span class="line">    <span class="keyword">private</span> LoginData loginData;</span><br><span class="line">    <span class="keyword">private</span> AppContainer appContainer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        appContainer = ((MyApplication) getApplication()).appContainer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login flow has started. Populate loginContainer in AppContainer</span></span><br><span class="line">        appContainer.loginContainer = <span class="keyword">new</span> LoginContainer(appContainer.userRepository);</span><br><span class="line"></span><br><span class="line">        loginViewModel = appContainer.loginContainer.loginViewModelFactory.create();</span><br><span class="line">        loginData = appContainer.loginContainer.loginData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Login flow is finishing</span></span><br><span class="line">        <span class="comment">// Removing the instance of loginContainer in the AppContainer</span></span><br><span class="line">        appContainer.loginContainer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Like <code>LoginActivity</code>, login fragments can access the <code>LoginContainer</code> from <code>AppContainer</code> and use the shared <code>LoginUserData</code> instance.</p>
<p>Because in this case you’re dealing with view lifecycle logic, using <a href="https://developer.android.com/topic/libraries/architecture/lifecycle" target="_blank" rel="noopener">lifecycle observation</a> makes sense.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Dependency injection is a good technique for creating scalable and testable Android apps. Use containers as a way to share instances of classes in different parts of your app and as a centralized place to create instances of classes using factories.</p>
<p>When your application gets larger, you will start seeing that you write a lot of boilerplate code (such as factories), which can be error-prone. You also have to manage the scope and lifecycle of the containers yourself, optimizing and discarding containers that are no longer needed in order to free up memory. Doing this incorrectly can lead to subtle bugs and memory leaks in your app.</p>
<p>On <a href="https://developer.android.com/training/dependency-injection/dagger-basics" target="_blank" rel="noopener">the next page</a>, you’ll learn how you can use Dagger to automate this process and generate the same code you would have written by hand otherwise.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/71c1b698/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/71c1b698/" itemprop="url">Translation Dependency Injection - Overview</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-16T15:47:30+08:00">
                2020-01-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/71c1b698/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/71c1b698/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Dependency-Injection-in-Android"><a href="#Dependency-Injection-in-Android" class="headerlink" title="Dependency Injection in Android"></a>Dependency Injection in Android</h2><p>Dependency Injection (DI) is a technique widely used in programming and well suited to Android development. By following the principles of DI, you lay the groundwork for good app architecture.</p>
<p>Implementing dependency injection provides you with the following advantages:</p>
<ul>
<li>Reusability of code</li>
<li>Ease of refactoring</li>
<li>Ease of testing</li>
</ul>
<h2 id="Fundamentals-of-dependency-injection"><a href="#Fundamentals-of-dependency-injection" class="headerlink" title="Fundamentals of dependency injection"></a>Fundamentals of dependency injection</h2><p>Before convering dependency injection in Android specifically, this page provides a more generatl overview of how dependency injection works.</p>
<h3 id="What-is-dependency-injection"><a href="#What-is-dependency-injection" class="headerlink" title="What is dependency injection?"></a>What is dependency injection?</h3><p>Classes often require references to other classes. For example, a <code>Car</code> class might need a reference to an <code>Engine</code> class. These required classes are called dependencies, and in this example the <code>Car</code> class is dependent on having an instance of the <code>Engine</code> class to run.</p>
<p>There are three ways for a class to get an object it needs:</p>
<ol>
<li>The class constructs the dependency it needs. In the example above, <code>Car</code> would create and initialize its own instance of <code>Engine</code>.</li>
<li>Grab it from somewhere else. Some Android APIs, such as <code>Context</code> getters and <code>getSystemService()</code>, work this way.</li>
<li>Having it supplied as a parameter. The app can provide these dependencies when the class is constructed or pass them in to the functions that need each dependency. In the example above, the <code>Car</code> constructor would receive <code>Engine</code> as a parameter.</li>
</ol>
<p>The third option is dependency injection! With this approach you take the dependencies of a class and provide them rather than having the class instance obtain them itself.</p>
<p>Here’s an example. Without dependency injection, representing a <code>Car</code> that creates its own <code>Engine</code> dependency in code looks like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        engine.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car();</span><br><span class="line">        car.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is not an example of dependency injection because the <code>Car</code> class is constructing its own <code>Engine</code>. This can be problematic because : </p>
<ul>
<li><code>Car</code> and <code>Engine</code> are tightly coupled - an instance of <code>Car</code> uses one type of <code>Engine</code>, and no subclasses or alternative implementations can easily be used. If the <code>Car</code> were to construct its own <code>Engine</code>, you would have to create two types of <code>Car</code> instead of just reusing the same <code>Car</code> for engines of type <code>Gas</code> and <code>Electric</code>.</li>
<li>The hard dependency on <code>Engine</code> make testing more difficult. <code>Car</code> uses a real instance of <code>Engine</code>, thus preventing you from using a <a href="https://en.wikipedia.org/wiki/Test_double" target="_blank" rel="noopener">test double</a> to modify <code>Engine</code> for different test cases.</li>
</ul>
<p>What does the code look like with dependency injection? Instead of each instance of <code>Car</code> constructing its own <code>Engine</code> object on initialization, it receves an <code>Engine</code> object as a parameter in its constructor:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Engine engine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(Engine engine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.engine = engine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        engine.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">        Car car = <span class="keyword">new</span> Car(engine);</span><br><span class="line">        car.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://developer.android.com/images/training/dependency-injection/1-car-engine-no-di.png" alt></p>
<p>The <code>main</code> function use <code>Car</code>. Because <code>Car</code> depends on <code>Engine</code>, the app creates an instance of <code>Engine</code> and then uses it to construct an instance of <code>Car</code>. The benefits of this DI-based approach are:</p>
<ul>
<li>Reusability of <code>Car</code>. You can pass in different implementation of <code>Engine</code> to <code>Car</code>. For example, you might define a new subclass of <code>Engine</code> called <code>ElectricEngine</code> that you want <code>Car</code> to use. If you use DI, all you need to do is pass in an instance of the updated <code>ElectricEngine</code> subclass, and <code>Car</code> still works without any further changes.</li>
<li>Easy testing of <code>Car</code>. You can pass in test doubles to test your differernt scenarios. For example, you might create a test double of <code>Engine</code> called <code>FakeEngine</code> and configure it for different tests.</li>
</ul>
<p>There are two major ways to do dependency injection in Android:</p>
<ul>
<li>Constructor Injection: This is the way described above. You pass the dependencies of a class to its constructor.</li>
<li>Field Injection(or Setter Injection): Certain Android framework classes such as activities and fragments are instantiated by the system, so constructor injection is not possible. With field injection, dependencies are instantiated after the class is created. The code would look like this:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Engine engine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEngine</span><span class="params">(Engine engine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.engine = engine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        engine.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car();</span><br><span class="line">        car.setEngine(<span class="keyword">new</span> Engine());</span><br><span class="line">        car.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://developer.android.com/images/training/dependency-injection/1-car-engine-di.png" alt></p>
<h3 id="Automated-dependency-injection"><a href="#Automated-dependency-injection" class="headerlink" title="Automated dependency injection"></a>Automated dependency injection</h3><p>In the previous example, you created, provided, and managed the dependencies of the different classes your self, without relying on a library. This is called dependency injection by hand, or manual dependency injection. In the <code>Car</code> example, there was only on dependency, but more dependencies and classes can make manual injection of dependencies more tedious. Manual dependency injection also presents several problems:</p>
<ul>
<li>For big apps, taking all the dependencies and connecting them correctly can require a large amount of boilerplate code. In a multi-layered architecture, in order to create an object for a top layer, you have to provide all the dependencies of the layers below it. As a concrete example, to build a real car you might need an engine, a transmission, a chassis, and other parts; and an engine in turn needs cylinders and spark plugs.</li>
<li>When you’re not able to construct dependencies before passing them in - for example when using lazy initializations or scoping objects  to flows of your app - you need to write and maintain a custom container(or graph of dependencies) that manages the lifetimes of your dependencies in memory.</li>
</ul>
<p>There are libraries that solve this problem by automating the process of creating and providing dependencies. They fit into two categories:</p>
<ul>
<li>Reflection-based solutions that connect dependencies at runtime.</li>
<li>Static solutions that generate the code to connect dependencies at compile time.</li>
</ul>
<p><a href="https://dagger.dev/" target="_blank" rel="noopener">Dagger</a> is a popular dependency injection libaray for Java, Kotlin, and Android that is maintained by Google. Dagger facilitates using DI in your app by creating and managing the graph of dependencies for you. It provides fully static and compile-time dependencies addressing many of the development and performance issues of reflection-based solution such as <a href="https://en.wikipedia.org/wiki/Google_Guice" target="_blank" rel="noopener">Guice</a>.</p>
<h2 id="Alternatives-to-dependency-injection"><a href="#Alternatives-to-dependency-injection" class="headerlink" title="Alternatives to dependency injection"></a>Alternatives to dependency injection</h2><p>An alternative to dependency injection is using a <a href>service locator</a>. The service locator design pattern also improves decoupling of classes from concrete dependencies. You create a class known as the service locator that creates and stores dependencies and then provides those dependencies on demand.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServiceLocator instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ServiceLocator</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceLocator <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(ServiceLocator.class) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> ServiceLocator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Engine <span class="title">getEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Engine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Engine engine = ServiceLocator.getInstance().getEngine();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        engine.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car();</span><br><span class="line">        car.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The service locator pattern is different from dependency injection in the way the elements are consumed. With the service locator pattern, classes have control and ask for objects to be injected; with dependency injection, the app has control and proactivitely injects the require objects.</p>
<p>Compare to dependency injection:</p>
<ul>
<li>The collection of dependencies required by a service locator makes code harder to test because all the tests have to interact with the same global service locator</li>
<li>Dependencies are encoded in the class implementation, not in the API surface. As a result, it’s harder to know what a class needs from the outsied. As a result, changes to <code>Car</code> or the dependencies available in the service locator might result in runtime or tst failures by causing references to fail.</li>
<li>Managing lifetimes of objects is more difficult if you want to scope to anything other than the lifetime of the entire app.</li>
</ul>
<h2 id="Choosing-the-right-technique-for-your-app"><a href="#Choosing-the-right-technique-for-your-app" class="headerlink" title="Choosing the right technique for your app"></a>Choosing the right technique for your app</h2><p>As demonstrated above , there are several different techniques for managing your app’s dependencies:</p>
<p><code>Manual dependency injection</code> only makes sense for a relatively small app because it scales poorly. When the project becomes larger, passing objects require a lot of boilerplate code.</p>
<p><code>Service locators</code> start with relatively little boilerplate code, but also scale poorly. Furthermore, testing becomes more difficult because they rely on a singleton object.</p>
<p><code>Dagger</code> is built to scale. It is well suited for building complex apps.</p>
<p><img src="https://developer.android.com/images/training/dependency-injection/1-di-tool.png" alt></p>
<p>If your small app seems likely to grow, you should consider migrating to Dagger early when there isn’t as much code to change.</p>
<p><code>What&#39;s the size of your project?</code> For the purpose of deciding which technique to use, you can use the number of screens to proxy app size. However, note that number of screens is just one of many factors that can influence your app size.</p>
<p><img src="https://developer.android.com/images/training/dependency-injection/1-di-project-size.png" alt></p>
<h2 id="Choosing-the-right-technique-for-your-library"><a href="#Choosing-the-right-technique-for-your-library" class="headerlink" title="Choosing the right technique for your library"></a>Choosing the right technique for your library</h2><p>If you’re developing an external SDK or library, you should choose between manual DI or Dagger depending on the size of the SDK or library. Note that if you use a third-party library to do dependency injection, your library is likely to increase in size.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Dependency injection provides your app with the following advantages:</p>
<ul>
<li><p>Reusability of classes and decoupling of dependencies: It’s easier to swap out implementations of a dependency. Code reuse is improved because of inversion of control, and classes no longer control how their dependencies are created, but instead work with any configuration.</p>
</li>
<li><p>Ease of refactoring: The dependencies become a verifiable part of the API surface, so they can be checked at object-creation time or at compile time rather than being hidden as implementation details.</p>
</li>
<li><p>Ease of testing: A class doesn’t manage its dependencies, so when you’re testing it, you can pass in different implementations to test all of your different cases.</p>
</li>
</ul>
<p>To fully understand the benefits of dependency injection, you should try it manually in your app as shown in <a href="https://developer.android.com/training/dependency-injection/manual" target="_blank" rel="noopener">Manual dependency injection</a>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/87b5612/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/87b5612/" itemprop="url">Java SparseArray原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T10:20:31+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/87b5612/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/87b5612/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>SparseArray使用数组来分别存储key和object. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] mKeys; <span class="comment">//存储的是传入的key， 按顺序存储在数组中</span></span><br><span class="line"><span class="keyword">private</span> Object[] mValues; <span class="comment">// 存储真实的value, 与mKeys一一对应</span></span><br></pre></td></tr></table></figure>

<p>这里需要先要记住2个概念，一个是key, 一个是index. Key对应的就是<code>mKeys</code>数组里的某一个具体的数据, index对应的是<code>mKeys</code>这个数组的下标index.</p>
<p>SparseArray提供了许多方法来操作数据，有的是根据key来操作，有的是根据index来操作，需要特别注意。 如果是传入index的话，那么直接通过mKeys[index] 或者 mValues[index] 就可以取出需要的数据，而如果是传入key的话，则需要先进行二分查找，找到对应的index，再来取出需要的数据.</p>
<p>比如:</p>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  ======= 传 index 可以直接操作 =============</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValueAt</span><span class="params">(<span class="keyword">int</span> index, E value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mSize &amp;&amp; UtilConfig.sThrowExceptionForUpperArrayOutOfBounds) &#123;</span><br><span class="line">        <span class="comment">// The array might be slightly bigger than mSize, in which case, indexing won't fail.</span></span><br><span class="line">        <span class="comment">// Check if exception should be thrown outside of the critical path.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mValues[index] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ====== 传入 key ===== 需要先二分查找到对应的index 在操作 ======</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, E value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelper.binarySearch(mKeys, mSize, key);</span><br><span class="line">    <span class="keyword">if</span>(i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mValues[i] = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 因为binarySearch方法中，如果查找不到返回了~i &lt; 0</span></span><br><span class="line">        <span class="comment">// 而这里是通过返回值是否&gt;=0来判断的</span></span><br><span class="line">        <span class="comment">// 所以这里再取一次~, 来获取他本来应该在的位置</span></span><br><span class="line">        i = ~i;</span><br><span class="line">        <span class="keyword">if</span>(i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class="line">            mKeys[i] = key;</span><br><span class="line">            mValues[i] = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123;</span><br><span class="line">            gc();</span><br><span class="line">            <span class="comment">// Search again because indices may have changed.</span></span><br><span class="line">            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);</span><br><span class="line">        mValues = GrowingArrayUtils.insert(mValus, mSize, i, value);</span><br><span class="line">        mSize++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==== 传入 key, 需要二分查找对应index ====</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">removeReturnOld</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mValues[i] != DELETED) &#123;</span><br><span class="line">            <span class="keyword">final</span> E old = (E) mValues[i];</span><br><span class="line">            mValues[i] = DELETED;</span><br><span class="line">            mGarbage = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==== 传入 index, 直接操作 ====</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAtRange</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> end = Math.min(mSize, index + size);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; end; i++) &#123;</span><br><span class="line">        removeAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mSize &amp;&amp; UtilConfig.sThrowExceptionForUpperArrayOutOfBounds) &#123;</span><br><span class="line">        <span class="comment">// The array might be slightly bigger than mSize, in which case, indexing won't fail.</span></span><br><span class="line">        <span class="comment">// Check if exception should be thrown outside of the critical path.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mValues[index] != DELETED) &#123;</span><br><span class="line">        mValues[index] = DELETED;</span><br><span class="line">        mGarbage = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==== 传入 key, 需要二分查找对应index ====</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    delete(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearh(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(mValues[i] != DELETED) &#123;</span><br><span class="line">            mValues[i] = DELETED;</span><br><span class="line">            mGarbage = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入index, 直接操作数组 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">valueAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mSize &amp;&amp; UtilConfig.sThrowExceptionForUpperArrayOutOfBounds) &#123;</span><br><span class="line">        <span class="comment">// The array might be slightly bigger than mSize, in which case, indexing won't fail.</span></span><br><span class="line">        <span class="comment">// Check if exception should be thrown outside of the critical path.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (E) mValues[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据传入的value找到index, 就是遍历数组再去判断是否相等</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOfValue</span><span class="params">(E value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSize; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mValues[i] == value) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入key, 二分查找对应index, 当然也可以遍历keys，但是二分高效</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOfKey</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据value找到value对应的index, 不存在返回-1</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOfValueByValue</span><span class="params">(E value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSize; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mValues[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.equals(mValues[i])) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入key,找到对应value, 同样思想，先二分查找key所在的index</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(key, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key, E valueIfKeyNotFound)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || mValues[i] == DELETED) &#123;</span><br><span class="line">        <span class="keyword">return</span> valueIfKeyNotFound;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (E) mValues[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入index, 找到mKeys数组再该index位置的key</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">keyAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mSize &amp;&amp; UtilConfig.sThrowExceptionForUpperArrayOutOfBounds) &#123;</span><br><span class="line">        <span class="comment">// The array might be slightly bigger than mSize, in which case, indexing won't fail.</span></span><br><span class="line">        <span class="comment">// Check if exception should be thrown outside of the critical path.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mGarbage) &#123;</span><br><span class="line">        gc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mKeys[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到在所有remove操作的时候，会给mGarbage赋为true,然后调用gc()函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数把原先标记为DELETED的地方删除，然后数组后面的数据往前挪, 保证空间连续</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Log.e("SparseArray", "gc start with " + mSize);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> n = mSize;</span><br><span class="line">    <span class="keyword">int</span> o = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] keys = mKeys;</span><br><span class="line">    Object[] values = mValues;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        Object val = values[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val != DELETED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != o) &#123;</span><br><span class="line">                keys[o] = keys[i];</span><br><span class="line">                values[o] = val;</span><br><span class="line">                values[i] = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            o++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mGarbage = <span class="keyword">false</span>;</span><br><span class="line">    mSize = o;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log.e("SparseArray", "gc end with " + mSize);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的二分查找函数如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">long</span>[] array, <span class="keyword">int</span> size, <span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> hi = size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (lo &lt;= hi) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> midVal = array[mid];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (midVal &lt; value) &#123;</span><br><span class="line">            lo = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (midVal &gt; value) &#123;</span><br><span class="line">            hi = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;  <span class="comment">// value found</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ~lo;  <span class="comment">// value not present</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的数组扩容方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] insert(<span class="keyword">int</span>[] array, <span class="keyword">int</span> currentSize, <span class="keyword">int</span> index, <span class="keyword">int</span> element) &#123;</span><br><span class="line">    <span class="keyword">assert</span> currentSize &lt;= array.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentSize + <span class="number">1</span> &lt;= array.length) &#123;</span><br><span class="line">        System.arraycopy(array, index, array, index + <span class="number">1</span>, currentSize - index);</span><br><span class="line">        array[index] = element;</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] newArray = <span class="keyword">new</span> <span class="keyword">int</span>[growSize(currentSize)];</span><br><span class="line">    System.arraycopy(array, <span class="number">0</span>, newArray, <span class="number">0</span>, index);</span><br><span class="line">    newArray[index] = element;</span><br><span class="line">    System.arraycopy(array, index, newArray, index + <span class="number">1</span>, array.length - index);</span><br><span class="line">    <span class="keyword">return</span> newArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SparseArray array = <span class="keyword">new</span> SparseArray();</span><br><span class="line">        array.put(<span class="number">3</span>, <span class="string">"T"</span>);</span><br><span class="line">        array.put(<span class="number">5</span>, <span class="string">"F"</span>);</span><br><span class="line">        array.put(<span class="number">100</span>, <span class="string">"O"</span>);</span><br><span class="line">        array.put(<span class="number">4</span>, <span class="string">"U"</span>);</span><br></pre></td></tr></table></figure>

<p>放入<code>3</code>, 数组:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mKeys:  3</span><br><span class="line">mValus: T</span><br></pre></td></tr></table></figure>

<p>放入<code>5</code>, 数组:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mKeys:   3  5</span><br><span class="line">mValues: T  F</span><br></pre></td></tr></table></figure>

<p>放入<code>100</code>, 数组:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mKeys:   3  5  100</span><br><span class="line">mValues: T  F   O</span><br></pre></td></tr></table></figure>

<p>放入<code>4</code>, 数组:</p>
<p>// 这里mKeys, mValues执行arrayCopy操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mKeys:   3 4 5  100</span><br><span class="line">mValues: T U F   O</span><br></pre></td></tr></table></figure>

<p>保证每次mKeys里的数据是有序的</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/8570bc54/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/8570bc54/" itemprop="url">targetSDK, compileSDK, minSDK版本选择问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T10:15:50+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/8570bc54/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/8570bc54/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="compileSdkVersion"><a href="#compileSdkVersion" class="headerlink" title="compileSdkVersion"></a><strong>compileSdkVersion</strong></h2><p>is your way to tell Gradle what version of the Android SDK to compile your app with.  Using the new Android SDK is a requirement to use any of the new APIs added in that level.</p>
<p>BUT. <strong>Changing your compileSdkVersion doesn’t change runtime behavior</strong>. It purely used at compile time and new compiler warnings/errors may be present when changing your compileSdkVersion.</p>
<p>It’s strongly recommended that you always compile with the latest SDK.</p>
<p>If you use Support Library, compiling with the latest SDK is a requirement for using the latest Support Library release. e.g You must have a compileSdkVersion of at least 23 to use the 23.1.1 Support Library</p>
<p>In general, a new version of the Support Library is released alongside a new platform version, providing compatibility shims(薄垫片) to newly added APIs as well as new features.(为系统新增加的API和特性提供兼容性支持)</p>
<h2 id="minSdkVersion"><a href="#minSdkVersion" class="headerlink" title="minSdkVersion"></a>minSdkVersion</h2><p>is the lowest bound for your app. It is also one of the signals the Google Play store uses to determine which of a user’s devices an app can be installed on.</p>
<p>It plays an important role during development: by default lint runs against your project, warning you when you use any APIs above your minSdkVersion (lint检查会对使用任何API高于minSdkVersion的情况报warning), helping your avoid the runtime issue of attempting to call an API that doesn’t exist.  <a href="http://developer.android.com/training/basics/supporting-devices/platforms.html?utm_campaign=adp_series_sdkversion_010616&utm_source=medium&utm_medium=blog#version-codes" target="_blank" rel="noopener">Checking the system version at runtime</a> is a common technique when using APIs only on newer platform versions.</p>
<p>The libraries you use may have their own minSdkVersion. Your app’s minSdkVersion must be at least as high as your dependencies’ minSdkVersion.  In rare case where you want to continue to use a library with a higher minSdkVersion than your app, you can use the <a href="http://tools.android.com/tech-docs/new-build-system/user-guide/manifest-merger?utm_campaign=adp_series_sdkversion_010616&utm_source=medium&utm_medium=blog#TOC-tools:overrideLibrary-marker" target="_blank" rel="noopener">tools:overrideLibrary</a> marker.(很少情况下，如果你仍然想用minSdkVersion &gt; app minSdkVersion的库，你可以使用tools:overrideLibeary标记。)</p>
<h2 id="targetSdkVersion"><a href="#targetSdkVersion" class="headerlink" title="targetSdkVersion"></a>targetSdkVersion</h2><p>is the main way Android provides forward compatibility by not applying behavior changes unless the targetSdkVersion is updated. This allows you to use new APIs prior to working through the behavior changes. (targetSdkVersion是Android提供向前兼容的主要依据，在应用的targetSdkVersion没有更新之前系统不会应用最新的行为变化。 这允许你在适应新的行为变化之前使用新的API.)</p>
<p>Much of the behavior changes that targetSdkVersion implies are documented directly in the <a href="http://developer.android.com/reference/android/os/Build.VERSION_CODES.html?utm_campaign=adp_series_sdkversion_010616&utm_source=medium&utm_medium=blog" target="_blank" rel="noopener">VERSION_CODES</a>, but all of the gory details are also listed on the each releases’ platform highlights, nicely linked in the <a href="http://developer.android.com/guide/topics/manifest/uses-sdk-element.html?utm_campaign=adp_series_sdkversion_010616&utm_source=medium&utm_medium=blog#ApiLevels" target="_blank" rel="noopener">API Levels table</a>. (targetSdkVersion 所暗示的许多行为变化都记录在 VERSION_CODES 文档中了，但是所有恐怖的细节也都列在每次发布的平台亮点中了，在这个 API Level 表中可以方便地找到相应的链接。)</p>
<p>With some of the behavior changes being very visible to user, updating to target the latest SDK should be a high priority for every app.  Test before updating your targetSdkVersion. </p>
<p>minSdkVersion and targetSdkVersion also differ from compileSdkVersion in that they are included in your final APK. </p>
<p>You’ll find if you manually put this is your manifest, it’ll be ignored when you build with Gradle. (如果你在 manifest 文件中手工设置，你会发现 Gradle 在构建时会忽略它们。)</p>
<h2 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h2><blockquote>
<p>minSdkVersion ≤ targetSdkVersion ≤ compileSdkVersion</p>
</blockquote>
<p>compileSdkVersion is your ‘maximum’ and minSdkVersion is your ‘minimum’ </p>
<p>Ideally, the relationship would look more like this</p>
<blockquote>
<p>minSdkVersion(lowest possible) ≤ targetSdkVersion == compileSdkVersion(latest SDK)</p>
</blockquote>
<p>You will hit the biggest audience with a low minSdkVersion and look and act the best by targeting and compiling with the latest SDK(用较低的 minSdkVersion 来覆盖最大的人群，用最新的 SDK 设置 target 和 compile 来获得最好的外观和行为)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/66d7bf51/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/66d7bf51/" itemprop="url">Android 权限相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T10:08:12+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/66d7bf51/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/66d7bf51/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android M api 23之后引入运行时权限。</p>
<p>再此之前，权限是在androidManifest.xml中申请，用户安装的时候可以看到，要么全同意，要么全不同意。</p>
<p>权限分组:</p>
<ul>
<li>Normal Protection权限</li>
<li>Dangerous 权限</li>
<li>Particular 权限</li>
<li>Other 权限</li>
</ul>
<p>正常权限:</p>
<p>对用户隐私没有较大影响或者不会带来安全问题，安装后就赋予这些权限，不需要提醒用户，用户也不能取消这些权限, 主要是一些网络，蓝牙，时区，快捷方式。只要AndroidManifest中进行设置，就会被授予，且不能取消。</p>
<pre><code>ACCESS_LOCATION_EXTRA_COMMANDS
ACCESS_NETWORK_STATE
ACCESS_NOTIFICATION_POLICY
ACCESS_WIFI_STATE
BLUETOOTH
BLUETOOTH_ADMIN
BROADCAST_STICKY
CHANGE_NETWORK_STATE
CHANGE_WIFI_MULTICAST_STATE
CHANGE_WIFI_STATE
DISABLE_KEYGUARD
EXPAND_STATUS_BAR
GET_PACKAGE_SIZE
INTERNET
KILL_BACKGROUND_PROCESSES
MODIFY_AUDIO_SETTINGS
NFC
READ_SYNC_SETTINGS
READ_SYNC_STATS
RECEIVE_BOOT_COMPLETED
REORDER_TASKS
REQUEST_INSTALL_PACKAGES
SET_TIME_ZONE
SET_WALLPAPER
SET_WALLPAPER_HINTS
TRANSMIT_IR
USE_FINGERPRINT
VIBRATE
WAKE_LOCK
WRITE_SYNC_SETTINGS
SET_ALARM
INSTALL_SHORTCUT
UNINSTALL_SHORTCUT</code></pre><p>特殊权限</p>
<p>主要有2个</p>
<pre><code>SYSTEM_ALERT_WINDOW 设置悬浮窗, 进行一些黑科技
WRITE_SETTINGS 修改系统设置

做法是通过startActivityForResult来进行授权

e.g 请求悬浮窗
private static final int REQUEST_CODE = 1;
private  void requestAlertWindowPermission() {
    Intent intent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION);
    intent.setData(Uri.parse(&quot;package:&quot; + getPackageName()));
    startActivityForResult(intent, REQUEST_CODE);
}

@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    if (requestCode == REQUEST_CODE) {
        if (Settings.canDrawOverlays(this)) {
            Log.i(LOGTAG, &quot;onActivityResult granted&quot;);
        }
    }
}

请求WRITE_SETTINGS
private static final int REQUEST_CODE_WRITE_SETTINGS = 2;
private void requestWriteSettings() {
    Intent intent = new Intent(Settings.ACTION_MANAGE_WRITE_SETTINGS);
    intent.setData(Uri.parse(&quot;package:&quot; + getPackageName()));
    startActivityForResult(intent, REQUEST_CODE_WRITE_SETTINGS );
}
@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    if (requestCode == REQUEST_CODE_WRITE_SETTINGS) {
        if (Settings.System.canWrite(this)) {
            Log.i(LOGTAG, &quot;onActivityResult write settings granted&quot; );
        }
    }</code></pre><p>危险权限</p>
<pre><code>CALENDAR
CAMERA
CONTACTS
LOCATION
MICROPHONE
PHONE
SENSORS
SMS
STORAGE</code></pre><p><img src="https://s3.us-west-2.amazonaws.com/secure.notion-static.com/6e1b3155-71bd-42cb-b9b6-97688d5611d1/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAT73L2G45FWSOCWXQ%2F20200115%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20200115T020900Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEN7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDYDTV3JVhhMw0UpiXaDMd0Rn4T76BgAmiaNM7bPBWLKgIhAOsW9xTz9LZcAsoT8%2F7QQvnNZmRIN8aSgInpXgSENc6BKrQDCGcQABoMMjc0NTY3MTQ5MzcwIgzV3Qi8QK5nDODVbucqkQN4XADfjcgckwmsOuhFZQPf2j2OEmJNTzZJiq%2FzI1MogjWbmxNjvLBS9cfvN0EFkI77hAC1wFE%2F7zVAO6sXEpNQZGfAWEkZDUC2leYslClHP7TyzOLRxLIBGZ9%2BRc1YNhEAhmXJN%2B8wQBy3AxYda9c6%2B8aRBBUSMalk7SkubnAtMAia38ZXrFLAiAzKx9WG0znMJkDQpVgm9KAXPbCmtsZshBOETaj4eeLfC0W0wtuFTjmxLk4nUxeBXoZmImu9qsewbml05OwXV98zTTKGLAXaeGCmna4mofx6AqwCoh1wD8b1SBi%2BjxJHTbNsD6cmMydDJdSXtxNnWmwHU7T7%2FdnY86SHS33HllEEUNaKUn0p4V4oCayCDdsG%2FvZZCYzxr9YIa3oNph9VtGjzroj%2FStMuM7RLl913W9ETD8faOH4%2BiUDdODdPe%2BN9w5Rdl0DrdkqaY5N6S%2FLpk9hNJOdFVBy9cG9JWLO8fGX6w%2Fa8Rj%2BmUtQOk1QwrzqS%2F8UfitGGnuvDXFlAEX807R1%2BfGih56upWDD74fjwBTrqAbvHkixC0yQ0bshXas3oMfhSaKpgLWOQUvPR3rgiDY9ZSwif9vzfPUDLnrHH44cr%2F%2BtJE5wwsl4aPV0Pbw1MZ3Wk9v8pcYkjlw3qyQji4jptLcLu%2Bs%2FSvPwdOcdJi%2Fyrad0TUIDRVpTSB%2BPqeTVD4rCzPofVwQey%2BaMy3Kdt5fBEoBT%2FGbJMZWFr4wNxImC1VYNFc92yehomMYGSEM2As7Z1kEkyJe%2FtC93hgAH8JJ3eqzKP12W097ylbEhZjD1DU0YlE35jvr0pCaSroHP7hR9yWUCXBZMcKH8FYvl466FNzwgudRs2AKJP3Q%3D%3D&X-Amz-Signature=7167c9133af1c24f7a62e50a38ba2ae1b28e316694351bd6a097602b9aa5e08b&X-Amz-SignedHeaders=host&response-content-disposition=filename%20%3D%22Untitled.png%22" alt="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6e1b3155-71bd-42cb-b9b6-97688d5611d1/Untitled.png"></p>
<p>通常我们需要使用如下的API.</p>
<ul>
<li><strong>int checkSelfPermission(String permission)</strong> 用来检测应用是否已经具有权限</li>
<li><strong>void requestPermissions(String[] permissions, int requestCode)</strong> 进行请求单个或多个权限</li>
<li><strong>void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults)</strong> 用户对请求作出响应后的回调</li>
</ul>
<p>但是这些方法在API23之后才加入，低于23的版本需要使用V4包中提供的方法</p>
<ul>
<li>ContextCompat.checkSelfPermission</li>
<li>ActivityCompat.requestPermissions</li>
<li>ActivityCompat.shouldShowRequestPermissionRationale</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/6be564f4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/6be564f4/" itemprop="url">Android 图片计算相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T10:05:52+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/6be564f4/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/6be564f4/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.gcssloop.com/customview/Matrix_Method" target="_blank" rel="noopener">http://www.gcssloop.com/customview/Matrix_Method</a></p>
<p><a href="https://blog.csdn.net/larryl2003/article/details/6919513" target="_blank" rel="noopener">https://blog.csdn.net/larryl2003/article/details/6919513</a></p>
<p><a href="http://www.cnblogs.com/hrlnw/p/4403334.html" target="_blank" rel="noopener">http://www.cnblogs.com/hrlnw/p/4403334.html</a></p>
<p><a href="http://blog.mrriddler.com/2016/07/20/%E5%9B%BE%E7%89%87%E4%B9%8B%E6%97%85/" target="_blank" rel="noopener">http://blog.mrriddler.com/2016/07/20/%E5%9B%BE%E7%89%87%E4%B9%8B%E6%97%85/</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4MjU5NTY0NA==&mid=404530070&idx=1&sn=e2580b69d6ec73dabf8160216aa6702a&scene=1&srcid=0322dGvv5B4miLg3vt0q2rK2&key=710a5d99946419d9e5ab07eaa09e546952524b770e8a63c46c223b7588209d3a542fe4a0827571ac73b03cb78b404289&ascene=0&uin=MTYzMjY2MTE1&devicetype=iMac+MacBookPro10,1+OSX+OSX+10.11.4+build(15E65)&version=11020201&pass_ticket=Sqb+pOLTrZ0wixoScJ8flYxFV4tOFnBa7NFos1uIG8U=" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzA4MjU5NTY0NA==&amp;mid=404530070&amp;idx=1&amp;sn=e2580b69d6ec73dabf8160216aa6702a&amp;scene=1&amp;srcid=0322dGvv5B4miLg3vt0q2rK2&amp;key=710a5d99946419d9e5ab07eaa09e546952524b770e8a63c46c223b7588209d3a542fe4a0827571ac73b03cb78b404289&amp;ascene=0&amp;uin=MTYzMjY2MTE1&amp;devicetype=iMac+MacBookPro10,1+OSX+OSX+10.11.4+build(15E65)&amp;version=11020201&amp;pass_ticket=Sqb+pOLTrZ0wixoScJ8flYxFV4tOFnBa7NFos1uIG8U=</a></p>
<p>Bitmap的decodeResource和decodeFile的区别</p>
<p>decodeFile读取SD卡中的图，得到的是图片的原始尺寸</p>
<p>decodeResource读取Res, Raw等资源，得到的是图片的原始尺寸 * 缩放系数</p>
<pre><code>// 通过BitmapFactory.Options的这几个参数可以调整缩放系数
public class BitmapFactory {
    public static class Options {
        // 默认true
        public boolean inScaled;
        // 无dpi的文件夹下默认160
        public int inDensity;
        // 取决具体屏幕
        public int inTargetDensity;
                // 3.0后引入 
                public Bitmap inBitmap;

                public booleaninJustDecodeBounds;

        public int inSampleSize;
        ......
    }
}</code></pre><p>e.g 处理720 * 720的图片。 </p>
<p>inScaled为false表示不缩放，得到720*720</p>
<p>inScaled为true, 根据inDensity&amp;inTargetDensity来计算缩放系数</p>
<p>缩放系数 = inTargetDensity (实际的density / inDensity)</p>
<p>e.g 1080P 实际density = 480. 图片在drawable下, inDensity 为160 缩放系数为3，解码后的图片为2160 * 2160</p>
<p>如果图片放在xhdpi下 inDensity = 160 * 2 = 320, 缩放系数为480/320 = 1.5 得到的图片为1080 * 1080</p>
<p>可以手动设置inTargetDensity和inDensity来自主解码</p>
<p>inBitmap如果设置了这个属性, 则会重用这个Bitmap的内存从而提升性能，但是重用是有条件的4.4之前只能重用相同大小的Bitmap, 4.4以后只要比重用Bitmap小即可. 不太理解 TODO</p>
<p>加载Bitmap需要先读取Bitmap的原始大小，按缩小了合适的倍数进行加载，这个缩小倍数的计算就是inSampleSize的计算 采样率?</p>
<pre><code>// 根据maxWidth, maxHeight计算最合适的inSampleSize
public static int $sampleSize(BitmapFactory.Options options, int maxWidth, int maxHeight) {

    // raw height and width of image
    int rawWidth = options.outWidth;
    int rawHeight = options.outHeight;

    // calculate best sample size
    int inSampleSize = 0;

    if (rawHeight &gt; maxHeight || rawWidth &gt; maxWidth) {
    float ratioWidth = (float) rawWidth / maxWidth;
    float ratioHeight = (float) rawHeight / maxHeight;    
    inSampleSize = (int) Math.min(ratioHeight, ratioWidth);
}
    inSampleSize = Math.max(1, inSampleSize);

    return inSampleSize;
}</code></pre><p>关于inSampleSize需要注意，它只能是2的次方，否则它会取最接近2的次方的值。</p>
<p>为了节省内存，需要先设置BitmapFactory.Options的inJustDecodeBounds为true，这样的Bitmap可以借助decodeFile方法把高和宽存放到Bitmap.Options中，但是内存占用为空（不会真正的加载图片）。</p>
<p>有了具备高宽信息的Options，结合上面的inSampleSize算法算出缩小的倍数，我们就能加载本地大图的某个合适大小的缩略图了。</p>
<pre><code>/**
 * 获取缩略图
 * 支持自动旋转
 * 某些型号的手机相机图片是反的，可以根据exif信息实现自动纠正
 * @return
 */
public static Bitmap $thumbnail(String path, int maxWidth, int maxHeight, boolean autoRotate) {
    int angle = 0;
    if (autoRotate) {
        angle = ImageLess.$exifRotateAngle(path);
    }

    BitmapFactory.Options options = new BitmapFactory.Options();
    options.inJustDecodeBounds = true;   
    // 获取这个图片的宽和高信息到options中, 此时返回bm为空
    Bitmap bitmap = BitmapFactory.decodeFile(path, options);
// 在下次使用BitmapFactory的decodeFile()等方法实例化Bitmap对象前，别忘记将opts.inJustDecodeBound设置回false。否则获取的bitmap对象还是null。
    options.inJustDecodeBounds = false;   
    // 计算缩放比
    int sampleSize = $sampleSize(options, maxWidth, maxHeight);
    options.inSampleSize = sampleSize;
    options.inPreferredConfig = Bitmap.Config.RGB_565;
    options.inPurgeable = true;
    options.inInputShareable = true;

    if (bitmap != null &amp;&amp; !bitmap.isRecycled()) {
        bitmap.recycle();
    }

    bitmap = BitmapFactory.decodeFile(path, options);
    if (autoRotate &amp;&amp; angle != 0) {
        bitmap = $rotate(bitmap, angle);
    }

    return bitmap;
}</code></pre><p>Matrix变形</p>
<p>每一种变化都包括set, pre, post三种分别为 设置，矩阵先乘，矩阵后乘</p>
<p>圆角，圆形图片的裁剪</p>
<p>圆角我们需要借助Xfermode和PorterDuffXfermode，把圆角矩阵套在原Bitmap上取交集得到圆角Bitmap。</p>
<p>巨图加载</p>
<p>BitmapRegionDecoder可以按区域加载</p>
<p>颜色矩阵ColorMatrix 可以实现很多特效</p>
<p>ThumbnailUtils</p>
<p><a href="http://jayfeng.com/2016/03/16/%E7%90%86%E8%A7%A3ThumbnailUtils/" target="_blank" rel="noopener">http://jayfeng.com/2016/03/16/理解ThumbnailUtils/</a></p>
<p>Bitmap在内存中占用大小取决于:</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&mid=403263974&idx=1&sn=b0315addbc47f3c38e65d9c633a12cd6&scene=0&key=41ecb04b05111003d79189315d2ebdda9a5dc312d579a616c9358c3994f94eaf700ba910fb56c37d348fbe317cbce872&ascene=0&uin=NTMyODkxMDE1&devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.11.2+build(15C50)&version=11020201&pass_ticket=uq%2BZUPewIgxSiSrWWGqLMnd8%2Fy8eclx6vr92bs5s8Q9YVusWCl2cgRirA7iVDRu%2B" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=403263974&amp;idx=1&amp;sn=b0315addbc47f3c38e65d9c633a12cd6&amp;scene=0&amp;key=41ecb04b05111003d79189315d2ebdda9a5dc312d579a616c9358c3994f94eaf700ba910fb56c37d348fbe317cbce872&amp;ascene=0&amp;uin=NTMyODkxMDE1&amp;devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.11.2+build(15C50)&amp;version=11020201&amp;pass_ticket=uq%2BZUPewIgxSiSrWWGqLMnd8%2Fy8eclx6vr92bs5s8Q9YVusWCl2cgRirA7iVDRu%2B</a></p>
<ul>
<li>色彩格式 ARG_8888 一个像素占4个字节 RGB_565 一个像素占2个</li>
<li>原始文件在的资源目录 hdpi, xxhdpi等</li>
<li>目标屏幕的密度</li>
</ul>
<p>计算方法: </p>
<p>float f = 目标屏幕的密度 / 原始文件在的资源目录</p>
<p>f * width * f * height * 色彩格式字节</p>
<p>误差是由精度导致的误差</p>
<p>e.g 522宽度，目标density 640, xxhdpi下计算后</p>
<p>scaledWidth = (int)(522 * 640 / 480 + 0.5f)</p>
<p>大图小用用采样，小图大用用矩阵。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.scions.cn/posts/6384456b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/6384456b/" itemprop="url">Android 沉浸式状态栏</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T09:19:03+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/6384456b/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/6384456b/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>setFitSystemWindow(boolean) 设置是否需要考虑SystemBar占据的区域来显示, true → 系统会适应SystemBar区域，让内容不会遮住</p>
<p>value-19以后</p>
<p><item name="android:windowTranslucentStatus">true</item> 半透明状态栏</p>
<!--Android 5.x开始需要把颜色设置透明，否则导航栏会呈现系统默认的浅灰色-->

<p><item name="android:statusBarColor">@android:color/transparent</item></p>
<p>设置StatusBarColor</p>
<p>21之后AndroidL之后才支持Window.setStatusBarColor</p>
<p>21之前可以通过decroView.add一个view来作为StatusBar的底色</p>
<p>沉浸式状态栏 全屏模式和非全屏模式下的切换会造成抖动，因为根布局发生了变化，造成的界面重新布局</p>
<p><a href="http://liandongyang.coding.me/posts/status-bar-and-immersive-mode/" target="_blank" rel="noopener">http://liandongyang.coding.me/posts/status-bar-and-immersive-mode/</a></p>
<p><a href="https://www.jianshu.com/p/a4d685422604" target="_blank" rel="noopener">https://www.jianshu.com/p/a4d685422604</a></p>
<p><a href="https://juejin.im/entry/5c9afe50e51d45246e414be7" target="_blank" rel="noopener">https://juejin.im/entry/5c9afe50e51d45246e414be7</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ScorpioNeal</p>
              <p class="site-description motion-element" itemprop="description">体系(点 - 线 - 面)</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">258</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ScorpioNeal</span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Bp6gNEmnfgAF2Ci7moO9v4Rm-gzGzoHsz',
        appKey: 'xNstrbz0DRkVzIMvuDNrkAOh',
        placeholder: '要不要说点啥',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <script type="text/javascript" src="/js/src/dynamic_bg.js"></script>
  <script type="text/javascript" src="/js/src/love-click.js"></script>
</body>
</html>
