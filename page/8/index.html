<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Teaching is the best way to learn.">
<meta property="og:type" content="website">
<meta property="og:title" content="ScorpioNeal&#39;s Blog">
<meta property="og:url" content="http://blog.scions.cn/page/8/index.html">
<meta property="og:site_name" content="ScorpioNeal&#39;s Blog">
<meta property="og:description" content="Teaching is the best way to learn.">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ScorpioNeal&#39;s Blog">
<meta name="twitter:description" content="Teaching is the best way to learn.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.scions.cn/page/8/">





  <title>ScorpioNeal's Blog</title>
  








  <link rel="stylesheet" href="/live2d/css/live2d.css">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ScorpioNeal's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            todo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/25/Android-UI优化常用工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/25/Android-UI优化常用工具/" itemprop="url">Android-UI优化常用工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-25T13:45:36+08:00">
                2019-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/25/Android-UI优化常用工具/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/25/Android-UI优化常用工具/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>Analyze with Profile GPU Rendering</li>
<li>TraceView</li>
<li>Systrace</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/24/Android-View的绘制流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/24/Android-View的绘制流程/" itemprop="url">Android-View的绘制流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-24T13:46:32+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/24/Android-View的绘制流程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/24/Android-View的绘制流程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>View的绘制流程是从<code>ViewRootImpl.java</code>中的<code>performTraversales()</code>函数开始的。</p>
<p>包括以下三个阶段</p>
<ul>
<li>measure</li>
<li>layout</li>
<li>draw</li>
</ul>
<h2 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure"></a>onMeasure</h2><p>用于测量<code>view</code>的大小, <code>View</code>中的<code>measure</code>方法，接收2个参数, <code>widthMeasureSpec</code>和<code>heightMeasureSpec</code></p>
<p><code>MeasureSpec</code>由<code>specSize</code>和<code>specMode</code>构成，<code>specSize</code>表示大小, <code>specMode</code>表示规格, 有三种情况</p>
<ul>
<li>EXACTLY 表示父布局希望子布局的大小由specSize决定<ul>
<li>Measure specification mode: The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.</li>
</ul>
</li>
<li>AT_MOST 表示子布局最大只能是specSize中指定的大小 <ul>
<li>Measure specification mode: The child can be as large as it wants up to the specified size.</li>
</ul>
</li>
<li>UNSPECIFIED 没有限制 <ul>
<li>Measure specification mode: The parent has not imposed any constraint on the child. It can be whatever size it wants. widthMeasureSpec和heightMeasureSpec由父view计算后传给子view, 也就是说父View在一定程度上决定子view的大小。</li>
</ul>
</li>
</ul>
<p>其中, rootView的measureSpec是这么来的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);  </span><br><span class="line">    childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height); </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span>      rootDimension)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> measureSpec;  </span><br><span class="line">        <span class="keyword">switch</span> (rootDimension) &#123;  </span><br><span class="line">            <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:  </span><br><span class="line">                measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> ViewGroup.LayoutParams.WRAP_CONTENT:  </span><br><span class="line">                measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">default</span>:  </span><br><span class="line">                measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> measureSpec;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  View.java</span><br><span class="line">  <span class="comment">// final的方法，不允许override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      measure();</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">      setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">              getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  setMeasuredDimension()之后，getMeasuredWidht&amp;Height才有值，否则为<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout"></a>onLayout</h2><p>给视图进行布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">host.layout(<span class="number">0</span>, <span class="number">0</span>, host.mMeasuredWidth, host.mMeasuredHeight);</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    onLayout(changed, l, t, r, b);</span><br><span class="line">    <span class="comment">// getWidth = r - l;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">View.java</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//View中是个空方法, 因为onLayout()过程是为了确定视图在布局中的位置，而这个操作应该有布局来完成.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ViewGroup.java</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line">    <span class="comment">// 也就是说ViewGroup子类必须重写这个方法</span></span><br></pre></td></tr></table></figure>

<p><code>view</code>在<code>onLayout()</code>之后，就可以调用<code>getWidth()</code>和<code>getHeight()</code>方法来获取<code>View</code>的宽高。</p>
<p>Tips: getWidth()和getMeasuredWidth()的区别</p>
<p>首先 <code>getMeasuredWidth()</code>方法在<code>measure()</code>过程结束后就可以获取到了，而<code>getWidth()</code>方法要在<code>layout()</code>之后才能拿到。另外, <code>getMeasuredWidth()</code>方法的值是通过<code>setMeasuredDimension()</code>方法进行设置的而<code>getWidth()</code>方法返回的值则是通过视图右坐标减去左坐标计算得到的。</p>
<h2 id="onDraw"><a href="#onDraw" class="headerlink" title="onDraw"></a>onDraw</h2><p>绘制过程</p>
<p><code>invalidate()</code>方法虽然最终会调用到<code>performTraversals()</code>方法中。但这时<code>measure</code>和<code>layout</code>流程是不会重新执行的， 因为视图没有强制重新测量的标志，而且大小也没有发生过变化，所以这时只有<code>draw</code>流程执行。</p>
<p>而如果你希望视图的绘制流程可以完整的走一遍，就要使用<code>requestLayout()</code>而不是<code>invalidate()</code></p>
<p>每次绘制的时候并不会重新绘制所有的<code>View Tree</code>视图，而是去绘制需要重绘的(View内部的标示位DRAWN)</p>
<p>流程:</p>
<ol>
<li>绘制View背景</li>
<li>渐变框作准备???</li>
<li>onDraw()</li>
<li>dispatchDraw() 遍历每个子视图， 绘制子视图draw()</li>
<li>绘制滚动条</li>
</ol>
<p>View坐标系</p>
<p><img src="http://img-scions.test.upcdn.net/view.jpeg" alt="View坐标系"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/24/Android-AsyncLayoutInflator原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/24/Android-AsyncLayoutInflator原理/" itemprop="url">Android-AsyncLayoutInflator原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-24T10:50:01+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/24/Android-AsyncLayoutInflator原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/24/Android-AsyncLayoutInflator原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>AsyncInflatInflator源码其实很简单。 </p>
<p>总结来说，就是开启一个线程，进行inflate操作，如果inflate失败，会调用原有线程的inflate操作. inflate成功后返回view, 没有attachToRoot, 需要自己去处理.<br>内部原理需要注意的地方，都以注释方式加上了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncLayoutInflater</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"AsyncLayoutInflater"</span>;</span><br><span class="line"></span><br><span class="line">    LayoutInflater mInflater;</span><br><span class="line">    Handler mHandler;</span><br><span class="line">    InflateThread mInflateThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncLayoutInflater</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原来的inflater</span></span><br><span class="line">        mInflater = <span class="keyword">new</span> BasicInflater(context);</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(mhandlerCallback);</span><br><span class="line">        <span class="comment">// 单线程</span></span><br><span class="line">        mInflateThread = InflateThread.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UiThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resid, @Nullable ViewGroup parent, @NonNull OnInflateFinishedListener callback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == callback) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback argument may not be null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        InflateRequest request = mInflateThread.obtainRequest();</span><br><span class="line">        request.inflater = <span class="keyword">this</span>;</span><br><span class="line">        request.resid = resid;</span><br><span class="line">        request.parent = parent;</span><br><span class="line">        request.callback = callback;</span><br><span class="line">        mInflateThread.enqueue(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnInflateFinishedListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onInflateFinished</span><span class="params">(@NonNull View view, @LayoutRes <span class="keyword">int</span> resid,</span></span></span><br><span class="line"><span class="function"><span class="params">                               @Nullable ViewGroup parent)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InflateRequest</span> </span>&#123;</span><br><span class="line">        AsyncLayoutInflater inflater;</span><br><span class="line">        ViewGroup parent;</span><br><span class="line">        <span class="keyword">int</span> resid;</span><br><span class="line">        View view;</span><br><span class="line">        OnInflateFinishedListener callback;</span><br><span class="line"></span><br><span class="line">        InflateRequest() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler.Callback mhandlerCallback = <span class="keyword">new</span> Handler.Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            InflateRequest request = (InflateRequest)msg.obj;</span><br><span class="line">            <span class="keyword">if</span>(request.view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果inflate失败，会调用原来的inflater去inflate布局</span></span><br><span class="line">                <span class="comment">// 而且没有attachToRoot, 需要自己去处理返回的request.view</span></span><br><span class="line">                request.view = mInflater.inflate(request.resid, request.parent, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            request.callback.onInflateFinished(request.view, request.resid, request.parent);</span><br><span class="line">            mInflateThread.releaseRequest(request);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicInflater</span> <span class="keyword">extends</span> <span class="title">LayoutInflater</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] sClassPrefixList = &#123;</span><br><span class="line">                <span class="string">"android.widget."</span>,</span><br><span class="line">                <span class="string">"android.webkit."</span>,</span><br><span class="line">                <span class="string">"android.app."</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        BasicInflater(Context context) &#123;</span><br><span class="line">            <span class="keyword">super</span>(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">cloneInContext</span><span class="params">(Context newContext)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BasicInflater(newContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> View <span class="title">onCreateView</span><span class="params">(String name, AttributeSet attrs)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(String prefix : sClassPrefixList) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 不是很清楚这里</span></span><br><span class="line">                    View view = createView(name, prefix, attrs);</span><br><span class="line">                    <span class="keyword">if</span>(view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> view;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InflateThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InflateThread sInstance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> InflateThread();</span><br><span class="line">            sInstance.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InflateThread <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> sInstance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//阻塞队列， 如果inflate request超过10个会阻塞</span></span><br><span class="line">        <span class="keyword">private</span> ArrayBlockingQueue&lt;InflateRequest&gt; mQueue = <span class="keyword">new</span> ArrayBlockingQueue&lt;InflateRequest&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象池， 不用多次创建对象，内存优化</span></span><br><span class="line">        <span class="keyword">private</span> Pools.SynchronizedPool&lt;InflateRequest&gt; mRequestPool = <span class="keyword">new</span> Pools.SynchronizedPool&lt;InflateRequest&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                runInner();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runInner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            InflateRequest request;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                request = mQueue.take();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                request.view = request.inflater.mInflater.inflate(request.resid, request.parent, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送给调用处的handler</span></span><br><span class="line">            Message.obtain(request.inflater.mHandler, <span class="number">0</span>, request).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> InflateRequest <span class="title">obtainRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            InflateRequest obj = mRequestPool.acquire();</span><br><span class="line">            <span class="keyword">if</span>(obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                obj = <span class="keyword">new</span> InflateRequest();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(InflateRequest request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mQueue.put(request);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Failed to enqueue async inflate request"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseRequest</span><span class="params">(InflateRequest obj)</span> </span>&#123;</span><br><span class="line">            obj.callback = <span class="keyword">null</span>;</span><br><span class="line">            obj.inflater = <span class="keyword">null</span>;</span><br><span class="line">            obj.parent = <span class="keyword">null</span>;</span><br><span class="line">            obj.resid = <span class="number">0</span>;</span><br><span class="line">            obj.view = <span class="keyword">null</span>;</span><br><span class="line">            mRequestPool.release(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/24/Android-抽象布局的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/24/Android-抽象布局的使用/" itemprop="url">Android-抽象布局的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-24T09:41:49+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/24/Android-抽象布局的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/24/Android-抽象布局的使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h2><ul>
<li>include</li>
<li>merge</li>
<li>viewstub</li>
</ul>
<h2 id="include"><a href="#include" class="headerlink" title="include"></a>include</h2><p>重用布局文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/layout_file"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以在<code>include</code>中指定<code>id</code>， 如果这样，会覆盖<code>layout_file</code>中的<code>id</code></p>
<h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><p>减少视图层级, 多用于替换<code>FramenLayout</code>或者当一个布局包含另一个时</p>
<p>Since the <code>FrameLayout</code> has the same dimension as its parent, by the virtue of using the <code>match_parent</code> constraints, and does not define any background, extra padding or a gravity, it is totally useless, we can use merge tag to replace it. (也就是说，当前布局根布局如果使用的是<code>Framelayout</code>而且与父布局完全一致，那么当前这层布局的根布局就可以省略，使用<code>merge</code>代替)</p>
<p>When the <code>LayoutInflater</code> encounters this tag, it skips it and adds the <code>&lt;merge/&gt;</code> children to the <code>&lt;merge/&gt;</code> parent. (当<code>LayoutInflater</code>解析<code>xml</code>时，如果遇到了<code>merge</code>标签，那么他会忽略这个标签，而是把他的子布局添加到他的父布局里，具体参见<a href>setContentView与LayoutInflater加载解析机制源码解析</a>)</p>
<p>You can’t use this trick if your layout was using a <code>LinearLayout</code> as its root tag. (根布局使用<code>LinearLayout</code>的时候不能用merge替代)</p>
<p><code>&lt;merge&gt;</code> can only be used as the root tag of an XML layout.(<code>merge</code>标签只能用于根布局)</p>
<p>When inflating a layout starting with a <code>&lt;merge/&gt;</code>, you must specify a parent ViewGroup and you must set attachToRoot to true.(使用<code>LayoutInflater</code>解析<code>xml</code>时，如果<code>xml</code>以<code>merge</code>开始，你必须在解析时指定<code>parent viewgroup</code>和<code>attachToRoot = true</code>)</p>
<h2 id="viewstub"><a href="#viewstub" class="headerlink" title="viewstub"></a>viewstub</h2><p>需要的时候才加载</p>
<p>It has no dimension, it does not draw anything and does not participate in the layout in any way.</p>
<p><code>ViewStub</code>只能<code>inflate</code>一次，之后<code>ViewStub</code>对象就会被置为空, 换句话说，某个被<code>ViewStub</code>指定的布局被<code>inflate</code>后，就不能再通过<code>ViewStub</code>来控制它了.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ViewStub</span>&gt;</span></span><br><span class="line">  android:id=""</span><br><span class="line">  android:layout="to refreence what layout file to include and inflate"</span><br><span class="line">  android:inflatedId="can be used to override the id of the root of the included file"</span><br><span class="line"><span class="tag">&lt;/<span class="name">ViewStub</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>When you are ready to inflate the stub, simply invoke the inflate() method. you can also simply change the visiblity of the stub to VISIBLE or INVISIBLE and the stub will inflate.(使用的时候，你可以通过<code>inflate()</code>方法来加载这个布局，也可以简单的通过设置 <code>VISIBLE</code>和<code>INVISIBLE</code>来控制)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/21/Java-《Java编程的逻辑》-容器类/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/21/Java-《Java编程的逻辑》-容器类/" itemprop="url">Java- 《Java编程的逻辑》_容器类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-21T09:10:18+08:00">
                2019-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/21/Java-《Java编程的逻辑》-容器类/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/21/Java-《Java编程的逻辑》-容器类/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Collections子接口"><a href="#Collections子接口" class="headerlink" title="Collections子接口"></a>Collections子接口</h2><p><img src="http://img-scions.test.upcdn.net/Collection.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/19/Java-《Java编程的逻辑》-并发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/19/Java-《Java编程的逻辑》-并发/" itemprop="url">Java-《Java编程的逻辑》- 并发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-19T10:38:04+08:00">
                2019-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/19/Java-《Java编程的逻辑》-并发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/19/Java-《Java编程的逻辑》-并发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="并发总结"><a href="#并发总结" class="headerlink" title="并发总结"></a>并发总结</h1><p>多线程2个核心问题， <code>竞争</code>和<code>协作</code></p>
<ul>
<li><p>竞争 -&gt; 线程安全的机制</p>
<ul>
<li>synchronized</li>
<li>显示锁</li>
<li>volatile</li>
<li>原子变量和CAS</li>
<li>写时复制 CopyOnWriteArrayList, 讲共享变量变成只读的，写的时候再需要锁, 写的线程不是直接修改原对象，而是创建一个对象，对该对象修改完毕后再原子性的修改共享访问的变量，让他指向新的对象</li>
<li>ThreadLocal</li>
</ul>
</li>
<li><p>协作 -&gt; 线程的协作</p>
<ul>
<li>wait/notify</li>
<li>显示条件</li>
<li>线程的中断</li>
<li>协作工具类 Semaphore, CountDownLatch, CyclicBarrier</li>
<li>并发队列</li>
<li>Future/FutureTask</li>
</ul>
</li>
<li><p>容器类</p>
<ul>
<li>写时复制的List&amp;Set</li>
<li>ConcurrentHashMap</li>
<li>基于SkipList的Map &amp; Set</li>
</ul>
</li>
<li><p>任务执行服务</p>
<ul>
<li>Runnable, Callable, Executor, ExecutorService, Future etc</li>
<li>线程池</li>
<li>定时任务</li>
</ul>
</li>
<li><p>其他</p>
<ul>
<li>Java7引入的Fork&amp;Join</li>
<li>Java8并行流</li>
<li>CompletionService</li>
<li>Java8引入的CompletableFuture</li>
<li>…</li>
</ul>
</li>
</ul>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>线程表示一条单独的执行流，他有自己的程序计数器，有自己的栈.</p>
<p>Que: 为什么调用的是start, 执行的却是run呢?<br>Ans: start表示启动该线程，使其成为一条单独的执行流，操作系统会分配线程相关的资源, 每个线程都会有单独的程序计数器和栈，操作系统会把这个线程作为一个独立的个体进行调度，分配时间片让他执行，执行的起点就是run方法 。</p>
<h3 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h3><p>通过<code>public State getState()</code>获取，有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</span><br><span class="line">	NEW, <span class="comment">//没有调用start的线程</span></span><br><span class="line">	RUNNABLE, <span class="comment">//调用start后的线程且没有阻塞时的状态</span></span><br><span class="line">	BLOCKED, </span><br><span class="line">	WAITING,</span><br><span class="line">	TIMED_WAITING,</span><br><span class="line">	TERMINATED <span class="comment">//运行结束后的状态</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// BLOCKED, WAITING, TIMED_WAITING都是阻塞时的状态</span></span><br></pre></td></tr></table></figure>

<p>通过<code>public final boolean isAlive()</code>获取线程是否活着，启动后，run运行完之前都是alive</p>
<h3 id="deamon线程"><a href="#deamon线程" class="headerlink" title="deamon线程"></a>deamon线程</h3><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Thread.sleep. 让当前线程睡眠指定时间，但这个时间不一定是确切的给定毫秒数。与系统精度有关。 睡眠期间，线程可以被中断，如果被中断，sleep会抛出InterruptedException<br>Thread.yield. 让出CPU, 告诉CPU当前线程不着急占用CPU,不可以依赖此方法<br>Thread.join. 可以让调用join的线程等待该线程结束。join() -&gt; waits for this thread to die</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">e.g </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">	Thread thread = <span class="keyword">new</span> HelloWorldThread();</span><br><span class="line">	thread.start();</span><br><span class="line">	thread.join();  <span class="comment">// main线程等待thread执行完后才结束</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//blog.csdn.net/programmer_at/article/details/78934278</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       Thread t1 = <span class="keyword">new</span> ChildThread(list);</span><br><span class="line">       Thread t2 = <span class="keyword">new</span> ChildThread(list);</span><br><span class="line">       t1.start();</span><br><span class="line">       t2.start();</span><br><span class="line">       t1.join(); <span class="comment">//这里t1和t2会轮流执行，而不是t2在t1执行完后再执行，因为join阻塞的是这个join方法调用所在的线程，也就是main线程</span></span><br><span class="line">       t2.join();</span><br><span class="line">       System.out.println(shared);</span><br><span class="line">       System.out.println(list);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="竞争"><a href="#竞争" class="headerlink" title="竞争"></a>竞争</h2><p>多条执行流操作相同变量的时候会出现一些异常问题:</p>
<ul>
<li>竞态条件 race condition</li>
<li>内存可见性问题   都个线程可以共享访问和操作相同的变量，但一个线程对一个共享变量的修改，另一个线程不一定可以马上就能看到，甚至永远看不到。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">e.g 内存可见性问题</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisiblityDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> shutdown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">   	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">       	<span class="meta">@Override</span></span><br><span class="line">       	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           	<span class="keyword">while</span> (!shutdown) &#123;</span><br><span class="line"></span><br><span class="line">           	&#125;</span><br><span class="line">           	System.out.println(<span class="string">"exit hello"</span>);</span><br><span class="line">       	&#125;</span><br><span class="line">   	&#125;</span><br><span class="line"></span><br><span class="line">   	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       	<span class="keyword">new</span> HelloWorld().start();</span><br><span class="line">       	Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">       	shutdown = <span class="keyword">true</span>;</span><br><span class="line">       	System.out.println(<span class="string">"exit main"</span>);</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">期望结果HelloThread在shutdown为<span class="keyword">true</span>的时候结束并输出exit hello, main结束并输出exit main</span><br><span class="line">实际执行时候可能发现, HelloThread永远都不会退出，也就是HelloThread执行流看shutdown永远为<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">内存可见性问题: 在计算机系统中，除了内存，数据还会被缓存在CPU的寄存器以及各级缓存中，当访问一个变量的时候，可能直接从寄存器或CPU缓存中获取，而不一定到内存中去取，当修改一个变量时，也可能是先写到缓存中，稍后才会同步更新到内存中。在单线程的程序里，这一般不是问题，但是在多线程程序里，尤其是在有多CPU的情况下，一个线程对内存的修改，另一个线程看不到，一是修改没有及时同步到内存，二是另一个线程根本没有从内存里读取。</span><br><span class="line"></span><br><span class="line">解决方法:</span><br><span class="line">	<span class="number">1</span>. 使用volitile关键字</span><br><span class="line">	<span class="number">2</span>. 使用<span class="keyword">synchronized</span>关键字或者显示锁同步。</span><br></pre></td></tr></table></figure>

<p>线程调度和切换是有成本的. 一个线程被切换出去后，操作系统需要保存它的当前上下文状态到内存，上下文状态包括当前CPU寄存器的值,程序计数器的值等，而一个线程被切换回来后，OS需要恢复它原来的上下文状态，整个过程称为 <code>上下文切换</code>， 这个切换不仅耗时，而且使CPU中的很多缓存失效. </p>
<p>如果执行的任务是CPU密集型的，即主要消耗的都是CPU，那创建超过CPU数量的线程就是没有必要的，并不会加快程序的执行。</p>
<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p><code>synchronized实例方法</code> 实际保护的是同一个对象的方法调用，确保同时只能有一个线程执行。 或者说，<code>synchronized实例方法</code>保护的是当前实例对象, 即this对象, this对象有一个锁和一个等待队列， 锁只能被一个线程持有，其他试图获得同样的锁的线程需要等待。 过程大致如下:</p>
<ol>
<li>尝试获取锁，如果获取到了，进行下一步，否则加入等待队列阻塞并等待被唤醒</li>
<li>执行实例方法体代码</li>
<li>释放锁，如果等待队列上有等待的线程，从中选取一个进行唤醒，如果有多个线程等待，唤醒哪个是不确定的，不保证公平性，也就是不保证等待久的先被唤醒</li>
</ol>
<p>synchronized不能防止非synchronized方法被同时执行，因此，一般在保护变量时， 需要在所有访问该变量的方法上加上synchronized。</p>
<p>synchronized同步的对象可以是任意对象，任意对象都有一个锁和等待队列。</p>
<p>synchronized特性：</p>
<ul>
<li>可重入性, 对同一个执行线程，他在获得了锁之后，在调用其他需要同样锁的代码时，可以直接调用，比如，在一个synchronized实例方法内，可以直接调用其他synchronized实例方法。但是并不是所有的锁都是可重入的。 可重入锁是通过记录锁的持有线程和持有数量来实现的， 当调用被synchronized保护的代码时，检查对象是否已被锁，如果是，再检查是否被当前线程锁定，如果是，增加持有数量，如果不是被当前线程锁定，才加入等待队列，释放锁时，减少持有数量，当数量变为0才释放整个锁。</li>
<li>内存可见性。释放锁时，所有写入都会写回内存，获取锁后，都会从内存里读取最新数据, 但是只是为了保证内存可见性，使用synchronized成本有点高，使用轻量级的volitile就可以了</li>
</ul>
<p>死锁，A等待B的锁释放，B等待A的锁释放导致，AB陷入互相等待。所以应该避免在持有一个锁的同时去申请另一个锁，如果确实需要多个锁，所有代码都应该按照相同的顺序去申请。或者使用显示锁Lock, 它支持tryLock和带时间限制的获取锁的方法来避免死锁</p>
<h3 id="显示锁"><a href="#显示锁" class="headerlink" title="显示锁"></a>显示锁</h3><p>锁接口 Lock, 主要实现类ReentrantLock<br>读写锁接口ReadWriteLock, 主要实现类ReentrantReadWriteLock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>/<span class="title">unlock</span><span class="params">()</span></span>;   普通的获取锁和释放锁, lock会阻塞直到成功</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InteruptedException</span>; 可以响应中断的lock, 如果被其他线程中断了，会抛出InterruptedException</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>; 尝试获取锁，立即返回，不阻塞，成功返回<span class="keyword">true</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span>; 先尝试获取锁 如果成功立即返回<span class="keyword">true</span>, 否则阻塞等待time时间，会响应中断</span><br><span class="line"><span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span>; 新建一个条件, 一个lock可以关联多个条件</span><br></pre></td></tr></table></figure>

<p>相比synchronized, lock可以以非阻塞的形式获取锁，响应中断，限时，更加灵活</p>
<h3 id="可重入锁-ReentrantLock"><a href="#可重入锁-ReentrantLock" class="headerlink" title="可重入锁 ReentrantLock"></a>可重入锁 ReentrantLock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span></span>; <span class="comment">//是否保证公平，默认为false. 公平表示，等待最长的线程优先获取锁，这个机制会影响性能，默认不保证</span></span><br></pre></td></tr></table></figure>

<p>一般把lock之后的代码放入try中，finally里释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	counter++;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tryLock<br>使用tryLock()可以避免死锁，在持有一个锁获取另一个锁而获取不到的时候，可以释放已有的锁，给其他线程获取锁的机会，然后重试获取所有锁</p>
<p>ReentrantLock实现原理<br>依赖CAS方法以及LockSupport类中的一些方法. //TODO 未细看</p>
<p>synchronized代表一种声明式编程思维，显示锁代表一种命令式编程思维。 简单总结就是能用synchronized就用synchronized,不满足条件是再考虑ReentrantLock</p>
<h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><h3 id="原子变量和CAS"><a href="#原子变量和CAS" class="headerlink" title="原子变量和CAS"></a>原子变量和CAS</h3><p>对于使用synchronized来保证原子更新操作的成本太高了，一些情况下可以直接使用原子变量代替</p>
<p>AutomicBoolean , AtomicInteger, AtomicLong, AtomicReference等等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Visitor</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                counter.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">1000</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[num];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Visitor();</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">            threads[i].join();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(counter.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里总是会输出正确结果 1000000</span></span><br></pre></td></tr></table></figure>

<p>原理如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主要内部成员为:</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(; ;) &#123;</span><br><span class="line">		<span class="keyword">int</span> current = get();</span><br><span class="line">		<span class="keyword">int</span> next = current + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(compareAndSet(current, next)) &#123;</span><br><span class="line">			<span class="keyword">return</span> next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">先调取当前值current, 计算期望值next, 然后调用CAS进行更新，如果更新没有成功，说明value被别的线程更改了，则再去取最新值并尝试更新直到成功为止。</span><br><span class="line">一般应用程序不应该直接调用CAS, 原理上一般的操作系统在硬件层次上都支持CAS指令 </span><br><span class="line">具体CAS解析 </span><br><span class="line">CAS有<span class="number">3</span>个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Atomically sets the value to the given updated value</span></span><br><span class="line"><span class="comment">    * if the current value &#123;<span class="doctag">@code</span> ==&#125; the expected value.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> expect the expected value</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> update the new value</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if successful. False return indicates that</span></span><br><span class="line"><span class="comment">    * the actual value was not equal to the expected value.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   这里的<span class="keyword">this</span>结合valueOffset则就是AtomicInteger的实际值，而current是线程修改时用到的初值，如果实际值和初值一致，则说明当前并没有人修改AtomicInteger，故当前修改有效，那么就可以继续赋值为update。</span><br></pre></td></tr></table></figure>

<p>synchronized是悲观的，假定更新很可能冲突，所以先获取锁，得到锁后才更新，是一种阻塞式算法。 原子变量的更新逻辑是乐观的，假定冲突比较少，即使又冲突，继续尝试就好了。是非阻塞式的，性能高于synchronized</p>
<p>Java提供的非阻塞式容器:</p>
<ul>
<li>ConcurrentLinkedQueue &amp; ConcurrentLinkedDeque</li>
<li>ConcurrentSkipListMap &amp; ConcurrentSkipListSet</li>
</ul>
<p>CAS的方式有一个ABA的问题，就是当前值为A被另一个线程先修改为B再修改为A，当前线程CAS操作无法分辨当前值是否发生过变化。 ABA一般不是问题，如果确实有需要可以使用AtomicStampedReference， 在修改值的时候附加一个时间戳</p>
<h3 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h3><ul>
<li>线程安全， 可以被多个线程并发访问</li>
<li>迭代器不支持修改操作，但也不会抛出ConcurrentModificaitonException</li>
<li>以原子方式支持一些符合操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addIfAbsent</span><span class="params">(E e)</span> <span class="comment">//不存在才添加, 添加返回true</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addAllAbsent</span><span class="params">(Collection&lt;? extends E&gt; c)</span> <span class="comment">//批量添加C中的非重复元素，不存在才添加，返回实际添加个数</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CopyOnWriteArrayList内部是一个数组，但是这个数组以原子方式被整体更新的。 每次修改操作， 都会新建一个数组，复制原数组的内容到新数组， 在新数组上进行需要的更改，然后以原子方式设置内部的数组引用， 这就是写时复制。<br>所有的读操作，都是先拿到当前引用的数组，然后直接访问该数组， 读的过程中， 可能内部的数据已经被修改了，但不会影响读操作，读的依旧是原数组内容</p>
<p>读不需要锁， 可以并行， 读和写也可以并行，但不能多个线程同时写，同时写需要锁</p>
<p>CopyOnWriteArrayList性能很低， 不适用于数组很大且修改频繁的场景.</p>
<h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>每一个线程都有个map, 对于每个ThreadLocal对象，调用其get/set实际上就是以ThreadLocal对象为key读写当前线程的map</p>
<h2 id="协作"><a href="#协作" class="headerlink" title="协作"></a>协作</h2><p>线程协作的场景:</p>
<ul>
<li>生产者/消费者协作模式</li>
<li>同时开始</li>
<li>等待结束 主从协作模式，主线程讲任务分解为若干任务，主线程再继续执行其他任务前需要等待这些子线程执行完毕</li>
<li>异步结果 主从协作模式中，主线程手动创建自线程的写法比较麻烦，常见的模式时将子线程的管理封装为异步调用，异步调用完马上返回，但返回的不是最终结果而是Future的对象，通过它可以在随后获取最终结果</li>
<li>集合点 每个线程负责一部分计算，在集合点等待其他线程完成，等到齐后，交换数据和计算结果在进行下一次的迭代。</li>
</ul>
<h3 id="wait-notify"><a href="#wait-notify" class="headerlink" title="wait/notify"></a>wait/notify</h3><p>线程协作的基本机制是wait/notify</p>
<p>wait() 也就是 wait(0)表示无限期等待， 在等待期间都可以被中断，如果被中断，会抛出InterruptedException.</p>
<p>wait原理:<br>每个对象都有一把锁和等待队列，一个线程在进入synchronized代码块时会尝试获取锁，如果获取不到会把当前线程加入等待队列中，其实，除了锁的等待队列，每个对象还有另一个等待队列，表示条件队列，该队列用于线程的协作。 调用wait会把当前线程放到条件队列上并阻塞，表示当前线程执行不下去，需要等待一个条件，这个条件需要其他线程来更改，调用对象的notify, notify做的事情就是从条件队列里选一个线程，并将其从队列中移除并唤醒，notify和notifyAll的区别就是notifyAll会移除对象条件队列所有的线程并全部唤醒</p>
<p>调用wait/notify方法时， 当前线程没有持有对象锁，会抛出java.lang.IllegalMonitor-StateException</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> fire = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">   	 	<span class="meta">@Override</span></span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                	<span class="keyword">while</span>(!fire) &#123;</span><br><span class="line">                    	wait();</span><br><span class="line">                	&#125;</span><br><span class="line">            	&#125;</span><br><span class="line">            	System.out.println(<span class="string">"fired"</span>);</span><br><span class="line">        	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">        	&#125;</span><br><span class="line">    	&#125;</span><br><span class="line"></span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">fire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="keyword">this</span>.fire = <span class="keyword">true</span>;</span><br><span class="line">        	notify();</span><br><span class="line">    	&#125;</span><br><span class="line"></span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        	WaitThread waitThread = <span class="keyword">new</span> WaitThread();</span><br><span class="line">        	waitThread.start();</span><br><span class="line">        	Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        	System.out.println(<span class="string">"fire"</span>);</span><br><span class="line">        	waitThread.fire();</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Question: wait在synchronized保护中， 第一个线程在wait时，另一个线程怎么能调用到同在synchronized保护的notify方法呢?<br>Answer:</p>
<p>wait的具体过程是 :</p>
<ol>
<li>把当前线程放入条件等待队列，释放对象锁，阻塞等待，线程状态变为WAITING或TIMED_WAITING</li>
<li>等待时间到或者被其他线程调用notify/notifyAll从条件队列中移除，这时要重新竞争对象锁<ul>
<li>如果能够获得锁，线程状态变为RUNNABLE, 并从wait调用中返回</li>
<li>否则，该线程加入对象锁的等待队列，线程状态变为BLOCKED, 只有获取锁后才会从wait调用返回</li>
</ul>
</li>
</ol>
<p>调用notify会把条件队列中等待的线程唤醒并从队列中移除，但他不会释放对象锁，也就是说，只有在包含notify的synchronized代码块执行完后，等待的线程才会从wait调用中返回</p>
<p>wait/notify它们被不同的线程调用，但共享相同的锁和条件等待队列（相同对象的synchronized代码块里),它们围绕一个共享的条件变量进行协作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBlockingQueue</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;E&gt; queue = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBlockingQueue</span><span class="params">(<span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.limit = limit;</span><br><span class="line">        queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;(limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (queue.size() == limit) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        queue.add(e);</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (queue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        E e = queue.poll();</span><br><span class="line">        notifyAll();</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>局限性, 只能有一个条件等待队列。</p>
<p>Java提供了专门的阻塞队列实现</p>
<ul>
<li>接口BlockingQueue和BlockingDequeue</li>
<li>基于数组的实现类ArrayBlockingQueue</li>
<li>基于链表的实现类LinkedBlockingQueue 和 LinkedBlockingDeque</li>
<li>基于堆的实现类PriorityBlockingQueue</li>
</ul>
<p>实际上join就是调用了wait实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!isAlive()) &#123;</span><br><span class="line">	wait(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要线程是活着的，join就一直等待，当线程运行结束后，Java系统调用notifyAll来通知</p>
<h3 id="显示条件"><a href="#显示条件" class="headerlink" title="显示条件"></a>显示条件</h3><p>锁用于解决竞态条件问题，条件是线程间的协作机制。 显示锁与synchronized相对应， 显示条件与wait/notify相对应。 wait/notify与synchronized配合使用，显示条件与显示锁配合使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Lock接口定义创建条件方法</span><br><span class="line"><span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">awaitUninterruptibly</span><span class="params">()</span></span>; <span class="comment">//其他均响应中断，此方法不响应中断</span></span><br><span class="line">	<span class="function"><span class="keyword">long</span> <span class="title">awaitNanos</span><span class="params">(<span class="keyword">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">signalAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// await与wait对应, 调用await方法前需要先获取锁, 没有的话会抛异常IllegalMonitorStateException, await进入等待队列后会释放锁，释放CPU, 当其他线程将它唤醒后，或者等待超时后，或者发生中断异常后，它都需要重新获取锁，获取锁之后，才会从await方法中退出</span></span><br><span class="line"><span class="comment">// signal对于notify</span></span><br></pre></td></tr></table></figure>

<p>ReentrantLock Condition的实现原理 // TODO….</p>
<h3 id="线程的中断"><a href="#线程的中断" class="headerlink" title="线程的中断"></a>线程的中断</h3><p>Java中，停止一个线程的主要机制是中断，中断并不是强迫终止一个线程，它是一种协作机制，是给线程传递一个取消信号，但是由线程来决定如何以及何时退出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterrupted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">interrupted</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>每一个线程都有一个标志位, 表示该线程是否被中断了.</p>
<ol>
<li>isInterrupted 返回对应线程的中断标志位是否为true</li>
<li>interrupted 返回当前线程的中断标志位是否为true, 并且 清空中断标志位</li>
<li>interrupt 表示中断对应的线程</li>
</ol>
<p>中断对线程的意义与线程的状态和正在进行的IO操作有关。这里我们主要考虑线程的状态</p>
<ul>
<li>RUNNABLE : 线程在运行或具备运行条件，只是在等待操作系统调度<br>  interrupt()只是会设置线程的中断标志位，没有其他作用，线程应该自身在合适位置检查中断标志位</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">		<span class="comment">// do something....</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>WAITING/TIMED_WAITING: 线程在等待某个条件或超时<br>  线程调用join/wait/sleep方法会进入WAITING/TIMED_WAITING状态，这些状态时，对线程调用interrupt()会使得该线程抛出InteruptedException, 需要注意的是， 抛出异常后，中断标志位会被清空而不是被设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">	run() &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">1999</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">			System.out.println(isInterrupted()) <span class="comment">//...返回false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>BLOCKED 线程在等待锁，试图进入同步块 </p>
<p>  线程在等待锁，对线程对象调用interrupted()只是会设置线程的中断标志位，线程依然会处于BLOCKED状态</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">INterruptSynchronizedDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"exit"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            A a = <span class="keyword">new</span> A();</span><br><span class="line">            a.start();</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            a.interrupt();</span><br><span class="line">            a.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里线程A进入锁等待队列，随后test调用a的interrupted并不会结束a, 在使用synchronized关键字获取锁的过程中不响应中断请求，这也是synchronized的局限性</p>
<ul>
<li><p>NEW/TERMINATED 线程还未启动或已结束</p>
<p>  interrupted()对他没有任何影响，中断标志位也不会设置</p>
</li>
</ul>
<h3 id="协作工具类"><a href="#协作工具类" class="headerlink" title="协作工具类"></a>协作工具类</h3><ul>
<li>ReentrantReadWriteLock 在读多写少的场景里使用ReentrantReadWriteLock替代ReentrantLock提高性能</li>
<li>Semaphore 限制对资源的并发访问数</li>
<li>CountDownLatch 实现不同角色线程间的同步</li>
<li>CyclicBarrier 实现同一角色线程间的协调一致</li>
</ul>
<h3 id="并发队列"><a href="#并发队列" class="headerlink" title="并发队列"></a>并发队列</h3><p>// TODO…<br>无锁非阻塞并发队列: ConcurrentLinkedQueue &amp; ConcurrentLinkedDequeue<br>普通阻塞队列: 基于数组的ArrayBlockingQueue, 基于链表的LinkedBlockingQueue, LinkedBlockingDequeue<br>优先级阻塞队列: PriorityBlockingQueue<br>延时阻塞队列: DelayQueue<br>其他阻塞队列: SynchronousQueue &amp; LinkedTransferQueue</p>
<h2 id="并发容器类"><a href="#并发容器类" class="headerlink" title="并发容器类"></a>并发容器类</h2><h3 id="CopyOnWriteList"><a href="#CopyOnWriteList" class="headerlink" title="CopyOnWriteList"></a>CopyOnWriteList</h3><h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>ConcurrentHashMap是HashMap的并发版本</p>
<ul>
<li>并发安全</li>
<li>支持一些原子复合操作</li>
<li>支持高并发， 读操作完全并行， 写操作一定程度上的并行</li>
<li>弱一致性</li>
</ul>
<p>Hashmap不是并发安全， 在并发更新的情况下可能会出现死循环，占满CPU<br>-&gt; Java7 HashMap死循环 TODO<br>-&gt; Java8 优化后减少了死循环的可能，但是扩容的时候仍然会死循环 TODO</p>
<p>-&gt; ConcurrentHashMap原理 TODO</p>
<h3 id="跳表"><a href="#跳表" class="headerlink" title="跳表"></a>跳表</h3><p>HashMap/HashSet基于哈希，不能对元素排序，对应的可排序的容器为TreeMap/TreeSet, 其对应的并发版本为 ConcurrentSkipListMap, ConcurrentSkipListSet<br>TreeSet是基于TreeMap实现的, ConcurrentSkipListSet也是基于ConcurrentSkipListMap实现.<br>ConcurrentSkipListMap是基于SkipList实现.<br>-&gt; 原理 TODO</p>
<h2 id="任务执行服务"><a href="#任务执行服务" class="headerlink" title="任务执行服务"></a>任务执行服务</h2><p>Thread即表示要执行的任务，又表示执行机制。Java并发包提供了一套框架，大大简化了执行异步任务所需的开发， 讲“任务的提交”和“任务的执行”分离。</p>
<ul>
<li>Runnalble 和 Callable: 表示要执行的异步任务 (Runnable没有返回结果，Callable有返回结果, Runnable不会抛出异常，Callable会)</li>
<li>用于执行异步任务的接口Executor, 以及有更多功能的子接口ExecutorService</li>
<li>表示异步结果的接口Future和实现类FutureTask</li>
<li>用于创建Executor和ExecutorService的工厂方法类Executors</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">executor</span><span class="params">(Runnable command)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorService</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">            &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</span><br><span class="line">            &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span></span>;</span><br><span class="line">            Future&lt;?&gt; submit(Runnable task);</span><br><span class="line">            <span class="comment">//....</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过Future可以查询异步任务的状态，获取最终结果，取消任务等...</span></span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line">            <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get()用于返回异步任务的结果，如果还没有结果，会阻塞. 可以指等待时间，超时会抛TimeoutException</span></span><br><span class="line">            <span class="comment">// cancel()用于取消异步任务, 如果任务已完成或者已取消，或不能取消，cancel返回false, 否则为 true</span></span><br><span class="line">            <span class="comment">// 如果任务还未开始，cancel后则不再运行, 如果已经运行，则不一定能取消，参数mayInterruptIfRunning表示如果任务正在执行，是否调用interrupt()中断线程, false不会</span></span><br><span class="line">            <span class="comment">// idDone表示任务是否结束，不管什么原因的结束都是true</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// get有三种结果</span></span><br><span class="line">            <span class="comment">// 1. 正常完成，返回执行结果，如果是Runnable或者且没提供结果，返回null</span></span><br><span class="line">            <span class="comment">// 2. 任务执行抛出异常, get会讲异常包装为ExecutionException重新抛出, 通过getCause方法获取原异常</span></span><br><span class="line">            <span class="comment">// 3. 任务被取消, get会抛出异常InterruptedException</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorService</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>; <span class="comment">// 不再接受新任务，已提交的任务会继续执行，即使任务还未开始执行</span></span><br><span class="line">            <span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>; <span class="comment">// 不仅不接受新任务， 而且终止已经提交但没执行的任务，对于正在执行的，会调用线程interrupt()来尝试中断， 返回已提交但没执行的任务列表</span></span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>; <span class="comment">//调用shutdown或shutdownNow不代表所有任务都结束了，但是isShutdown会返回true</span></span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">            <span class="comment">// invokeAll等待所有任务完成</span></span></span><br><span class="line"><span class="function">            <span class="comment">// invokeAny 只要有一个任务在限时内返回，就会返回该任务结果, 其他任务会被取消</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">            &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span><br><span class="line">        <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">            &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span><br><span class="line">                                  <span class="keyword">long</span> timeout, TimeUnit unit)</span><br><span class="line">        <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">            &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line">            &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">### ThreadPoolExecutor ###</span><br><span class="line">```java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, //核心线程个数</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize, //最大线程个数</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime, //空闲线程存活时间</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,//空闲线程存活时间单位</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory,   //用于对创建的线程的一些配置</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span> <span class="comment">// 表示任务拒绝策略</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    新任务到来时，如果当前线程个数小于corePoolSize， 就会创建一个新线程来执行该任务, 即使其他线程现在为空，也会创建新线程。 </span></span><br><span class="line"><span class="function">    如果线程个数&gt;</span>= corePoolSize, 就不会立即创建线程，而是先尝试排队（不是阻塞等待入队), 如果入队不了，就创建线程直到达到maximumPoolSize</span><br><span class="line"></span><br><span class="line">    BlockingQueue:</span><br><span class="line">    <span class="number">1</span>. LinkedBlockingQueue: 基于链表的阻塞队列，可以指定最大长度，默认无界</span><br><span class="line">    <span class="number">2</span>. ArrayBlockingQueue: 基于数组的有界阻塞队列</span><br><span class="line">    <span class="number">3</span>. PriorityBlockingQueue 基于堆的无界阻塞优先级队列</span><br><span class="line">    <span class="number">4</span>. SynchronousQueue: 没有实际存储空间的通不阻塞队列</span><br><span class="line"></span><br><span class="line">    任务拒绝策略:</span><br><span class="line">    <span class="number">1</span>. ThreadPoolExecutor.AbortPolicy 默认方式，抛出异常</span><br><span class="line">    <span class="number">2</span>. ThreadPoolExecutor.DiscardPolicy  静默处理，忽略新任务，不抛异常不执行</span><br><span class="line">    <span class="number">3</span>. ThreadPoolExecutor.DiscardOldestPolicy 等待时间最长的任务扔掉</span><br><span class="line">    <span class="number">4</span>. ThreadPoolExecutor.CallerRunsPolicy 将任务提交者线程中执行任务，而不是交给线程池中的线程执行</span><br></pre></td></tr></table></figure>

<h3 id="工厂类Executors"><a href="#工厂类Executors" class="headerlink" title="工厂类Executors"></a>工厂类Executors</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">其中newSingleThreadExecutor相当于</span><br><span class="line"><span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;());</span><br><span class="line"></span><br><span class="line">newFixedThreadPool</span><br><span class="line"><span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;())</span><br><span class="line"></span><br><span class="line">newCachedThreadPool</span><br><span class="line"><span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;())</span><br><span class="line">当新的任务来时，如果正好有空闲线程在等待任务，则其中一个空闲线程接受该任务，否则总是创建一个新线程， 对于空闲线程，如果<span class="number">60</span>s内没有接受新任务就中止</span><br></pre></td></tr></table></figure>

<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><h4 id="Timer-amp-TimerTask"><a href="#Timer-amp-TimerTask" class="headerlink" title="Timer &amp; TimerTask"></a>Timer &amp; TimerTask</h4><p>Tips: 固定延时fixed-delay 与固定频率 fixed-rate.<br>固定延时，是基于上次任务的实际执行时间来计算<br>固定频率会尽力补够运算次数</p>
<p>一个 Timer只有一个Timer线程， 在执行任何一个任务的run方法时，一旦run抛出异常，Timer线程就会退出，从而所有的任务都会被取消</p>
<h4 id="ScheduledExecutorService"><a href="#ScheduledExecutorService" class="headerlink" title="ScheduledExecutorService"></a>ScheduledExecutorService</h4><h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><ul>
<li>Java7引入的Fork&amp;Join</li>
<li>Java8并行流</li>
<li>CompletionService</li>
<li>Java8引入的CompletableFuture</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/12/Android-动画原理分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/12/Android-动画原理分析/" itemprop="url">Android-动画原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-12T09:37:04+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/12/Android-动画原理分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/12/Android-动画原理分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.jianshu.com/p/131faec834d1" target="_blank" rel="noopener">https://www.jianshu.com/p/131faec834d1</a><br><a href="https://www.jianshu.com/p/2f19fe1e3ca1" target="_blank" rel="noopener">https://www.jianshu.com/p/2f19fe1e3ca1</a></p>
<p>本文将从一个实际问题出发，带领大家分析Android动画的原理(<code>ValueAnimator</code>), 以及动画集合(<code>AnimatorSet</code>)在不同平台上的不一样的组织形式。</p>
<p>Contents:</p>
<ul>
<li>一段代码在不同设备上的不同表现<ul>
<li>代码</li>
<li>Android23上的表现</li>
<li>Android24上的表现</li>
<li>现象描述</li>
</ul>
</li>
<li>动画源码分析<ul>
<li>ValueAnimator源码分析</li>
<li>AnimatorSet源码分析(based on Android 23)</li>
<li>AnimatorSet源码分析(based on Android 24)</li>
</ul>
</li>
<li>回归问题，导致不同表现的原因</li>
</ul>
<h2 id="一段代码在不同设备上的不同表现"><a href="#一段代码在不同设备上的不同表现" class="headerlink" title="一段代码在不同设备上的不同表现"></a>一段代码在不同设备上的不同表现</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">mFirstValueAnimator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">2000</span>);</span><br><span class="line">mFirstValueAnimator.setDuration(<span class="number">1000</span>);</span><br><span class="line">mFirstValueAnimator.setInterpolator(<span class="keyword">new</span> AccelerateDecelerateInterpolator());</span><br><span class="line">mFirstValueAnimator.addUpdateListener(<span class="keyword">new</span> ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationUpdate..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">mFirstValueAnimator.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationStart..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationEnd...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationCancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"first anim onAnimationRepeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">mFirstValueAnimator.start();</span><br><span class="line">Debug.i(TAG, <span class="string">"first anim anim start...."</span>);</span><br><span class="line"></span><br><span class="line">mSecondValueAnimator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">2000f</span>);</span><br><span class="line">mSecondValueAnimator.setDuration(<span class="number">1000</span>);</span><br><span class="line">mSecondValueAnimator.setInterpolator(<span class="keyword">new</span> AccelerateDecelerateInterpolator());</span><br><span class="line">mSecondValueAnimator.addUpdateListener(<span class="keyword">new</span> ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationUpdate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">mSecondValueAnimator.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationStart..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationEnd...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationCancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"second anim onAnimationRepeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</span><br><span class="line">set.setDuration(<span class="number">500</span>);</span><br><span class="line">set.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet start..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet end..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet cancel..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Debug.i(TAG, <span class="string">"animatorSet repeat..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">set.play(mFirstValueAnimator).with(mSecondValueAnimator);</span><br><span class="line">set.start();</span><br><span class="line">Debug.i(TAG, <span class="string">"animator set start..."</span>);</span><br></pre></td></tr></table></figure>

<h3 id="在Android-23-上输出"><a href="#在Android-23-上输出" class="headerlink" title="在Android 23 上输出"></a>在Android 23 上输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationStart:<span class="number">34</span>&gt; first anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.395</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity:onCreate:<span class="number">54</span>&gt; first anim anim start....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.396</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.396</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationStart:<span class="number">92</span>&gt; animatorSet start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.397</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity:onCreate:<span class="number">112</span>&gt; animator set start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.417</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.418</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.491</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.491</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.950</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.950</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">27.951</span> I/MainActivity(<span class="number">13521</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationEnd:<span class="number">39</span>&gt; first anim onAnimationEnd....</span><br></pre></td></tr></table></figure>

<h3 id="在Android-24上输出"><a href="#在Android-24上输出" class="headerlink" title="在Android 24上输出"></a>在Android 24上输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationStart:<span class="number">34</span>&gt; first anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.942</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity:onCreate:<span class="number">54</span>&gt; first anim anim start....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">4</span>:onAnimationStart:<span class="number">68</span>&gt; second anim onAnimationStart...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.943</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.944</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationStart:<span class="number">92</span>&gt; animatorSet start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.944</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity:onCreate:<span class="number">112</span>&gt; animator set start...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">11.967</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.427</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.445</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.477</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.492</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">1</span>:onAnimationUpdate:<span class="number">28</span>&gt; first anim onAnimationUpdate...</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">2</span>:onAnimationEnd:<span class="number">39</span>&gt; first anim onAnimationEnd....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">3</span>:onAnimationUpdate:<span class="number">62</span>&gt; second anim onAnimationUpdate</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.493</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">4</span>:onAnimationEnd:<span class="number">73</span>&gt; second anim onAnimationEnd....</span><br><span class="line">   <span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">12.494</span> I/MainActivity(<span class="number">14744</span>): &lt;MainActivity$<span class="number">5</span>:onAnimationEnd:<span class="number">97</span>&gt; animatorSet end...</span><br></pre></td></tr></table></figure>

<h3 id="现象描述"><a href="#现象描述" class="headerlink" title="现象描述"></a>现象描述</h3><p>简单的2个<code>ValueAnimator</code>动画, <code>ValueAnimator1</code>和<code>ValueAnimator2</code>，以后简称<code>anim1</code>, <code>anim2</code>, 通过<code>AnimatorSet</code>动画集合按照<code>play anim1 with anim2</code>的规则组织在一起，也就是<code>anim1</code>和<code>anim2</code>一起<code>start</code>.</p>
<p>按照我们的预期, <code>anim1</code>和<code>anim2</code>的执行应该是<br><code>anim1 start -&gt; anim1 update -&gt; anim1 end</code><br><code>anim2 start -&gt; anim2 update -&gt; anim2 end</code><br>交替在一起，像两个线程并发执行一样.</p>
<p>但实际上:</p>
<ul>
<li>在Android23上只有anim1的start, update, end. anim2完全被屏蔽了</li>
<li>在Android 24上， anim1和anim2貌似是符合预期的</li>
</ul>
<p>下面我们将会一步步的从源码来分析这个现象产生的原因。</p>
<h2 id="动画源码分析"><a href="#动画源码分析" class="headerlink" title="动画源码分析"></a>动画源码分析</h2><h3 id="ValueAnimator源码分析"><a href="#ValueAnimator源码分析" class="headerlink" title="ValueAnimator源码分析"></a>ValueAnimator源码分析</h3><p>首先进入<code>start</code>方法, 前面几行都是对一些状态进行的初始化，不细说，最后一块代码比较关键</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  AnimationHandler animationHandler = getOrCreateAnimationHandler();</span><br><span class="line">  animationHandler.mPendingAnimations.add(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// This sets the initial value of the animation, prior to actually starting it running</span></span><br><span class="line">      <span class="keyword">if</span> (prevPlayingState != SEEKED) &#123;</span><br><span class="line">          setCurrentPlayTime(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      mPlayingState = STOPPED;</span><br><span class="line">      mRunning = <span class="keyword">true</span>;</span><br><span class="line">      notifyStartListeners();</span><br><span class="line">  &#125;</span><br><span class="line">animationHandler.start();</span><br></pre></td></tr></table></figure>

<p>如果<code>mStartDelay==0</code>, 也就是启动动画没有延迟, <code>notifyStartListeners()</code>, 进入这个方法可以看到熟悉的<code>onAnimationStart</code>回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStartListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    tmpListeners.get(i).onAnimationStart(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着来看<code>animationHandler.start()</code>, 这里是动画执行的核心. <code>AnimationHandler</code>是一个静态的内部类，里面定义了以下关键变量<code>mAnimations</code>, <code>mTmpAnimations</code>, <code>mPendingAnimations</code>, <code>mDelayedAnims</code>, <code>mEndingAnims</code>, <code>mReadyAnims</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used in doAnimationFrame() to avoid concurrent modifications of mAnimations</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mTmpAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// The per-thread set of animations to be started on the next animation frame</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mPendingAnimations = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Internal per-thread collections used to avoid set collisions as animations start and end</span></span><br><span class="line"><span class="comment">* while being processed.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mDelayedAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mEndingAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ValueAnimator&gt; mReadyAnims = <span class="keyword">new</span> ArrayList&lt;ValueAnimator&gt;();</span><br></pre></td></tr></table></figure>

<p>接着进入前文中的<code>animationHandler.start()</code>方法里, 里面调用了<code>scheduleAnimation()</code>这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mAnimationScheduled) &#123;</span><br><span class="line">      mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="keyword">null</span>);</span><br><span class="line">      mAnimationScheduled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>mChoreographer.postCallback</code>用法类似于mHandler.post方法，也就是这个方法具体执行在<code>mAnimate</code>这个runnable里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mAnimate = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mAnimationScheduled = <span class="keyword">false</span>;</span><br><span class="line">            doAnimationFrame(mChoreographer.getFrameTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>这儿简单介绍下<code>mchoreographer</code>是个跟系统时钟相关的类，系统每过16ms会发出<code>VSYNC</code>信号, 触发屏幕渲染, 刷新一次UI, 当然也可以手动的更改刷新频率。这里的<code>mChoreographer.getFrameTime()</code>就是获取这一次刷新的时间，进入到<code>doAnimationFrame</code>方法里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    mLastFrameTime = frameTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mPendingAnimations holds any animations that have requested to be started</span></span><br><span class="line">    <span class="comment">// We're going to clear mPendingAnimations, but starting animation may</span></span><br><span class="line">    <span class="comment">// cause more to be added to the pending list (for example, if one animation</span></span><br><span class="line">    <span class="comment">// starting triggers another starting). So we loop until mPendingAnimations</span></span><br><span class="line">    <span class="comment">// is empty.</span></span><br><span class="line">    <span class="keyword">while</span> (mPendingAnimations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ArrayList&lt;ValueAnimator&gt; pendingCopy =</span><br><span class="line">                        (ArrayList&lt;ValueAnimator&gt;) mPendingAnimations.clone();</span><br><span class="line">        mPendingAnimations.clear();</span><br><span class="line">        <span class="keyword">int</span> count = pendingCopy.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">            ValueAnimator anim = pendingCopy.get(i);</span><br><span class="line">            <span class="comment">// If the animation has a startDelay, place it on the delayed list</span></span><br><span class="line">            <span class="keyword">if</span> (anim.mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                anim.startAnimation(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDelayedAnims.add(anim);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, process animations currently sitting on the delayed queue, adding</span></span><br><span class="line">    <span class="comment">// them to the active animations if they are ready</span></span><br><span class="line">    <span class="keyword">int</span> numDelayedAnims = mDelayedAnims.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDelayedAnims; ++i) &#123;</span><br><span class="line">        ValueAnimator anim = mDelayedAnims.get(i);</span><br><span class="line">        <span class="keyword">if</span> (anim.delayedAnimationFrame(frameTime)) &#123;</span><br><span class="line">            mReadyAnims.add(anim);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> numReadyAnims = mReadyAnims.size();</span><br><span class="line">    <span class="keyword">if</span> (numReadyAnims &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numReadyAnims; ++i) &#123;</span><br><span class="line">            ValueAnimator anim = mReadyAnims.get(i);</span><br><span class="line">            anim.startAnimation(<span class="keyword">this</span>);</span><br><span class="line">            anim.mRunning = <span class="keyword">true</span>;</span><br><span class="line">            mDelayedAnims.remove(anim);</span><br><span class="line">        &#125;</span><br><span class="line">        mReadyAnims.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now process all active animations. The return value from animationFrame()</span></span><br><span class="line">    <span class="comment">// tells the handler whether it should now be ended</span></span><br><span class="line">    <span class="keyword">int</span> numAnims = mAnimations.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">        mTmpAnimations.add(mAnimations.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">        ValueAnimator anim = mTmpAnimations.get(i);</span><br><span class="line">        <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</span><br><span class="line">            mEndingAnims.add(anim);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mTmpAnimations.clear();</span><br><span class="line">    <span class="keyword">if</span> (mEndingAnims.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mEndingAnims.size(); ++i) &#123;</span><br><span class="line">            mEndingAnims.get(i).endAnimation(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mEndingAnims.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule final commit for the frame.</span></span><br><span class="line">    mChoreographer.postCallback(Choreographer.CALLBACK_COMMIT, mCommit, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are still active or delayed animations, schedule a future call to</span></span><br><span class="line">    <span class="comment">// onAnimate to process the next frame of the animations.</span></span><br><span class="line">    <span class="keyword">if</span> (!mAnimations.isEmpty() || !mDelayedAnims.isEmpty()) &#123;</span><br><span class="line">        scheduleAnimation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法里可以看到之前定义过的那一系列的变量</p>
<ol>
<li>首先来看<code>mPendingAnimations</code>. 如果<code>anim.mStartDelay == 0</code>那么就直接<code>start</code>, <code>anim.startAnimation(this);</code>(这里一会回过来看)否则，就把有延迟的动画添加到<code>mDelayAnims</code>里</li>
<li>接下来处理<code>mDelayAnims</code>, 如果<code>anim.delayedAnimationFrame(frameTime)</code>也就是如果delayed的动画延迟时间到了, 那么就<code>mReadyAnims.add(anim)</code>把动画放到<code>mReadyAnims</code>里</li>
<li>然后处理<code>mReadyAnims</code>， 同样的循环<code>mReadyAnims</code>然后去<code>start</code>, <code>anim.startAnimation(this)</code>, 与第一条的<code>start</code>一样</li>
</ol>
<p>我们来看下<code>anim.startAnimation(this)</code>里究竟做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">(AnimationHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_VIEW)) &#123;</span><br><span class="line">        Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, getNameForTrace(),</span><br><span class="line">                System.identityHashCode(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    initAnimation();</span><br><span class="line">    handler.mAnimations.add(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (mStartDelay &gt; <span class="number">0</span> &amp;&amp; mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Listeners were already notified in start() if startDelay is 0; this is</span></span><br><span class="line">        <span class="comment">// just for delayed animations</span></span><br><span class="line">        notifyStartListeners();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里把<code>start</code>的动画添加到了<code>handler.mAnimations</code>里，跟进去看，也就是添加到了<code>AnimationHandler</code>里面的<code>mAnimations</code>变量里, 注意这一块! 然后<code>notifyStartListener</code>也就是之前提到过的，回调<code>onAnimationStart</code>方法。</p>
<p>跳出来， 我们回到之前的流程中</p>
<ol>
<li>处理完<code>mReadyAnims</code>中的动画后，我们知道那些<code>start</code>了的动画都跑到了<code>mAnimations</code>里，接下来把<code>mAnimations</code>里的动画复制一份放到了<code>mTmpAnimations</code>中</li>
<li>接着处理<code>mTmpAnimations</code>, <code>anim.doAnimationFrame(frameTime)</code>这里就是真正实现动画的部分，等下细说， 然后把完成了的动画放到<code>mEndingAnims</code>中</li>
<li>接下来遍历<code>mEndingAnims</code>, 执行<code>mEndingAnims.get(i).endAnimation(this)</code>，显而易见，这儿的<code>endAnimation</code>就是回调了<code>onAnimationEnd</code>方法</li>
<li>最后递归调用<code>scheduleAnimation()</code>一遍遍的走这个流程，每次传过来的<code>frameTime</code>都是当前刷新的时间，这样就完成了整个动画</li>
</ol>
<p>前文把整个动画的流程和回调时机大致介绍了下， 除了一个<code>anim.doAnimationFrame(frameTime)</code>， 这是动画执行的关键过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    ... 关键的代码是最后一行 ...</span><br><span class="line">    <span class="keyword">return</span> animationFrame(currentTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>animationFrame()</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">animationFrame</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">switch</span> (mPlayingState) &#123;</span><br><span class="line">        <span class="keyword">case</span> RUNNING:</span><br><span class="line">        <span class="keyword">case</span> SEEKED:</span><br><span class="line">            <span class="keyword">float</span> fraction = mDuration &gt; <span class="number">0</span> ? (<span class="keyword">float</span>)(currentTime - mStartTime) / mDuration : <span class="number">1f</span>;</span><br><span class="line">            <span class="keyword">if</span> (mDuration == <span class="number">0</span> &amp;&amp; mRepeatCount != INFINITE) &#123;</span><br><span class="line">                <span class="comment">// Skip to the end</span></span><br><span class="line">                mCurrentIteration = mRepeatCount;</span><br><span class="line">                <span class="keyword">if</span> (!mReversing) &#123;</span><br><span class="line">                    mPlayingBackwards = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fraction &gt;= <span class="number">1f</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCurrentIteration &lt; mRepeatCount || mRepeatCount == INFINITE) &#123;</span><br><span class="line">                    <span class="comment">// Time to repeat</span></span><br><span class="line">                    <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> numListeners = mListeners.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                            mListeners.get(i).onAnimationRepeat(<span class="keyword">this</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mRepeatMode == REVERSE) &#123;</span><br><span class="line">                        mPlayingBackwards = !mPlayingBackwards;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mCurrentIteration += (<span class="keyword">int</span>) fraction;</span><br><span class="line">                    fraction = fraction % <span class="number">1f</span>;</span><br><span class="line">                    mStartTime += mDuration;</span><br><span class="line">                    <span class="comment">// Note: We do not need to update the value of mStartTimeCommitted here</span></span><br><span class="line">                    <span class="comment">// since we just added a duration offset.</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    done = <span class="keyword">true</span>;</span><br><span class="line">                    fraction = Math.min(fraction, <span class="number">1.0f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPlayingBackwards) &#123;</span><br><span class="line">                fraction = <span class="number">1f</span> - fraction;</span><br><span class="line">            &#125;</span><br><span class="line">            animateValue(fraction);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> done;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>fraction</code>是时间因子， 从第一行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> fraction = mDuration &gt; <span class="number">0</span> ? (<span class="keyword">float</span>)(currentTime - mStartTime) / mDuration : <span class="number">1f</span>;</span><br></pre></td></tr></table></figure>

<p>可以知道, <code>fraction</code>表示动画已经开始消耗了的时间，如果是单次动画，<code>fraction</code>就是[0, 1], 如果超过了一次, fraction就可能 <code>&gt;=1</code>, 也就会执行下面的代码。 注意里面的<code>onAnimationRepeat</code>回调，每重复一次动画，会回调一次. 最后进入到<code>animateValue(fraction)</code>这个函数里， 把时间因子<code>fraction</code>传了进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">    mCurrentFraction = fraction;</span><br><span class="line">    <span class="keyword">int</span> numValues = mValues.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">        mValues[i].calculateValue(fraction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUpdateListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> numListeners = mUpdateListeners.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">            mUpdateListeners.get(i).onAnimationUpdate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行的<code>fraction</code>, 通过<code>mInterpolator.getInterpolation(fraction)</code>这个接口来进行了一次计算，把简单的线性的<code>fraction</code>转化为各种可能的数值从而达到不同的动画效果，我们知道，使用动画时， 我们就是通过<code>setInterpolator()</code>来进行不同样式的动画的， 比如<code>AccelerateDecelerateInterpolator</code>, <code>LinearInterpolator</code>等，原理就是在这里。 <code>Intepolator</code>源码如下，传入一个<code>float</code>输出一个<code>float</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A time interpolator defines the rate of change of an animation. This allows animations</span></span><br><span class="line"><span class="comment"> * to have non-linear motion, such as acceleration and deceleration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TimeInterpolator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Maps a value representing the elapsed fraction of an animation to a value that represents</span></span><br><span class="line"><span class="comment">     * the interpolated fraction. This interpolated value is then multiplied by the change in</span></span><br><span class="line"><span class="comment">     * value of an animation to derive the animated value at the current elapsed animation time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input A value between 0 and 1.0 indicating our current point</span></span><br><span class="line"><span class="comment">     *        in the animation where 0 represents the start and 1.0 represents</span></span><br><span class="line"><span class="comment">     *        the end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The interpolation value. This value can be more than 1.0 for</span></span><br><span class="line"><span class="comment">     *         interpolators which overshoot their targets, or less than 0 for</span></span><br><span class="line"><span class="comment">     *         interpolators that undershoot their targets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后<code>mValues</code>里面的值会跟这个<code>fraction</code>因子进行计算<br>接下来就是<code>onAnimationUpdate</code>回调。 我们经常在这个回调里，把上一部计算后的结果拿到(<code>getAnimatedValue()</code>)</p>
<p>以上就是<code>ValueAnimator</code>大致的执行流程， 和关键的回调， 接下来， 我们分析<code>Android-23源码下</code>的<code>AnimatorSet</code>类， 也就是动画集合类。</p>
<h3 id="AnimatorSet源码分析-based-on-Android-23"><a href="#AnimatorSet源码分析-based-on-Android-23" class="headerlink" title="AnimatorSet源码分析(based on Android 23)"></a>AnimatorSet源码分析(based on Android 23)</h3><p>在<code>AnimatorSet</code>源码中我们发现, 他的一些方法如<code>playTogether</code>, <code>playSequentially</code>, <code>play</code>等方法实际上都是通过<code>Builder</code>模式来构建的这个<code>AnimatorSet</code>的。 进入<code>Builder</code>内部类，继续分析这里的<code>with</code>, <code>before</code>, <code>after</code>方法，也就是我们经常用到的构建动画顺序的方法，里面都是通过<code>Node</code>和<code>Dependency</code>这两个类组合起来的，这里设计的很巧妙，具体来看下这里的代码,  先从<code>Dependency</code>开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Dependency</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WITH = <span class="number">0</span>; <span class="comment">// dependent node must start with this dependency node</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AFTER = <span class="number">1</span>; <span class="comment">// dependent node must start when this dependency node finishes</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The node that the other node with this Dependency is dependent upon</span></span><br><span class="line">    <span class="keyword">public</span> Node node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The nature of the dependency (WITH or AFTER)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> rule;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dependency</span><span class="params">(Node node, <span class="keyword">int</span> rule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.node = node;</span><br><span class="line">        <span class="keyword">this</span>.rule = rule;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>Dependency</code>里定义了2中依赖关系, <code>WITH</code>和<code>AFTER</code>,可能有人好奇<code>Builder</code>里的<code>before</code>怎么没了。 原因是, <code>before</code>和<code>after</code>其实是一种逆向的过程, <code>A before B</code> 也就是<code>B after A</code>. 所以这里源码作者忽略了<code>before</code>，简化了代码，但是增加了逻辑复杂度，让第一次阅读的人一头雾水<br><code>Dependency</code>里除了定义了依赖关系，还声明了另一个关键的变量<code>Node</code>, <code>Node</code>的英文注释这儿是<code>// The node that the other note with this Dependency is dependent upon</code>. 这里很巧妙，意思是其他的<code>Node</code>与这个<code>Node</code>的依赖关系是这个<code>Dependency</code><br>接下来来看下比较复杂的<code>Node</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Animator animation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  These are the dependencies that this node's animation has on other</span></span><br><span class="line"><span class="comment">     *  nodes. For example, if this node's animation should begin with some</span></span><br><span class="line"><span class="comment">     *  other animation ends, then there will be an item in this node's</span></span><br><span class="line"><span class="comment">     *  dependencies list for that other animation's node.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Dependency&gt; dependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tmpDependencies is a runtime detail. We use the dependencies list for sorting.</span></span><br><span class="line"><span class="comment">     * But we also use the list to keep track of when multiple dependencies are satisfied,</span></span><br><span class="line"><span class="comment">     * but removing each dependency as it is satisfied. We do not want to remove</span></span><br><span class="line"><span class="comment">     * the dependency itself from the list, because we need to retain that information</span></span><br><span class="line"><span class="comment">     * if the AnimatorSet is launched in the future. So we create a copy of the dependency</span></span><br><span class="line"><span class="comment">     * list when the AnimatorSet starts and use this tmpDependencies list to track the</span></span><br><span class="line"><span class="comment">     * list of satisfied dependencies.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Dependency&gt; tmpDependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * nodeDependencies is just a list of the nodes that this Node is dependent upon.</span></span><br><span class="line"><span class="comment">     * This information is used in sortNodes(), to determine when a node is a root.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Node&gt; nodeDependencies = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * nodeDepdendents is the list of nodes that have this node as a dependency. This</span></span><br><span class="line"><span class="comment">     * is a utility field used in sortNodes to facilitate removing this node as a</span></span><br><span class="line"><span class="comment">     * dependency when it is a root node.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Node&gt; nodeDependents = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>这里声明了<code>ArrayList&lt;Dependency&gt; dependencies</code>, <code>ArrayList&lt;Dependency&gt; tmpDependencies</code>, <code>ArrayList&lt;Node&gt; nodeDependencies</code>, <code>ArrayList&lt;Node&gt; nodeDependents</code>, 这里的定义只<code>dependents</code>和<code>dependencies</code>就比较容易搞混了, 我们结合例子来看</p>
<p>先举一个普通的<code>AnimatorSet</code>的用法，也就是最开始的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AnimatorSet set = <span class="keyword">new</span> AnimatorSet()</span><br><span class="line">set.play(mFirstValueAnimator).with(mSecondValueAnimator);</span><br></pre></td></tr></table></figure>

<p>进入<code>play</code>方法，我们可以看到直接返回的是一个<code>new Builder(anim1)</code>接着进入<code>Builder</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Builder(Animator anim) &#123;</span><br><span class="line">            mCurrentNode = mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (mCurrentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mCurrentNode = <span class="keyword">new</span> Node(anim);</span><br><span class="line">                mNodeMap.put(anim, mCurrentNode);</span><br><span class="line">                mNodes.add(mCurrentNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里把<code>anim1</code>赋值给<code>mCurrentNode</code>, 可以这么理解，一个<code>Node</code>对应一个<code>anim</code>, 接着是<code>with(anim2)</code>, 也就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">with</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">        Node node = mNodeMap.get(anim);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">            node = <span class="keyword">new</span> Node(anim);</span><br><span class="line">            mNodeMap.put(anim, node);</span><br><span class="line">            mNodes.add(node);</span><br><span class="line">        &#125;</span><br><span class="line">        Dependency dependency = <span class="keyword">new</span> Dependency(mCurrentNode, Dependency.WITH);</span><br><span class="line">        node.addDependency(dependency);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>新建一个<code>Dependency</code>把<code>mCurrentNode</code>也就是<code>anim1</code>和依赖关系<code>Dependency</code>也就是<code>WITH</code>作为<code>Dependency</code>的构造函数传进来, 然后<code>node</code>也就是<code>anim2</code>添加这个<code>Dependency(anim1, with)</code><br>接着进入<code>addDependency</code>里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDependency</span><span class="params">(Dependency dependency)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dependencies == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dependencies = <span class="keyword">new</span> ArrayList&lt;Dependency&gt;();</span><br><span class="line">            nodeDependencies = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        dependencies.add(dependency);</span><br><span class="line">        <span class="keyword">if</span> (!nodeDependencies.contains(dependency.node)) &#123;</span><br><span class="line">            nodeDependencies.add(dependency.node);</span><br><span class="line">        &#125;</span><br><span class="line">        Node dependencyNode = dependency.node;</span><br><span class="line">        <span class="keyword">if</span> (dependencyNode.nodeDependents == <span class="keyword">null</span>) &#123;</span><br><span class="line">            dependencyNode.nodeDependents = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        dependencyNode.nodeDependents.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>估计看到这块代码一头雾水，先介绍下这里的变量分别是做什么的</p>
<ul>
<li>List<dependency> dependencies 记录当前节点的所有依赖关系</dependency></li>
<li>List<node> nodeDependencies 记录当前节点的依赖节点</node></li>
<li>List<node> nodeDependents 记录依赖当前节点的节点</node></li>
</ul>
<p>以上<code>addDependency</code>函数内做的就是这事，把这三个变量给赋值。 再举个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">anim1.before(anim2)</span><br><span class="line">顺序是anim1, anim2</span><br><span class="line">映射到代码中就是</span><br><span class="line">node(anim2), dependency(anim1, after)</span><br><span class="line">中文描述: 动画<span class="number">2</span>在动画<span class="number">1</span>之后</span><br><span class="line"></span><br><span class="line">anim3.after(anim4)</span><br><span class="line">顺序是anim4, anim3</span><br><span class="line">映射到代码中就是</span><br><span class="line">node(currentNode也就是anim3), dependency(anim4, after)</span><br><span class="line">中文描述: 动画<span class="number">3</span>在动画<span class="number">4</span>之后</span><br><span class="line"></span><br><span class="line">我们再来串起来看下。</span><br><span class="line"></span><br><span class="line">`e.g`</span><br><span class="line"></span><br><span class="line">play(anim1).before(anim2).before(anim3)</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. anim1</span><br><span class="line"><span class="number">2</span>. anim2的NodeDependencies 是 anim1</span><br><span class="line"><span class="number">3</span>. anim1的NodeDependents 是 anim2</span><br><span class="line"><span class="number">4</span>. anim3的NodeDependencies 是 anim2</span><br><span class="line"><span class="number">5</span>. anim2的NodeDependencts 是 anim3</span><br><span class="line"></span><br><span class="line">最终结果就是</span><br><span class="line"></span><br><span class="line">anim1的nodeDependencies是<span class="keyword">null</span>, nodeDependents是anim2</span><br><span class="line">anim2的nodeDependencies是anim1, nodeDependents是anim3</span><br><span class="line">anim3的nodeDependencies是anim2, nodeDependents是<span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p><code>AnimatorSet</code>就是通过这样的依赖关系把添加进来的动画组织起来，接下来，我们看下他们是如何<code>start</code>的，进入<code>AnimatorSet</code>的<code>start</code>方法里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mTerminated = <span class="keyword">false</span>;</span><br><span class="line">            mStarted = <span class="keyword">true</span>;</span><br><span class="line">            mPaused = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                node.animation.setAllowRunningAsynchronously(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (mDuration &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// If the duration was set on this AnimatorSet, pass it along to all child animations</span></span><br><span class="line">                <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> don't set the duration of the timing-only nodes created by AnimatorSet to</span></span><br><span class="line">                    <span class="comment">// insert "play-after" delays</span></span><br><span class="line">                    node.animation.setDuration(mDuration);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mInterpolator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                    node.animation.setInterpolator(mInterpolator);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// First, sort the nodes (if necessary). This will ensure that sortedNodes</span></span><br><span class="line">            <span class="comment">// contains the animation nodes in the correct order.</span></span><br><span class="line">            sortNodes();</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">int</span> numSortedNodes = mSortedNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">                Node node = mSortedNodes.get(i);</span><br><span class="line">                <span class="comment">// First, clear out the old listeners</span></span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; oldListeners = node.animation.getListeners();</span><br><span class="line">                <span class="keyword">if</span> (oldListeners != <span class="keyword">null</span> &amp;&amp; oldListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ArrayList&lt;AnimatorListener&gt; clonedListeners = <span class="keyword">new</span></span><br><span class="line">                            ArrayList&lt;AnimatorListener&gt;(oldListeners);</span><br><span class="line">    </span><br><span class="line">                    <span class="keyword">for</span> (AnimatorListener listener : clonedListeners) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> DependencyListener ||</span><br><span class="line">                                listener <span class="keyword">instanceof</span> AnimatorSetListener) &#123;</span><br><span class="line">                            node.animation.removeListener(listener);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// nodesToStart holds the list of nodes to be started immediately. We don't want to</span></span><br><span class="line">            <span class="comment">// start the animations in the loop directly because we first need to set up</span></span><br><span class="line">            <span class="comment">// dependencies on all of the nodes. For example, we don't want to start an animation</span></span><br><span class="line">            <span class="comment">// when some other animation also wants to start when the first animation begins.</span></span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;Node&gt; nodesToStart = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">                Node node = mSortedNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (mSetListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSetListener = <span class="keyword">new</span> AnimatorSetListener(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies == <span class="keyword">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    nodesToStart.add(node);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> numDependencies = node.dependencies.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                        Dependency dependency = node.dependencies.get(j);</span><br><span class="line">                        dependency.node.animation.addListener(</span><br><span class="line">                                <span class="keyword">new</span> DependencyListener(<span class="keyword">this</span>, node, dependency.rule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    node.tmpDependencies = (ArrayList&lt;Dependency&gt;) node.dependencies.clone();</span><br><span class="line">                &#125;</span><br><span class="line">                node.animation.addListener(mSetListener);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Now that all dependencies are set up, start the animations that should be started.</span></span><br><span class="line">            <span class="keyword">if</span> (mStartDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Node node : nodesToStart) &#123;</span><br><span class="line">                    node.animation.start();</span><br><span class="line">                    mPlayingSet.add(node.animation);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDelayAnim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                mDelayAnim.setDuration(mStartDelay);</span><br><span class="line">                mDelayAnim.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> canceled = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">                        canceled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator anim)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!canceled) &#123;</span><br><span class="line">                            <span class="keyword">int</span> numNodes = nodesToStart.size();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                                Node node = nodesToStart.get(i);</span><br><span class="line">                                node.animation.start();</span><br><span class="line">                                mPlayingSet.add(node.animation);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mDelayAnim = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                mDelayAnim.start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                        (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    tmpListeners.get(i).onAnimationStart(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mNodes.size() == <span class="number">0</span> &amp;&amp; mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Handle unusual case where empty AnimatorSet is started - should send out</span></span><br><span class="line">                <span class="comment">// end event immediately since the event will not be sent out at all otherwise</span></span><br><span class="line">                mStarted = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                            (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                        tmpListeners.get(i).onAnimationEnd(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>首先我们可以看到如果<code>AnimatorSet</code>设置了<code>duration</code>, 那么里面所有的<code>animation</code>都会强制地设置为<code>AnimatorSet</code>的<code>duration</code>, <code>Interpolator</code>也一样。<br>接着来看51行。这块代码意思是, 如果<code>当前Node</code>没有<code>dependencies</code>，也就是没有依赖，那么当前节点就是<code>rootNode</code>。如果<code>当前Node</code>有<code>dependencies</code>， 那么<code>当前Node</code>的<code>dependencies里面的Node, 也就是当前的Node</code>, 添加DependencyListener回调。具体来看DependencyLister这个类</p>
<ul>
<li>如果<code>mRule == Dependency.AFTER</code>, 也就是如果依赖规则是<code>after</code>, 那么在<code>onAnimationEnd</code>方法里，去<code>start</code>下一个动画的。</li>
<li>如果<code>mRule == Dependency.WITH</code>, 也就是依赖规则是<code>With</code>, 那么就在<code>onAnimationStart</code>里去<code>start</code>下一个动画</li>
</ul>
<p>总结来说就是，一系列的节点首先是通过<code>Dependency</code>这个依赖关系关联起来，在<code>start</code>的方法里，给所有有依赖的节点添加<code>DependencyListener</code>这个回调方法。如果规则是<code>with</code>, 那么第二个节点在第一个节点的<code>onAnimationStart</code>回调里去<code>start</code>, 如果第二个节点与第一个节点的关系是<code>after</code>, 那么第二个节点在第一个节点的<code>onAnimationEnd</code>回调里去<code>start</code>。</p>
<p>// TODO 类似双向链表实现的树结构??</p>
<p>AnimatorSet 在Android23源码中就是像这样把所有的动画组合起来。可以说非常巧妙，非常的精妙。但是令我们思考的是，这是最好的方法么？这种结构是不是很熟悉？或者说有什么结构可以替代这种很巧妙但是很复杂的结构?</p>
<p>AnimatorSet在Android-24源码中就是用了更加巧妙的方法来实现这块功能。下面我们来分析下AnimatorSet在24里面的源码实现。</p>
<h3 id="AnimatorSet源码分析-based-on-Android-24"><a href="#AnimatorSet源码分析-based-on-Android-24" class="headerlink" title="AnimatorSet源码分析(based on Android 24)"></a>AnimatorSet源码分析(based on Android 24)</h3><p>与23中一样，都是通过<code>Builder</code>模式来构建这个<code>AnimatorSet</code>的，所以我们直接进入到<code>Builder</code>内部类里面。可以看到与23中明显不同的是，这里的<code>with</code>, <code>after</code>, <code>before</code>里面的实现，没有复杂的<code>Dependency</code>这个东西了，取而代之的是<code>Node</code>的<code>addChild</code>, <code>addSibling</code>, <code>addParent</code>。是的，新的结构就是树，<code>with</code>就是添加兄弟节点，<code>before</code>就是添加子节点, <code>after</code>就是添加父节点。非常的清晰。<br>同时Node类里面也是定义了以下3个变量来存储添加进来的动画。<br><code>List&lt;Node&gt; mSiblings, List&lt;Node&gt; mParents, List&lt;Node&gt; mChildNodes</code><br>接着来看<code>start方法</code>,关键部分是这里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mStartDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        start(mRootNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mNodes.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// No delay, but there are other animators in the set</span></span><br><span class="line">        onChildAnimatorEnded(mDelayAnim);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Set is empty, no delay, no other animation. Skip to end in this case</span></span><br><span class="line">        setIsEmpty = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里把开始的延迟时间作为一个<code>delayAnim</code>，如果有开始延迟的话就先执行这个<code>delayAnim</code>也就是<code>mRootNode</code>。这点可以从<code>mRootNode</code>的定义看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node mRootNode = <span class="keyword">new</span> Node(mDelayAnim);</span><br></pre></td></tr></table></figure>

<p>接着进入<code>onChildAnimatorEnded(mDelayAnim)</code>方法里看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onChildAnimatorEnded</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        Node animNode = mNodeMap.get(animation);</span><br><span class="line">        animNode.mEnded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mTerminated) &#123;</span><br><span class="line">            List&lt;Node&gt; children = animNode.mChildNodes;</span><br><span class="line">            <span class="comment">// Start children animations, if any.</span></span><br><span class="line">            <span class="keyword">int</span> childrenSize = children == <span class="keyword">null</span> ? <span class="number">0</span> : children.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (children.get(i).mLatestParent == animNode) &#123;</span><br><span class="line">                    start(children.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Listeners are already notified of the AnimatorSet ending in cancel() or</span></span><br><span class="line">            <span class="comment">// end(); the logic below only kicks in when animations end normally</span></span><br><span class="line">            <span class="keyword">boolean</span> allDone = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// Traverse the tree and find if there's any unfinished node</span></span><br><span class="line">            <span class="keyword">int</span> size = mNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mNodes.get(i).mEnded) &#123;</span><br><span class="line">                    allDone = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (allDone) &#123;</span><br><span class="line">                <span class="comment">// If this was the last child animation to end, then notify listeners that this</span></span><br><span class="line">                <span class="comment">// AnimatorSet has ended</span></span><br><span class="line">                <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                            (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">int</span> numListeners = tmpListeners.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                        tmpListeners.get(i).onAnimationEnd(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mStarted = <span class="keyword">false</span>;</span><br><span class="line">                mPaused = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为传过来的是<code>mRootNode</code>，这里第一次循环的就是<code>mRootNode的mChildNodes</code>。也就是第一级的所有动画动过<code>for</code>循环去<code>start</code>。进入到<code>start</code>方法里看，这里就是动画的<code>start</code>和回调方法<code>AnimatorSetListener</code>。在这个回调方法里可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">        animation.removeListener(<span class="keyword">this</span>);</span><br><span class="line">        mAnimatorSet.mPlayingSet.remove(animation);</span><br><span class="line">        mAnimatorSet.onChildAnimatorEnded(animation);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了<code>onChildAnimationEnded</code>方法，也就是上文中的相同的方法，到这里的时候只是由原来传过来的<code>mRootNode</code>变为<code>mRootNode的childNode</code>了。 经过多次递归，同一层级的通过<code>for</code>循环来<code>start</code>, 子层级的在上一级的<code>onAnimEnd</code>回调里去递归的调用。就这样，<code>AnimatorSet</code>把所有动画组织起来。</p>
<h2 id="回归问题-导致不同表现的原因"><a href="#回归问题-导致不同表现的原因" class="headerlink" title="回归问题, 导致不同表现的原因"></a>回归问题, 导致不同表现的原因</h2><p>先总结一下。</p>
<ul>
<li><code>AnimatorSet</code>在<code>Android23</code>中是通过类似双向链表实现的树结构把所有的动画以及他们的关系给组织起来。在播放的时候, 如果后一个动画如果与前一个动画是同时播放，那么后一个动画就是在前一个动画<code>onAnimationStart</code>回调里去<code>start</code>, 如果后一个动画与前一个动画是后先顺序，那么后一个动画就在前一个动画的<code>onAnimationEnd</code>回调里去<code>start</code>。</li>
<li><code>AnimatorSet</code>在<code>Android24</code>中是通过树的结构把所有的动画组织起来。在播放的时候从跟节点一层一层的往树叶方向播放。</li>
<li>相比来说，虽然23中的做法很巧妙，但是树形结构更加合理。</li>
</ul>
<p>回归到问题, 在<code>23</code>中为什么<code>anim1</code>在播放完之后没有进行<code>anim2</code>的动画?</p>
<p>从之前的原理分析我们知道, <code>play(anim1).with(anim2)</code>也就是<code>anim1</code>与<code>anim2</code>的<code>Dependency</code>关系是<code>WITH</code>, 在<code>AnimatorSet</code>里播放时也就是, <code>anim2</code>在<code>anim1</code>的<code>onAnimationStart</code>回调里去<code>start</code>。</p>
<p>从日志上可以看到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01-17 15:22:27.395 I/MainActivity(13521): &lt;MainActivity:onCreate:54&gt; first anim anim start....</span><br><span class="line">01-17 15:22:27.396 I/MainActivity(13521): &lt;MainActivity$1:onAnimationUpdate:28&gt; first anim onAnimationUpdate...</span><br><span class="line">01-17 15:22:27.396 I/MainActivity(13521): &lt;MainActivity$5:onAnimationStart:92&gt; animatorSet start...</span><br><span class="line">01-17 15:22:27.397 I/MainActivity(13521): &lt;MainActivity:onCreate:112&gt; animator set start...</span><br></pre></td></tr></table></figure>

<p><code>AnimatorSet</code>start之前<code>anim1</code>的<code>onAnimationStart</code>早已经调用过了，后面再没有看到<code>anim1</code>的<code>onAnimationStart</code>的回调记录了 ，所以<code>anim2</code>就没法去<code>start</code>。而在<code>24</code>中，因为是<code>for循环执行的</code>，所以<code>anim2</code>可以正确的<code>start</code>。</p>
<p>至于为什么这块代码里<code>anim1</code>的<code>start</code>会在<code>AnimatorSet</code>的<code>start</code>之前就回调，是因为我们在使用的过程中，不小心把已经<code>start</code>过了的<code>anim1</code>添加到了<code>AnimatorSet</code>中，所以造成了这么比较奇怪的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/11/Java-《Java编程的逻辑》读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/11/Java-《Java编程的逻辑》读书笔记/" itemprop="url">Java-《Java编程的逻辑》读书笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-11T16:16:16+08:00">
                2019-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/11/Java-《Java编程的逻辑》读书笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/11/Java-《Java编程的逻辑》读书笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="编程基础"><a href="#编程基础" class="headerlink" title="编程基础"></a>编程基础</h2><p>补码表示法: 在原码表示的基础上取反然后加1.<br>给定一个负数的二进制，想知道他的10进制可以采用相同的补码运算，先取反，再加1<br>e.g<br>-2: 原码 00000010, 取反11111101， 加1 11111110</p>
<p>位运算</p>
<ol>
<li>左移 &lt;&lt;  右边低位补0， 高位舍弃, 左移一位相当于* 2</li>
<li>无符号右移 &gt;&gt;&gt; 向右移动，右边的舍弃，左边补0</li>
<li>有符号右移 &gt;&gt; 向右移动, 右边的舍弃, 左边补的内容取决于原来的最高位. 右移一位相当于除以2</li>
</ol>
<p>字符的编码</p>
<ul>
<li>Unicode Unicode主要做了一件事，就是给所有的字符分配唯一的数字编号，它并没有规定这个编号怎么对应二进制表示， 这个编号与二进制的对应关系通过UTF-8, UTF-16, UTF-32来决定</li>
<li>非Unicode，包括ASCII, ISO 8859-1 GB2313 GBK等</li>
</ul>
<p>类加载进内存后，一般不会释放，知道程序结束，一般情况下，类只会加载一次，所以静态变量在内存中只有一份<br>堆中的内存是被垃圾回收机制管理的，当没有活跃变量指向对象的时候，对应的堆空间就会被释放 </p>
<p>子类对象赋值给父类引用变量，这叫向上转型。 变量Shape可以饮用任何Shape子类类型的对象， 这叫多态，即一种类型的变量，可饮用多种实际类型对象。 这样， 对于变量shape来说，它就有2个类型： 类型Shape， 我们称为shape的静态类型， 类型Circle/Line 称为Shape的动态类型。shapes[i].draw()调用的是其对应的动态类型的draw方法，称为方法的动态绑定</p>
<p>静态绑定:<br>当通过b访问，访问的是Base的变量和方法， 当通过c访问，访问的是Child的变量和方法。 称为静态绑定。 静态绑定在程序编译阶段即可决定， 而动态绑定要等到运行时。 实例变量， 静态变量，静态方法， private方法, 都是静态绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String s = <span class="string">"static_base"</span>;</span><br><span class="line">    <span class="keyword">public</span> String m = <span class="string">"base"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"base static "</span> + s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nonStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"base non static"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String s=  <span class="string">"child_base"</span>;</span><br><span class="line">    <span class="keyword">public</span> String m = <span class="string">"child"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"child static "</span> + s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nonStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Child non static"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Child c = <span class="keyword">new</span> Child();</span><br><span class="line">    Base b = c;</span><br><span class="line">    System.out.println(b.s);</span><br><span class="line">    System.out.println(b.m);</span><br><span class="line">    b.staticTest();</span><br><span class="line">    System.out.println(c.s);</span><br><span class="line">    System.out.println(c.m);</span><br><span class="line">    c.staticTest();</span><br><span class="line">    b.nonStatic();</span><br><span class="line">    c.nonStatic();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static_base</span><br><span class="line">base</span><br><span class="line">base <span class="keyword">static</span> static_base</span><br><span class="line">child_base</span><br><span class="line">child</span><br><span class="line">child <span class="keyword">static</span> child_base</span><br><span class="line">Child non <span class="keyword">static</span></span><br><span class="line">Child non <span class="keyword">static</span></span><br></pre></td></tr></table></figure>

<p>类加载过程: </p>
<p>基类静态代码块<br>子类静态代码块<br>基类实例代码块<br>基类构造函数<br>子类实例代码块<br>子类构造方法</p>
<p>内部类:</p>
<p>静态内部类<br>成员内部类<br>方法内部类<br>匿名内部类</p>
<p>Question:<br>为什么局部内部类和匿名内部类只能访问final的局部变量?<br>Ans:<br>追究其根本原因就是作用域中变量的生命周期导致的;</p>
<p>首先需要知道的一点是:内部类和外部类是处于同一个级别的,内部类不会因为定义在方法中就会随着方法的执行完毕就被销毁.</p>
<p>这里就会产生问题：当外部类的方法结束时，局部变量就会被销毁了，但是内部类对象可能还存在(只有没有人再引用它时，才会死亡)。这里就出现了一个矛盾：内部类对象访问了一个不存在的变量。为了解决这个问题，就将局部变量复制了一份作为内部类的成员变量，这样当局部变量死亡后，内部类仍可以访问它，实际访问的是局部变量的”copy”。这样就好像延长了局部变量的生命周期<br>       问题又出现了：将局部变量复制为内部类的成员变量时，必须保证这两个变量是一样的，也就是如果我们在内部类中修改了成员变量，方法中的局部变量也得跟着改变，怎么解决问题呢？</p>
<p>就将局部变量设置为final，对它初始化后，我就不让你再去修改这个变量，就保证了内部类的成员变量和方法的局部变量的一致性。这实际上也是一种妥协。</p>
<p>若变量是final时：</p>
<p>若是基本类型，其值是不能改变的，就保证了copy与原始的局部变量的值是一样的；</p>
<p>若是引用类型，其引用是不能改变的，保证了copy与原始的变量引用的是同一个对象。</p>
<p>这就使得局部变量与内部类内建立的拷贝保持一致。</p>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>泛型的内部原理：<br>我们知道，Java有Java编译器和Java虚拟机，编译器讲Java源代码转换为.class文件。虚拟机加载并运行.class文件，对于泛型类，Java编译器会将泛型代码转换为普通的非泛型代码，将参数类型T擦除，替换为Object,插入必要的强制类型转换。Java虚拟机执行的时候，并不知道泛型，只知道普通的类及代码。</p>
<p>对于类型参数，我们都把它当成Object, 但是Java支持extends关键字来限定这个参数的一个上界。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberPair</span>&lt;<span class="title">U</span> <span class="keyword">extends</span> <span class="title">Number</span>, <span class="title">V</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">///</span></span><br><span class="line">	...</span><br><span class="line">	<span class="comment">///</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定边界后，类型擦除时就不会转换为Object, 而是转换为它的边界类型。</p>
<p>虽然Integer是Number的子类，但是DynamicArray<integer>不是DynamicArray<number>的子类.</number></integer></p>
<ul>
<li>&lt;? extends E&gt; -&gt; 有限定通配符</li>
<li>&lt;?&gt; 无限定通配符</li>
</ul>
<p>这两种通配符有一个重要的限制，只能读，不能写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DynamicArray&lt;Integer&gt; integers = <span class="keyword">new</span> DynamicArray&lt;&gt;();</span><br><span class="line">   DynamicArray&lt;? extends Number&gt; numbers = integers;</span><br><span class="line">   numbers.add(<span class="number">1</span>); <span class="comment">//错误</span></span><br><span class="line">   numbers.add((Integer)<span class="number">1</span>); <span class="comment">//错误</span></span><br><span class="line">   numbers.add((Number)<span class="number">1</span>); <span class="comment">//错误</span></span><br></pre></td></tr></table></figure>

<p>因为<code>? extends Number</code>表示是Number的一个子类型，但是不知道具体类型，如果允许写入<br>numbers里面的值就可能会存入Integer, Float等不同类型，无法保证类型安全。</p>
<p>总结: 泛型方法到底应该用通配符形式还是加类型参数</p>
<ol>
<li>通配符形式都可以用类型参数的形式替代，通配符能做的，类型参数都能做</li>
<li>通配符形式可以减少类型参数，形式上往往更简单，可读性好，所以能用通配符就用通配符</li>
<li>如果类型参数有依赖关系，或者返回值依赖类型参数，或者需要写操作，则只能用类型参数</li>
<li>通配符形式和类型参数往往配合使用。</li>
</ol>
<p>超类型通配符 &lt;? super E&gt;</p>
<p><code>&lt;? super E&gt;</code>用于灵活<code>写入</code>, <code>&lt;? extends E&gt;</code>用于灵活<code>读取</code></p>
<p>泛型的限制：</p>
<ul>
<li>不能通过类型参数创建对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e.g</span><br><span class="line">T t = <span class="keyword">new</span> T(); <span class="comment">// illegal</span></span><br></pre></td></tr></table></figure>

<p>如果一定要创建，可以调用Class.newInstance方法来创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> type.newInstance();</span><br><span class="line">	&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java支持多个上界，以 &amp; 分隔</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T extends Base &amp; Coparable &amp; Serializable</span><br></pre></td></tr></table></figure>

<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>每个已加载的类在内存都有一份类信息，每个对象都有指向它所属类信息的引用.  这里的类信息对应的类就是java.lang.Class. 且</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object.java </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> Class&lt;?&gt; getClass();</span><br></pre></td></tr></table></figure>

<p>可以通过object.getClass()获取，也可以通过类名直接.class获取 // tips, 基本类型没有.getClass()方法，但是通过int.class，也可以获得对应的Class对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e.g</span><br><span class="line">Class&lt;Date&gt; cls = Date.class;</span><br><span class="line">Class&lt;Integer&gt; cls = <span class="keyword">int</span>.class;</span><br><span class="line">Class&lt;Void&gt; cls = <span class="keyword">void</span>.class;</span><br></pre></td></tr></table></figure>

<p>也可以通过Class的静态方法.forName获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e.g</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; cls = Class.forName(<span class="string">"java.util.HashMap"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Class方法:</p>
<h3 id="名称信息"><a href="#名称信息" class="headerlink" title="名称信息"></a>名称信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> <span class="comment">//获取全称</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSimpleName</span><span class="params">()</span> <span class="comment">//获取不带包名的名称</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCanonicalName</span><span class="params">()</span> <span class="comment">//获取有好的名称</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">getPackage</span><span class="params">()</span> <span class="comment">//获取包名</span></span></span><br></pre></td></tr></table></figure>

<p>e.g</p>
<table>
<thead>
<tr>
<th align="left">Class对象</th>
<th align="right">getName</th>
<th align="center">getSimpleName</th>
<th>getCanonicalName</th>
<th>getPackage</th>
</tr>
</thead>
<tbody><tr>
<td align="left">int.class</td>
<td align="right">int</td>
<td align="center">int</td>
<td>int</td>
<td>null</td>
</tr>
<tr>
<td align="left">int[].calss</td>
<td align="right">[I</td>
<td align="center">int[]</td>
<td>int[]</td>
<td>null</td>
</tr>
<tr>
<td align="left">String.class</td>
<td align="right">java.lang.String</td>
<td align="center">String</td>
<td>java.lang.String</td>
<td>java.lang</td>
</tr>
</tbody></table>
<p>数组类型的getName返回值使用[表示数组，几个[表示几个数组.<br>数组的通用类型用一个字符表示, I -&gt; int, L -&gt; 表示类或接口, Z -&gt; boolean, B -&gt; byte, C -&gt; Char, D -&gt; double, F -&gt; float, J -&gt; long, S -&gt; short</p>
<h3 id="字段信息"><a href="#字段信息" class="headerlink" title="字段信息"></a>字段信息</h3><p>类中定义的静态和实例变量都被称为字段, 用Field表示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Field[] getFields() <span class="comment">//返回所有的public字段, 包括其父类的, 如果没有字段，返回空数组</span></span><br><span class="line"><span class="keyword">public</span> Field[] getDeclaredFields() <span class="comment">//返回本类声明的所有字段，包含非public，但不包括父类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Field <span class="title">getField</span><span class="params">(String name)</span> <span class="comment">//返回本类或者父类中指定名称的public字段，找不到抛异常NoSuchFieldException</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Field <span class="title">getDeclaredField</span><span class="params">(String name)</span> <span class="comment">//返回本类声明中指定名称的字段，找不到抛NoSuchFieldException</span></span></span><br></pre></td></tr></table></figure>

<p>对与Field类中的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> <span class="comment">//获取字段名称</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccessible</span><span class="params">()</span> <span class="comment">//当前程序是否有该字段的访问权限</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessible</span><span class="params">(<span class="keyword">boolean</span> flag)</span> <span class="comment">//flag为true, 表示忽略java访问检查机制, 以允许读写非public字段</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object obj)</span> <span class="comment">//获取知道对象obj中的该字段的值</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Object obj, Object value)</span> <span class="comment">//讲指定obj对象中的该字段设为value</span></span></span><br></pre></td></tr></table></figure>

<p>类中定义的静态和实例方法都被称为方法，用Method表示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Method[] getMethods() <span class="comment">//返回所有的public方法，包括其父类, 如果没有方法，返回空数组</span></span><br><span class="line"><span class="keyword">public</span> Method[] getDeclaredMethods() <span class="comment">//返回本类声明的所有方法，包括非public的，但不包括父类的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterType)</span> <span class="comment">//返回本类或父类指定名称和参数类型的public方法，找不到抛NoSuchException异常</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getDeclaredMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterType)</span> <span class="comment">//返回本类声明的指定名称和参数类型的方法，找不到抛NoSuchException异常</span></span></span><br></pre></td></tr></table></figure>

<h3 id="方法信息"><a href="#方法信息" class="headerlink" title="方法信息"></a>方法信息</h3><p>对于Method中的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">publci String <span class="title">getName</span><span class="params">()</span> <span class="comment">//获取方法名称</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessible</span><span class="params">(<span class="keyword">boolean</span> flag)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object... args)</span> <span class="keyword">throws</span> .... <span class="comment">// 在指定对象obj上调用Method代表的方法, 传递args参数列表</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果Method为静态方法，obj可以被忽略，可以为null</span></span></span><br></pre></td></tr></table></figure>

<h3 id="创建对象和构造方法"><a href="#创建对象和构造方法" class="headerlink" title="创建对象和构造方法"></a>创建对象和构造方法</h3><p>可以用newInstance() 调用类的默认构造函数，即无参构造函数的构造方法，来创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">()</span> <span class="keyword">throws</span> ....</span></span><br></pre></td></tr></table></figure>

<h3 id="类型检查和转换"><a href="#类型检查和转换" class="headerlink" title="类型检查和转换"></a>类型检查和转换</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">isInstance</span><span class="params">(Object obj)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(list <span class="keyword">instanceof</span> ArrayList)</span> 与 下面代码时一样的</span></span><br><span class="line"><span class="function">Class cls </span>= Class.forName(<span class="string">"java.util.ArrayList"</span>);</span><br><span class="line"><span class="keyword">if</span>(cls.isInstance(list))</span><br></pre></td></tr></table></figure>

<p>//….其他方法</p>
<p>总结:<br>反射虽然是灵活的，但一般情况下，不优先建议:</p>
<ol>
<li>反射容易出现运行时错误</li>
<li>反射性能低一点</li>
</ol>
<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><p>注解是给程序添加一些信息，用字符@开头， 这些信息用于修饰它后面紧挨着的其他代码元素，比如，类，接口，字段, 方法，方法中的参数，构造方法等。 注解可以被编译器，程序运行时和其他工具使用，用于增强和修改程序行为</p>
<p>依赖注入 TODO</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>动态代理是实现面向切片编程的基础AOP(Aspect Oriented Programming) TODO</p>
<h3 id="静态代理。"><a href="#静态代理。" class="headerlink" title="静态代理。"></a>静态代理。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">IService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RealService</span> <span class="keyword">implements</span> <span class="title">IService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceProxy</span> <span class="keyword">implements</span> <span class="title">IService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IService realService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TraceProxy</span><span class="params">(IService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.realService = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"entering sayHello"</span>);</span><br><span class="line">        <span class="keyword">this</span>.realService.sayHello();</span><br><span class="line">        System.out.println(<span class="string">"leaving sayHello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    IService realService = <span class="keyword">new</span> RealService();</span><br><span class="line">    IService proxyService = <span class="keyword">new</span> TraceProxy(realService);</span><br><span class="line">    proxyService.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理和实际对象一般有相同接口</p>
<h3 id="动态代理-1"><a href="#动态代理-1" class="headerlink" title="动态代理"></a>动态代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">IService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RealService</span> <span class="keyword">implements</span> <span class="title">IService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object realObject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleInvocationHandler</span><span class="params">(Object realObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.realObject = realObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"entering "</span> + method.getName());</span><br><span class="line">        Object result = method.invoke(realObject, args);</span><br><span class="line">        System.out.println(<span class="string">"leaving "</span> + method.getName());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    IService realService = <span class="keyword">new</span> RealService();</span><br><span class="line">    IService proxyService = (IService) Proxy.newProxyInstance(IService.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;IService.class&#125;, <span class="keyword">new</span> SimpleInvocationHandler((realService)));</span><br><span class="line">    proxyService.sayHello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span></span><br><span class="line"><span class="function"><span class="comment">// loader表示类加载器</span></span></span><br><span class="line"><span class="function"><span class="comment">// interfaces表示代理类要实现的接口列表</span></span></span><br><span class="line"><span class="function"><span class="comment">// INvocationHandler 只定义了一个方法invoke, 对代理接口所有方法的调用都会转到这里</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// TODO.....</span></span></span><br></pre></td></tr></table></figure>

<p>AOP… TODO</p>
<h2 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h2><p>类加载器ClassLoader就是加载其他类的类, 负责将字节码文件加载到内存，创建Class对象。 ClassLoader一般系统提供，不需要自己实现，但是，通过创建自定义的ClassLoader可以实现一些强大灵活的功能</p>
<ul>
<li>热部署 在不重启Java程序的情况下，动态替换类的实现</li>
<li>应用的模块化和相互隔离 不同的ClassLoader可以加载相同的类，但互相隔离，互不影响</li>
<li>不同的地方灵活加载 系统默认的ClassLoader一般从本地.class文件或者jar文件中加载字节码文件， 自定义的可以从共享的Web服务器等等地方加载</li>
</ul>
<p>一般程序运行，会有3个类加载器(Java9之前)</p>
<ol>
<li>启动加载器(Bootstrap ClassLoader)<br> 这个加载器是Java虚拟机实现的一部分，不是Java实现，一般是C++ 负责加载Java的基础类，主要是<java_home>/lib/rt.jar</java_home></li>
<li>拓展类加载器(Extension ClassLoader)<br> 这个类加载器的实现类是sun.misc.Launcher$ExtClassLoader, 负责加载Java的一些拓展类，主要是<java_home>/lib/ext.jar</java_home></li>
<li>应用程序类加载器(ApplicationClassLoader)<br> 这个加载器的实现类是sun.misc.Launcher$AppClassLoader, 负责加载应用程序的类，包括自己写的和第三方引用的</li>
</ol>
<p>加载一个类的过程是:</p>
<ol>
<li>判断是否已经加载过了，加载过了直接返回 Class对象，一个类只会被一个ClassLoader加载一次</li>
<li>如果没有加载，先让父ClassLoader去加载，如果成功，返回得到的Class对象</li>
<li>父ClassLoader没有成功的前提下，自己尝试加载类</li>
</ol>
<p>这个过程一般被称为双亲委派模型，即优先让父ClassLoader去加载，因为这样可以避免Java类库被覆盖的问题</p>
<p>TODO</p>
<h2 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h2><p>TODO</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/06/Translation-dumpsys工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/06/Translation-dumpsys工具/" itemprop="url">Translation-dumpsys工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-06T08:59:01+08:00">
                2019-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/06/Translation-dumpsys工具/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/06/Translation-dumpsys工具/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="dumpsys工具"><a href="#dumpsys工具" class="headerlink" title="dumpsys工具"></a>dumpsys工具</h1><p>翻译, 原文见<a href="https://developer.android.com/studio/command-line/dumpsys" target="_blank" rel="noopener">dympsys</a></p>
<p><code>dumpsys</code> is a tool that runs on Android devices and provides information about system services. You can call <code>dumpsys</code> from the command line using the <a href="https://developer.android.com/studio/command-line/adb.html" target="_blank" rel="noopener">Androi Debug Bridge(ADB)</a> to get diagonostic output for all system services running on a connected device. This output is typically more verbose than you may want, so use the command line options described below to get output for only the system services you’re interested in. This page also describes how to use <code>dumpsys</code> to accomplish common tasks, such as inspecting input, RAM, battery, or network diagnostics.</p>
<h2 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h2><p>The general syntax for using <code>dumpsys</code> is as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys [-t timeout] [--help | -l | --skip services | service [arguments] | -c | -h]</span><br></pre></td></tr></table></figure>

<p>To get a diagnostic output for all system services for your connected device, simply run <code>adb shell dumpsys</code>. However, this outputs far more information than you would typically want. For more manageable output, specify the service you want to examine by including it in the command. For example, the command below provides system data for input components, such as touchscreens or built-in keyboards:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys input</span><br></pre></td></tr></table></figure>

<p>For a complete list of system services that you can use with <code>dympsys</code>, use the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys -l</span><br></pre></td></tr></table></figure>

<h3 id="Command-line-options"><a href="#Command-line-options" class="headerlink" title="Command line options"></a>Command line options</h3><p>The following table lists the available options when using <code>dumpsys</code>.</p>
<table>
<thead>
<tr>
<th align="center">Option</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-t timeout</td>
<td align="center">Sepecifies the timeout period in seconds. When not specified, the default value is 10 seconds.</td>
</tr>
<tr>
<td align="center">- -help</td>
<td align="center">Prints out help text for the dumpsys tool</td>
</tr>
<tr>
<td align="center">-l</td>
<td align="center">Outputs a complete list of system services that you can use with dumpsys.</td>
</tr>
<tr>
<td align="center">- -skip <font color="red">services</font></td>
<td align="center">Specifies the <font color="red">services</font> that you do not want to include in the output.</td>
</tr>
<tr>
<td align="center"><font color="red">service</font> [<font color="red">arguments</font>]</td>
<td align="center">Specifies the <font color="red">service</font> that you want to output. Some services may allow you to pass optional <font color="red">arguments</font>. You can learn about these optional arguments by passing the -h option with the service, as shown below: adb shell dumpsys procstats -h</td>
</tr>
<tr>
<td align="center">-c</td>
<td align="center">When specifying certain services, append this option to output data in a machine-friendly format.</td>
</tr>
<tr>
<td align="center">-h</td>
<td align="center">For certain services, append this option to see help text and additional options for that service.</td>
</tr>
</tbody></table>
<h2 id="Inspect-input-diagnostics"><a href="#Inspect-input-diagnostics" class="headerlink" title="Inspect input diagnostics"></a>Inspect input diagnostics</h2><p>Sepcifying the <code>input</code> service, as shown below, dumps the state of the system’s input devices, such as keyboards and touchscreens, and the processing of input events.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys input</span><br></pre></td></tr></table></figure>

<p>The output varies depending on the version of Android running on the connected device. The sections below describe the type of infomation you typically see.</p>
<h3 id="Event-hub-state"><a href="#Event-hub-state" class="headerlink" title="Event hub state"></a>Event hub state</h3><p>The following is a sample of what you might see when inspecting the Event Hub State of the input diagnostics:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">INPUT MANAGER (dumpsys input)</span><br><span class="line"></span><br><span class="line">Event Hub State:</span><br><span class="line">  BuiltInKeyboardId: -2</span><br><span class="line">  Devices:</span><br><span class="line">    -1: Virtual</span><br><span class="line">      Classes: 0x40000023</span><br><span class="line">      Path: </span><br><span class="line">      Descriptor: a718a782d34bc767f4689c232d64d527998ea7fd</span><br><span class="line">      Location:</span><br><span class="line">      ControllerNumber: 0</span><br><span class="line">      UniqueId: </span><br><span class="line">      Identifier: bus=0x0000, vendor=0x0000, product=0x0000, version=0x0000</span><br><span class="line">      KeyLayoutFile: /system/usr/keylayout/Generic.kl</span><br><span class="line">      KeyCharacterMapFile: /system/usr/keychars/Virtual.kcm</span><br><span class="line">      ConfigurationFile:</span><br><span class="line">      HaveKeyboardLayoutOverlay: false</span><br><span class="line">    1: msm8974-taiko-mtp-snd-card Headset Jack</span><br><span class="line">      Classes: 0x00000080</span><br><span class="line">      Path: /dev/input/event5</span><br><span class="line">      Descriptor: c8e3782483b4837ead6602e20483c46ff801112c</span><br><span class="line">      Location: ALSA</span><br><span class="line">      ControllerNumber: 0</span><br><span class="line">      UniqueId:</span><br><span class="line">      Identifier: bus=0x0000, vendor=0x0000, product=0x0000, version=0x0000</span><br><span class="line">      KeyLayoutFile:</span><br><span class="line">      KeyCharacterMapFile:</span><br><span class="line">      ConfigurationFile:</span><br><span class="line">      HaveKeyboardLayoutOverlay: false</span><br><span class="line">    2: msm8974-taiko-mtp-snd-card Button Jack</span><br><span class="line">      Classes: 0x00000001</span><br><span class="line">      Path: /dev/input/event4</span><br><span class="line">      Descriptor: 96fe62b244c555351ec576b282232e787fb42bab</span><br><span class="line">      Location: ALSA</span><br><span class="line">      ControllerNumber: 0</span><br><span class="line">      UniqueId:</span><br><span class="line">      Identifier: bus=0x0000, vendor=0x0000, product=0x0000, version=0x0000</span><br><span class="line">      KeyLayoutFile: /system/usr/keylayout/msm8974-taiko-mtp-snd-card_Button_Jack.kl</span><br><span class="line">      KeyCharacterMapFile: /system/usr/keychars/msm8974-taiko-mtp-snd-card_Button_Jack.kcm</span><br><span class="line">      ConfigurationFile:</span><br><span class="line">      HaveKeyboardLayoutOverlay: false</span><br><span class="line">    3: hs_detect</span><br><span class="line">      Classes: 0x00000081</span><br><span class="line">      Path: /dev/input/event3</span><br><span class="line">      Descriptor: 485d69228e24f5e46da1598745890b214130dbc4</span><br><span class="line">      Location:</span><br><span class="line">      ControllerNumber: 0</span><br><span class="line">      UniqueId:</span><br><span class="line">      Identifier: bus=0x0000, vendor=0x0001, product=0x0001, version=0x0001</span><br><span class="line">      KeyLayoutFile: /system/usr/keylayout/hs_detect.kl</span><br><span class="line">      KeyCharacterMapFile: /system/usr/keychars/hs_detect.kcm</span><br><span class="line">      ConfigurationFile:</span><br><span class="line">      HaveKeyboardLayoutOverlay: false</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Input-reader-state"><a href="#Input-reader-state" class="headerlink" title="Input reader state"></a>Input reader state</h3><p>The <code>InputReader</code> is responsible for decoding input events from the kernel. Its state dump shows information about how each input device is configured and recent state changes that have occured, such as key presses or touches on the touch screen.<br>The following sample shows the output for a touch screen. Note the information about the resolution of the device and the calibration parameters that were used.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Input Reader State</span><br><span class="line">...</span><br><span class="line">  Device 6: Melfas MMSxxx Touchscreen</span><br><span class="line">      IsExternal: false</span><br><span class="line">      Sources: 0x00001002</span><br><span class="line">      KeyboardType: 0</span><br><span class="line">      Motion Ranges:</span><br><span class="line">        X: source=0x00001002, min=0.000, max=719.001, flat=0.000, fuzz=0.999</span><br><span class="line">        Y: source=0x00001002, min=0.000, max=1279.001, flat=0.000, fuzz=0.999</span><br><span class="line">        PRESSURE: source=0x00001002, min=0.000, max=1.000, flat=0.000, fuzz=0.000</span><br><span class="line">        SIZE: source=0x00001002, min=0.000, max=1.000, flat=0.000, fuzz=0.000</span><br><span class="line">        TOUCH_MAJOR: source=0x00001002, min=0.000, max=1468.605, flat=0.000, fuzz=0.000</span><br><span class="line">        TOUCH_MINOR: source=0x00001002, min=0.000, max=1468.605, flat=0.000, fuzz=0.000</span><br><span class="line">        TOOL_MAJOR: source=0x00001002, min=0.000, max=1468.605, flat=0.000, fuzz=0.000</span><br><span class="line">        TOOL_MINOR: source=0x00001002, min=0.000, max=1468.605, flat=0.000, fuzz=0.000</span><br><span class="line">      Touch Input Mapper:</span><br><span class="line">        Parameters:</span><br><span class="line">          GestureMode: spots</span><br><span class="line">          DeviceType: touchScreen</span><br><span class="line">          AssociatedDisplay: id=0, isExternal=false</span><br><span class="line">          OrientationAware: true</span><br><span class="line">        Raw Touch Axes:</span><br><span class="line">          X: min=0, max=720, flat=0, fuzz=0, resolution=0</span><br><span class="line">          Y: min=0, max=1280, flat=0, fuzz=0, resolution=0</span><br><span class="line">          Pressure: min=0, max=255, flat=0, fuzz=0, resolution=0</span><br><span class="line">          TouchMajor: min=0, max=30, flat=0, fuzz=0, resolution=0</span><br><span class="line">          TouchMinor: unknown range</span><br><span class="line">          ToolMajor: unknown range</span><br><span class="line">          ToolMinor: unknown range</span><br><span class="line">          Orientation: unknown range</span><br><span class="line">          Distance: unknown range</span><br><span class="line">          TiltX: unknown range</span><br><span class="line">          TiltY: unknown range</span><br><span class="line">          TrackingId: min=0, max=65535, flat=0, fuzz=0, resolution=0</span><br><span class="line">          Slot: min=0, max=9, flat=0, fuzz=0, resolution=0</span><br><span class="line">        Calibration:</span><br><span class="line">          touch.size.calibration: diameter</span><br><span class="line">          touch.size.scale: 10.000</span><br><span class="line">          touch.size.bias: 0.000</span><br><span class="line">          touch.size.isSummed: false</span><br><span class="line">          touch.pressure.calibration: amplitude</span><br><span class="line">          touch.pressure.scale: 0.005</span><br><span class="line">          touch.orientation.calibration: none</span><br><span class="line">          touch.distance.calibration: none</span><br><span class="line">        SurfaceWidth: 720px</span><br><span class="line">        SurfaceHeight: 1280px</span><br><span class="line">        SurfaceOrientation: 0</span><br><span class="line">        Translation and Scaling Factors:</span><br><span class="line">          XScale: 0.999</span><br><span class="line">          YScale: 0.999</span><br><span class="line">          XPrecision: 1.001</span><br><span class="line">          YPrecision: 1.001</span><br><span class="line">          GeometricScale: 0.999</span><br><span class="line">          PressureScale: 0.005</span><br><span class="line">          SizeScale: 0.033</span><br><span class="line">          OrientationCenter: 0.000</span><br><span class="line">          OrientationScale: 0.000</span><br><span class="line">          DistanceScale: 0.000</span><br><span class="line">          HaveTilt: false</span><br><span class="line">          TiltXCenter: 0.000</span><br><span class="line">          TiltXScale: 0.000</span><br><span class="line">          TiltYCenter: 0.000</span><br><span class="line">          TiltYScale: 0.000</span><br><span class="line">        Last Button State: 0x00000000</span><br><span class="line">        Last Raw Touch: pointerCount=0</span><br><span class="line">        Last Cooked Touch: pointerCount=0</span><br></pre></td></tr></table></figure>

<p>At the end of the input reader state dump there is some information about global configuration parameters, such as the tap interval.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Configuration:</span><br><span class="line">  ExcludedDeviceNames: []</span><br><span class="line">  VirtualKeyQuietTime: 0.0ms</span><br><span class="line">  PointerVelocityControlParameters: scale=1.000, lowThreshold=500.000, highThreshold=3000.000, acceleration=3.000</span><br><span class="line">  WheelVelocityControlParameters: scale=1.000, lowThreshold=15.000, highThreshold=50.000, acceleration=4.000</span><br><span class="line">  PointerGesture:</span><br><span class="line">    Enabled: true</span><br><span class="line">    QuietInterval: 100.0ms</span><br><span class="line">    DragMinSwitchSpeed: 50.0px/s</span><br><span class="line">    TapInterval: 150.0ms</span><br><span class="line">    TapDragInterval: 300.0ms</span><br><span class="line">    TapSlop: 20.0px</span><br><span class="line">    MultitouchSettleInterval: 100.0ms</span><br><span class="line">    MultitouchMinDistance: 15.0px</span><br><span class="line">    SwipeTransitionAngleCosine: 0.3</span><br><span class="line">    SwipeMaxWidthRatio: 0.2</span><br><span class="line">    MovementSpeedRatio: 0.8</span><br><span class="line">    ZoomSpeedRatio: 0.3</span><br></pre></td></tr></table></figure>

<h3 id="Input-dispatcher-state"><a href="#Input-dispatcher-state" class="headerlink" title="Input dispatcher state"></a>Input dispatcher state</h3><p>The <code>InputDispatcher</code> is responsible for sending input events to applications. As shown in the sample output below, its state dump shows information about which window is being touched, the state of the input queue, whether an ANR is in progress, and so on.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Input Dispatcher State:</span><br><span class="line">  DispatchEnabled: 1</span><br><span class="line">  DispatchFrozen: 0</span><br><span class="line">  FocusedApplication: &lt;null&gt;</span><br><span class="line">  FocusedWindow: name='Window&#123;3fb06dc3 u0 StatusBar&#125;'</span><br><span class="line">  TouchStates: &lt;no displays touched&gt;</span><br><span class="line">  Windows:</span><br><span class="line">    0: name='Window&#123;357bbbfe u0 SearchPanel&#125;', displayId=0, paused=false, hasFocus=false, hasWallpaper=false, visible=false, canReceiveKeys=false, flags=0x01820100, type=0x000007e8, layer=211000, frame=[0,0][1080,1920], scale=1.000000, touchableRegion=[0,0][1080,1920], inputFeatures=0x00000000, ownerPid=22674, ownerUid=10020, dispatchingTimeout=5000.000ms</span><br><span class="line">    1: name='Window&#123;3b14c0ca u0 NavigationBar&#125;', displayId=0, paused=false, hasFocus=false, hasWallpaper=false, visible=false, canReceiveKeys=false, flags=0x01840068, type=0x000007e3, layer=201000, frame=[0,1776][1080,1920], scale=1.000000, touchableRegion=[0,1776][1080,1920], inputFeatures=0x00000000, ownerPid=22674, ownerUid=10020, dispatchingTimeout=5000.000ms</span><br><span class="line">    2: name='Window&#123;2c7e849c u0 com.vito.lux&#125;', displayId=0, paused=false, hasFocus=false, hasWallpaper=false, visible=true, canReceiveKeys=false, flags=0x0089031a, type=0x000007d6, layer=191000, frame=[-495,-147][1575,1923], scale=1.000000, touchableRegion=[-495,-147][1575,1923], inputFeatures=0x00000000, ownerPid=4697, ownerUid=10084, dispatchingTimeout=5000.000ms</span><br><span class="line">    ...</span><br><span class="line">  MonitoringChannels:</span><br><span class="line">    0: 'WindowManager (server)'</span><br><span class="line">  RecentQueue: length=10</span><br><span class="line">    MotionEvent(deviceId=4, source=0x00001002, action=2, flags=0x00000000, metaState=0x00000000, buttonState=0x00000000, edgeFlags=0x00000000, xPrecision=1.0, yPrecision=1.0, displayId=0, pointers=[0: (335.0, 1465.0)]), policyFlags=0x62000000, age=217264.0ms</span><br><span class="line">    MotionEvent(deviceId=4, source=0x00001002, action=1, flags=0x00000000, metaState=0x00000000, buttonState=0x00000000, edgeFlags=0x00000000, xPrecision=1.0, yPrecision=1.0, displayId=0, pointers=[0: (335.0, 1465.0)]), policyFlags=0x62000000, age=217255.7ms</span><br><span class="line">    MotionEvent(deviceId=4, source=0x00001002, action=0, flags=0x00000000, metaState=0x00000000, buttonState=0x00000000, edgeFlags=0x00000000, xPrecision=1.0, yPrecision=1.0, displayId=0, pointers=[0: (330.0, 1283.0)]), policyFlags=0x62000000, age=216805.0ms</span><br><span class="line">    ...</span><br><span class="line">  PendingEvent: &lt;none&gt;</span><br><span class="line">  InboundQueue: &lt;empty&gt;</span><br><span class="line">  ReplacedKeys: &lt;empty&gt;</span><br><span class="line">  Connections:</span><br><span class="line">    0: channelName='WindowManager (server)', windowName='monitor', status=NORMAL, monitor=true, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    1: channelName='278c1d65 KeyguardScrim (server)', windowName='Window&#123;278c1d65 u0 KeyguardScrim&#125;', status=NORMAL, monitor=false, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    2: channelName='357bbbfe SearchPanel (server)', windowName='Window&#123;357bbbfe u0 SearchPanel&#125;', status=NORMAL, monitor=false, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    ...</span><br><span class="line">  AppSwitch: not pending</span><br><span class="line">    7: channelName='2280455f com.google.android.gm/com.google.android.gm.ConversationListActivityGmail (server)', windowName='Window&#123;2280455f u0 com.google.android.gm/com.google.android.gm.ConversationListActivityGmail&#125;', status=NORMAL, monitor=false, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    8: channelName='1a7be08a com.android.systemui/com.android.systemui.recents.RecentsActivity (server)', windowName='Window&#123;1a7be08a u0 com.android.systemui/com.android.systemui.recents.RecentsActivity EXITING&#125;', status=NORMAL, monitor=false, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    9: channelName='3b14c0ca NavigationBar (server)', windowName='Window&#123;3b14c0ca u0 NavigationBar&#125;', status=NORMAL, monitor=false, inputPublisherBlocked=false</span><br><span class="line">      OutboundQueue: &lt;empty&gt;</span><br><span class="line">      WaitQueue: &lt;empty&gt;</span><br><span class="line">    ...</span><br><span class="line">  Configuration:</span><br><span class="line">    KeyRepeatDelay: 50.0ms</span><br><span class="line">    KeyRepeatTimeout: 500.0ms</span><br></pre></td></tr></table></figure>

<h3 id="Things-to-check-for"><a href="#Things-to-check-for" class="headerlink" title="Things to check for"></a>Things to check for</h3><p>The following is a list of things to cnosider when inspecting the various output for the <code>input</code> service:</p>
<p>Event hub state:</p>
<ul>
<li>All of the input devices you expect are present.</li>
<li>Each input device has an appropriate key layout file, key character map file, and input device configuration file. If the files are missing or contain syntax errors, then they will not be loaded.</li>
<li>Each input device is classified correctly. The bits in the <code>Classes</code> field correspond to flags in <code>EventHub.h</code>, such as <code>INPUT_DEVICE_CLASS_TOUCH_MT</code>.</li>
<li>The <code>BuiltInKeyboardId</code> is correct. If the device does not have a built-in keyboard , then the id must be <code>-2</code>. Otherwise, it should be the id of the built-in keyboard.<ul>
<li>If you observe that the <code>BuiltInKeyboardId</code> is not <code>-2</code> but it should be, then you are missing a key character map file for a special function keypad somwhere. Special function keypad devices should have key character map files that contain just the line <code>type SPECIAL_FUNCTION</code>(that’s what in the <code>tuna-gpio-keykad.kcm</code> file we see mentioned above).</li>
</ul>
</li>
</ul>
<p>Input reader state:</p>
<ul>
<li>All of the expected input devices are present.</li>
<li>Each input device is configured correctly. In particular, check that the touch screen and joystick axes are correct.</li>
</ul>
<p>Input dispatcher state:</p>
<ul>
<li>All input events are processed as expected.</li>
<li>After touching the touch screen and running <code>dumpsys</code> at the same time, the <code>TouchStates</code> line correctly identifies the window that you are touching.</li>
</ul>
<h2 id="Test-UI-performance"><a href="#Test-UI-performance" class="headerlink" title="Test UI performance"></a>Test UI performance</h2><p>Specifying the <code>gfxinfo</code> service provides output with performance information relating to frames of animation that are occurring during the recording phase. The following command uses <code>gfxinfo</code> to gather UI performance data for a specified package name:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys gfxinfo package-name</span><br></pre></td></tr></table></figure>

<p>You can also include the <code>framestats</code> option to provide even more detailed frame timing information from recent frames, so that you can track down and debug problems more accurately, shown below:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys gfxinfo package-name framestats</span><br></pre></td></tr></table></figure>

<p>To learn more about using <code>gfxinfo</code> and <code>framestates</code> to integrate UI performance measurements into your testing practices, go to <a href="https://developer.android.com/training/testing/performance.html" target="_blank" rel="noopener">Testing UI performance</a></p>
<h2 id="Inspect-network-diagnostics"><a href="#Inspect-network-diagnostics" class="headerlink" title="Inspect network diagnostics"></a>Inspect network diagnostics</h2><p>Specifying the <code>netstats</code> service provides network usage statistics collected since the previous device booted up.  To output additional information, such as detailed unique user ID(UID) information, include the <code>detail</code> option, as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys netstats detail</span><br></pre></td></tr></table></figure>

<p>The output varies depending on the version of Android running on the connected device. The sections below describe the type of information you typically see.</p>
<h3 id="Active-interfaces-and-active-UID-interfaces"><a href="#Active-interfaces-and-active-UID-interfaces" class="headerlink" title="Active interfaces and active UID interfaces"></a>Active interfaces and active UID interfaces</h3><p>The following sample output lists the active interfaces and active UID interfaces of the connected device. In most cases, the infomration for active interfaces and active UID interfaces is the same.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active interfaces:</span><br><span class="line">  iface=wlan0 ident=[&#123;type=WIFI, subType=COMBINED, networkId="Guest"&#125;]</span><br><span class="line">Active UID interfaces:</span><br><span class="line">  iface=wlan0 ident=[&#123;type=WIFI, subType=COMBINED, networkId="Guest"&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="‘Dev’-and-‘Xt’-statistics"><a href="#‘Dev’-and-‘Xt’-statistics" class="headerlink" title="‘Dev’ and ‘Xt’ statistics"></a>‘Dev’ and ‘Xt’ statistics</h3><p>The following is a sample output for the Dev statistics section:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Dev stats:</span><br><span class="line">  Pending bytes: 1798112</span><br><span class="line">  History since boot:</span><br><span class="line">  ident=[&#123;type=WIFI, subType=COMBINED, networkId="Guest", metered=false&#125;] uid=-1 set=ALL tag=0x0</span><br><span class="line">    NetworkStatsHistory: bucketDuration=3600</span><br><span class="line">      st=1497891600 rb=1220280 rp=1573 tb=309870 tp=1271 op=0</span><br><span class="line">      st=1497895200 rb=29733 rp=145 tb=85354 tp=185 op=0</span><br><span class="line">      st=1497898800 rb=46784 rp=162 tb=42531 tp=192 op=0</span><br><span class="line">      st=1497902400 rb=27570 rp=111 tb=35990 tp=121 op=0</span><br><span class="line">Xt stats:</span><br><span class="line">  Pending bytes: 1771782</span><br><span class="line">  History since boot:</span><br><span class="line">  ident=[&#123;type=WIFI, subType=COMBINED, networkId="Guest", metered=false&#125;] uid=-1 set=ALL tag=0x0</span><br><span class="line">    NetworkStatsHistory: bucketDuration=3600</span><br><span class="line">      st=1497891600 rb=1219598 rp=1557 tb=291628 tp=1255 op=0</span><br><span class="line">      st=1497895200 rb=29623 rp=142 tb=82699 tp=182 op=0</span><br><span class="line">      st=1497898800 rb=46684 rp=160 tb=39756 tp=191 op=0</span><br><span class="line">      st=1497902400 rb=27528 rp=110 tb=34266 tp=120 op=0</span><br></pre></td></tr></table></figure>

<h3 id="UID-stats"><a href="#UID-stats" class="headerlink" title="UID stats"></a>UID stats</h3><p>The following is a sample of detailed statistics of each UID.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UID stats:</span><br><span class="line">  Pending bytes: 744</span><br><span class="line">  Complete history:</span><br><span class="line">  ident=[[type=MOBILE_SUPL, subType=COMBINED, subscriberId=311111...], [type=MOBILE, subType=COMBINED, subscriberId=311111...]] uid=10007  set=DEFAULT tag=0x0</span><br><span class="line">    NetworkStatsHistory: bucketDuration=7200000</span><br><span class="line">      bucketStart=1406167200000 activeTime=7200000 rxBytes=4666 rxPackets=7 txBytes=1597 txPackets=10 operations=0</span><br><span class="line">  ident=[[type=WIFI, subType=COMBINED, networkId="MySSID"]] uid=10007  set=DEFAULT tag=0x0</span><br><span class="line">    NetworkStatsHistory: bucketDuration=7200000</span><br><span class="line">      bucketStart=1406138400000 activeTime=7200000 rxBytes=17086802 rxPackets=15387 txBytes=1214969 txPackets=8036 operations=28</span><br><span class="line">      bucketStart=1406145600000 activeTime=7200000 rxBytes=2396424 rxPackets=2946 txBytes=464372 txPackets=2609 operations=70</span><br><span class="line">      bucketStart=1406152800000 activeTime=7200000 rxBytes=200907 rxPackets=606 txBytes=187418 txPackets=739 operations=0</span><br><span class="line">      bucketStart=1406160000000 activeTime=7200000 rxBytes=826017 rxPackets=1126 txBytes=267342 txPackets=1175 operations=35</span><br></pre></td></tr></table></figure>

<p>To find the UID for your app, run this command : <code>adb shell dumpsys package your-package-name</code>. Then look for the line labeled <code>userId</code>.</p>
<p>For example, to find network usage for the app ‘com.example.myapp’, run the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys package com.example.myapp | grep userId</span><br></pre></td></tr></table></figure>

<p>the output should be similar to the following:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userid = 10007 gids = [3003, 1028, 1015]</span><br></pre></td></tr></table></figure>

<p>Using the sample dump above, look for the lines that have <code>uid = 10007</code>. Two such lines exist-the first indicates a mobile connection and the second indicates a Wi-Fi connection. Below each line, you can see the following information for each two-hour window(which <code>bucketDuration</code> specifies in milliseconds):</p>
<ul>
<li><code>set=DEFAULT</code> indicates foreground network usage, while <code>set=BACKGROUND</code> indicates background usage. <code>set=ALL</code> implies both</li>
<li><code>tag=0x0</code> indicates the socket tag associated with the traffic. </li>
<li><code>rxBytes</code> and <code>rxPackets</code> represent received bytes and received packets in the corresponding time interval.</li>
<li><code>txBytes</code> and <code>txPackets</code> represent sent(transmitted) bytes and sent packets in the corresponding time interval.</li>
</ul>
<h2 id="Inspect-battery-diagnostics"><a href="#Inspect-battery-diagnostics" class="headerlink" title="Inspect battery diagnostics"></a>Inspect battery diagnostics</h2><p>Specifying the <code>batterystats</code> service generates interesting statistical data about battery usage on a device, organized by unique user ID(UID). To learn how to use <code>dumpsys</code> to test your app for Doze and App Standby, go to <a href="https://developer.android.com/training/monitoring-device-state/doze-standby.html#testing_doze_and_app_standby" target="_blank" rel="noopener">Testing with Doze and App Standby</a>.</p>
<p>The command for <code>batterystats</code> is as follows:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys batterystats options</span><br></pre></td></tr></table></figure>

<p>To see a list of additional options available to <code>batterystats</code>, include the <code>-h</code> option. The example below outputs battery usage statistics for a specified app package since the device was last charged:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys batterystats --charged package-name</span><br></pre></td></tr></table></figure>

<p>The output typically includes the following:</p>
<ul>
<li>History of battery-related events</li>
<li>Global statistics for the device</li>
<li>Approximate power use per UID and system component</li>
<li>Per-app mobile milliseconds per packet</li>
<li>System UID aggregated statistics</li>
<li>App UID aggregated statistics</li>
</ul>
<p>To learn more about using <code>batterystats</code> and generating an HTML visualization of the output, which makes it easier to understand and diagnose battery-related issues, read <a href="https://developer.android.com/studio/profile/battery-historian.html" target="_blank" rel="noopener">Profile battery usage with Batterystats and Battery Historian</a>.</p>
<h3 id="Inspecting-machine-friendly-output"><a href="#Inspecting-machine-friendly-output" class="headerlink" title="Inspecting machine-friendly output"></a>Inspecting machine-friendly output</h3><p>You can generate <code>batterystats</code> output in machine-readable CSV format by using the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys batterystats --checkin</span><br></pre></td></tr></table></figure>

<p>The following is an example of the output you should see:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">9,0,i,vers,11,116,K,L</span><br><span class="line">9,0,i,uid,1000,android</span><br><span class="line">9,0,i,uid,1000,com.android.providers.settings</span><br><span class="line">9,0,i,uid,1000,com.android.inputdevices</span><br><span class="line">9,0,i,uid,1000,com.android.server.telecom</span><br><span class="line">...</span><br><span class="line">9,0,i,dsd,1820451,97,s-,p-</span><br><span class="line">9,0,i,dsd,3517481,98,s-,p-</span><br><span class="line">9,0,l,bt,0,8548446,1000983,8566645,1019182,1418672206045,8541652,994188</span><br><span class="line">9,0,l,gn,0,0,666932,495312,0,0,2104,1444</span><br><span class="line">9,0,l,m,6794,0,8548446,8548446,0,0,0,666932,495312,0,697728,0,0,0,5797,0,0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Battery-usage observations may be per-UID or system-level; data is selected for inclusion based on its usefulness in analyzing battery performance. Each row represents an observation with the following elements:</p>
<ul>
<li>A dummy integer</li>
<li>The user ID associated with the observation</li>
<li>The aggregation mode:<ul>
<li>“i” for information not tied to charged/uncharged status.</li>
<li>“I” for –charged(usage since last charge).</li>
<li>“u” for –unplugged(usage since last unplugged). Deprecated in Android 5.1.1</li>
</ul>
</li>
<li>Section identifier, which determines how to interpret subsequent values in the line</li>
</ul>
<p>The table below describes the various section identifiers you may see:<br>// TODO </p>
<h2 id="View-memory-allocations"><a href="#View-memory-allocations" class="headerlink" title="View memory allocations"></a>View memory allocations</h2><p>You can inspect your app’s memory usage in one of two ways: over a period of time using <code>procstats</code> or at a particular snapshot in time using <code>meminfo</code>. The sections below show you how to use either method.</p>
<h3 id="procstats"><a href="#procstats" class="headerlink" title="procstats"></a>procstats</h3><p><code>procstats</code> makes it possible to see how your app is behaving over time-including how long it runs in the background and how much memory it uses during that time. It helps you quickly find inefficiencies and misbehaviors in your app, such as memory leaks, that can affect how it performs , especially when running on low-memory devices. Its state dump displays statistics about every application’s runtime, proportional set size(PSS) and unique set size(USS).</p>
<p>To get application memory usage stats over the last three hours, in human-readable format, run the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys procstats --hours 3</span><br></pre></td></tr></table></figure>

<p>As can be seen in the example below, the output displays what percentage of time the application was running , and the PSS and USS as <code>minPSS-avgPSS-maxPSS/minUSS-avgUSS-maxUSS</code> over the number of samples.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">AGGREGATED OVER LAST 3 HOURS:</span><br><span class="line">  * com.android.systemui / u0a20 / v22:</span><br><span class="line">           TOTAL: 100% (109MB-126MB-159MB/108MB-125MB-157MB over 18)</span><br><span class="line">      Persistent: 100% (109MB-126MB-159MB/108MB-125MB-157MB over 18)</span><br><span class="line">  * com.android.nfc / 1027 / v22:</span><br><span class="line">           TOTAL: 100% (17MB-17MB-17MB/16MB-16MB-16MB over 18)</span><br><span class="line">      Persistent: 100% (17MB-17MB-17MB/16MB-16MB-16MB over 18)</span><br><span class="line">  * android.process.acore / u0a4 / v22:</span><br><span class="line">           TOTAL: 100% (14MB-15MB-15MB/14MB-14MB-14MB over 20)</span><br><span class="line">          Imp Fg: 100% (14MB-15MB-15MB/14MB-14MB-14MB over 20)</span><br><span class="line">  ...</span><br><span class="line">  * com.coulombtech / u0a106 / v26:</span><br><span class="line">           TOTAL: 0.01%</span><br><span class="line">        Receiver: 0.01%</span><br><span class="line">        (Cached): 21% (4.9MB-5.0MB-5.2MB/3.8MB-3.9MB-4.1MB over 2)</span><br><span class="line">  * com.softcoil.mms / u0a86 / v32:</span><br><span class="line">           TOTAL: 0.01%</span><br><span class="line">        (Cached): 0.25%</span><br><span class="line">  * com.udemy.android / u0a91 / v38:</span><br><span class="line">           TOTAL: 0.01%</span><br><span class="line">        Receiver: 0.01%</span><br><span class="line">        (Cached): 0.75% (9.8MB-9.8MB-9.8MB/8.5MB-8.5MB-8.5MB over 1)</span><br><span class="line">  ...</span><br><span class="line">Run time Stats:</span><br><span class="line">  SOff/Norm: +32m52s226ms</span><br><span class="line">  SOn /Norm: +2h10m8s364ms</span><br><span class="line">       Mod : +17s930ms</span><br><span class="line">      TOTAL: +2h43m18s520ms</span><br><span class="line"></span><br><span class="line">Memory usage:</span><br><span class="line">  Kernel : 265MB (38 samples)</span><br><span class="line">  Native : 73MB (38 samples)</span><br><span class="line">  Persist: 262MB (90 samples)</span><br><span class="line">  Top    : 190MB (325 samples)</span><br><span class="line">  ImpFg  : 204MB (569 samples)</span><br><span class="line">  ImpBg  : 754KB (345 samples)</span><br><span class="line">  Service: 93MB (1912 samples)</span><br><span class="line">  Receivr: 227KB (1169 samples)</span><br><span class="line">  Home   : 66MB (12 samples)</span><br><span class="line">  LastAct: 30MB (255 samples)</span><br><span class="line">  CchAct : 220MB (450 samples)</span><br><span class="line">  CchCAct: 193MB (71 samples)</span><br><span class="line">  CchEmty: 182MB (652 samples)</span><br><span class="line">  Cached : 58MB (38 samples)</span><br><span class="line">  Free   : 60MB (38 samples)</span><br><span class="line">  TOTAL  : 1.9GB</span><br><span class="line">  ServRst: 50KB (278 samples)</span><br><span class="line"></span><br><span class="line">          Start time: 2015-04-08 13:44:18</span><br><span class="line">  Total elapsed time: +2h43m18s521ms (partial) libart.so</span><br></pre></td></tr></table></figure>

<h3 id="meminfo"><a href="#meminfo" class="headerlink" title="meminfo"></a>meminfo</h3><p>You can record a snapshot of how your app’s memory is divided between different types of RAM allocation with the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys meminfo package_name|pid [-d]</span><br></pre></td></tr></table></figure>

<p>The -d flag prints more info related to Dalvik and ART memory usage.<br>The output lists all of your app’s current allocations, measured in kilobytes.<br>When inspecting this information, you should be familiar with the following types of allocation:</p>
<ul>
<li>Private(Clean and Dirty) RAM<br>  This is memory that is being used by only your process. This is the bulk of the RAM that the system can reclaim when your app’s process is destroyed. Generally, the most important portion of this is private dirty RAM, which is the most expensive because it is used by only your process and its contents exist only in RAM so can’t be paged to storage(beacuse Android does not use swap). All Dalvik and native heap allocations your make will be private dirty RAM; Dalvik and native allocations you share with the Zygote process are shared dirty RAM.</li>
<li>Proportional Set Size (PSS)<br>  This is a measurement of your app’s RAM use that takes into account sharing pages across processes. Any RAM pages that are unique to your process directly contribute to its PSS value, while pages that are shared with other processes contribute to the PSS value only in proportion to the amount of sharing. For example, a page that is shared between two processes will contribute half of its size to the PSS of each process.</li>
</ul>
<p>A nice characteristic of the PSS measurement is that you can add up the PSS across all processes to determine the actual memory being used by all processes. This means PSS is a good measure for the actual RAM weight of a process and for comparison against the RAM use of other processes and the total available RAm.</p>
<p>For example, below is the output for Map’s process on a Nexus 5 device. There is a lot of information here, but key points for discussion are listed below.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys meminfo com.google.android.apps.maps -d</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">** MEMINFO in pid 18227 [com.google.android.apps.maps] **</span><br><span class="line">                   Pss  Private  Private  Swapped     Heap     Heap     Heap</span><br><span class="line">                 Total    Dirty    Clean    Dirty     Size    Alloc     Free</span><br><span class="line">                ------   ------   ------   ------   ------   ------   ------</span><br><span class="line">  Native Heap    10468    10408        0        0    20480    14462     6017</span><br><span class="line">  Dalvik Heap    34340    33816        0        0    62436    53883     8553</span><br><span class="line"> Dalvik Other      972      972        0        0</span><br><span class="line">        Stack     1144     1144        0        0</span><br><span class="line">      Gfx dev    35300    35300        0        0</span><br><span class="line">    Other dev        5        0        4        0</span><br><span class="line">     .so mmap     1943      504      188        0</span><br><span class="line">    .apk mmap      598        0      136        0</span><br><span class="line">    .ttf mmap      134        0       68        0</span><br><span class="line">    .dex mmap     3908        0     3904        0</span><br><span class="line">    .oat mmap     1344        0       56        0</span><br><span class="line">    .art mmap     2037     1784       28        0</span><br><span class="line">   Other mmap       30        4        0        0</span><br><span class="line">   EGL mtrack    73072    73072        0        0</span><br><span class="line">    GL mtrack    51044    51044        0        0</span><br><span class="line">      Unknown      185      184        0        0</span><br><span class="line">        TOTAL   216524   208232     4384        0    82916    68345    14570</span><br><span class="line"></span><br><span class="line"> Dalvik Details</span><br><span class="line">        .Heap     6568     6568        0        0</span><br><span class="line">         .LOS    24771    24404        0        0</span><br><span class="line">          .GC      500      500        0        0</span><br><span class="line">    .JITCache      428      428        0        0</span><br><span class="line">      .Zygote     1093      936        0        0</span><br><span class="line">   .NonMoving     1908     1908        0        0</span><br><span class="line"> .IndirectRef       44       44        0        0</span><br><span class="line"></span><br><span class="line"> Objects</span><br><span class="line">               Views:       90         ViewRootImpl:        1</span><br><span class="line">         AppContexts:        4           Activities:        1</span><br><span class="line">              Assets:        2        AssetManagers:        2</span><br><span class="line">       Local Binders:       21        Proxy Binders:       28</span><br><span class="line">       Parcel memory:       18         Parcel count:       74</span><br><span class="line">    Death Recipients:        2      OpenSSL Sockets:        2</span><br></pre></td></tr></table></figure>

<p>Here is an older dumpsys on Dalvik of the gmail app:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">** MEMINFO in pid 9953 [com.google.android.gm] **</span><br><span class="line">                 Pss     Pss  Shared Private  Shared Private    Heap    Heap    Heap</span><br><span class="line">               Total   Clean   Dirty   Dirty   Clean   Clean    Size   Alloc    Free</span><br><span class="line">              ------  ------  ------  ------  ------  ------  ------  ------  ------</span><br><span class="line">  Native Heap      0       0       0       0       0       0    7800    7637(6)  126</span><br><span class="line">  Dalvik Heap   5110(3)    0    4136    4988(3)    0       0    9168    8958(6)  210</span><br><span class="line"> Dalvik Other   2850       0    2684    2772       0       0</span><br><span class="line">        Stack     36       0       8      36       0       0</span><br><span class="line">       Cursor    136       0       0     136       0       0</span><br><span class="line">       Ashmem     12       0      28       0       0       0</span><br><span class="line">    Other dev    380       0      24     376       0       4</span><br><span class="line">     .so mmap   5443(5) 1996    2584    2664(5) 5788    1996(5)</span><br><span class="line">    .apk mmap    235      32       0       0    1252      32</span><br><span class="line">    .ttf mmap     36      12       0       0      88      12</span><br><span class="line">    .dex mmap   3019(5) 2148       0       0    8936    2148(5)</span><br><span class="line">   Other mmap    107       0       8       8     324      68</span><br><span class="line">      Unknown   6994(4)    0     252    6992(4)    0       0</span><br><span class="line">        TOTAL  24358(1) 4188    9724   17972(2)16388    4260(2)16968   16595     336</span><br><span class="line"></span><br><span class="line"> Objects</span><br><span class="line">               Views:    426         ViewRootImpl:        3(8)</span><br><span class="line">         AppContexts:      6(7)        Activities:        2(7)</span><br><span class="line">              Assets:      2        AssetManagers:        2</span><br><span class="line">       Local Binders:     64        Proxy Binders:       34</span><br><span class="line">    Death Recipients:      0</span><br><span class="line">     OpenSSL Sockets:      1</span><br><span class="line"></span><br><span class="line"> SQL</span><br><span class="line">         MEMORY_USED:   1739</span><br><span class="line">  PAGECACHE_OVERFLOW:   1164          MALLOC_SIZE:       62</span><br></pre></td></tr></table></figure>

<p>In general, be concerned with only the <code>Pss Total</code> and <code>Private Dirty</code> columns. In some cases, the <code>Private Clean</code> and <code>Heap Alloc</code> columns also offer interesting data. More information about the different memory allocations(the rows) you should observe follows:</p>
<p><code>Dalvik Heap</code><br>    The RAM used by Dalvik allocations in your app. The <code>Pss Total</code> includes all Zygote allocations(weighted by their sharing across processes, as described in the PSS definition above). The <code>Private Dirty</code> number is the actual RAM committed to only your app’s heap, composed of your own allocations and any Zygote allocation pages that have been modified since forking your app’s process from Zygote.<br>    The <code>Heap Alloc</code> is the amount of memory that the Dalvik and native heap allocators keep track of for your app. This value is larger thatn <code>Pss Total</code> and <code>Private Dirty</code> because your process was forked from Zygote and it includes allocations that your process shares with all the others.</p>
<p><code>.so mmap</code> and <code>.dex mmap</code><br>    The RAM being used for mapped <code>.so</code>(native) and <code>.dex</code> (Dalvik or ART) code. The <code>Pss Total</code> number includes platform code shared across apps; t he <code>Private Clean</code> is your app’s own code. Generally, the actual mapped size will be much larger-the RAM here is only what currently needs to be in RAM for code  that has been executed by the app. However, the .so mmap has a large private dirty, which is due to fix-ups to the native code when it was loaded into its final address.</p>
<p><code>.oat mmap</code><br>    This is the amount of RAM used by the code image which is based off of the preloaded classes which are commonly used by multiple apps. This image is shared across all apps and is unaffected by particular apps.</p>
<p><code>.art mmap</code><br>    This is the amount of RAM used buy the heap image which is based off of the preloaded class which are commonly used by multiple apps. this image is shared across all apps and is unaffected by particular apps. Even though the ART image contains <code>Object</code> instances, it does not count towards your heap size.</p>
<p><code>.Heap</code>(only with -d flag)<br>    This is the amount of heap memory for your app. This excludes objects in the image and large object spaces, but includes the zygote space and non-moving space.</p>
<p><code>.LOS</code>(only with -d flag)<br>    This is the amount of RAM used by the ART large object space. This includes zygote large objects. Large objects are all primitive array allocations larger than 12KB.</p>
<p><code>.GC</code> (only with -d flag)<br>    This is the overhead cost for garbage collection. There is not really any way to reduce this overhead.</p>
<p><code>.JITCache</code> (only with -d flag)<br>    This is the amount of memory used by the JIT data and code caches. Typically, this is zero since all of the apps will be compiled at installed time.</p>
<p><code>.Zygote</code> (only with -d flag)<br>    This is the amount of memory used by the zygote space. The zygote space is created during device startup and is never allocated into.</p>
<p><code>.NonMoving</code> (only with -d flag)<br>    This is the amount of RAM used by the ART non-moving space. The non-moving space contains special non-movable objects such as fields and methods . You can reduce this section by using fewer fields and methods in your app.</p>
<p><code>.IndirectRef</code> (only with -d flag)<br>    This is the amount of RAM used by the ART indirect reference tables. Usually this amount is small, but if it is too high, it might be possible to reduce it by reducing the number of local and global JNI references used. </p>
<p><code>Unknown</code><br>    Any RAM pages that the system could not classify into one of the other more specific items. Currently, this contains mostly native allocations, which cannot be identified by the tool when collecting this data due to Address Space Layout Randomization (ASLR). Like the Dalvik heap, the <code>Pss Total</code> for Unknown takes into account sharing with Zygote, and <code>Private Dirty</code> is unknown RAM dedicated to only your app.</p>
<p><code>TOTAL</code><br>    The total Proportional Set Size (PSS) RAM used by your process. This is the sum of all PSS fields above it. It indicates the overall memory weight of your process, which can be directly compared with other processes and the total available RAM.<br>    The <code>Private Dirty</code> and <code>Private Clean</code> are the total allocations within your process, which are not shared with other processes. Together (especially <code>Private Dirty</code>), this is the amount of RAM that will be released back to the system when your process is destroyed. Dirty RAM is pages that have been modified and so must stay committed to RAM (because there is no swap); clean RAM is pages that have been mapped from a persistent file (such as code being executed) and so can be paged out if not used for a while.</p>
<p><code>ViewRootImp</code><br>    The number of root views that are active in your process. Each root view is associated with a window, so this can help you identify memory leaks involving dialogs or other windows.</p>
<p><code>AppContext</code> and <code>Activities</code><br>    The number of app Context and Activity objects that currently live in your process. This can help you to quickly identify leaked Activity objects that can’t be garbage collected due to static references on them, which is common. These objects often have many other allocations associated with them, which makes them a good way to track large memory leaks.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.scions.cn/2019/06/05/Android-Fragment懒加载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ScorpioNeal">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ScorpioNeal's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/05/Android-Fragment懒加载/" itemprop="url">Android-Fragment懒加载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-05T11:06:06+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/05/Android-Fragment懒加载/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/05/Android-Fragment懒加载/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通用的使用方法是: <code>Fragment</code> + <code>ViewPager</code>配合使用</p>
<p>ViewPager的解析，单独放到其他博文来说，这里主要注意一下,ViewPager的常用的两种Adapter的用法和区别:</p>
<ul>
<li><p>FragmentPagerAdapter</p>
<p> 将每一个生成的Fragment都放到内存里, 无论怎么滑动ViewPager, 都不会有一个Fragment的onDestroy被调用. 当Fragment不在ViewPager.setOffScreenPageLimit()保护范围内，相应的Fragment的onDestroyView会执行，但是Fragment仍然存在.</p>
</li>
<li><p>FragmentStatePagerAdapter</p>
<p>  当Fragment不在ViewPager.setOffScreenPageLimit()保护范围内，Fragment就会被销毁, onDestroy方法会执行</p>
</li>
</ul>
<p>刚New出来的Fragment没有开始它的生命周期，只有被添加到FragmentManager时，生命周期才开始</p>
<p>最好的实现懒加载的方案就是通过重写setUserVisibleHint()方法来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Set a hint to the system about whether this fragment's UI is currently visible</span></span><br><span class="line"><span class="comment">    * to the user. This hint defaults to true and is persistent across fragment instance</span></span><br><span class="line"><span class="comment">    * state save and restore.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;An app may set this to false to indicate that the fragment's UI is</span></span><br><span class="line"><span class="comment">    * scrolled out of visibility or is otherwise not directly visible to the user.</span></span><br><span class="line"><span class="comment">    * This may be used by the system to prioritize operations such as fragment lifecycle updates</span></span><br><span class="line"><span class="comment">    * or loader ordering behavior.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; This method may be called outside of the fragment lifecycle</span></span><br><span class="line"><span class="comment">    * and thus has no ordering guarantees with regard to fragment lifecycle method calls.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Prior to Android N there was a platform bug that could cause</span></span><br><span class="line"><span class="comment">    * &lt;code&gt;setUserVisibleHint&lt;/code&gt; to bring a fragment up to the started state before its</span></span><br><span class="line"><span class="comment">    * &lt;code&gt;FragmentTransaction&lt;/code&gt; had been committed. As some apps relied on this behavior,</span></span><br><span class="line"><span class="comment">    * it is preserved for apps that declare a &lt;code&gt;targetSdkVersion&lt;/code&gt; of 23 or lower.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> isVisibleToUser true if this fragment's UI is currently visible to the user (default),</span></span><br><span class="line"><span class="comment">    *                        false if it is not.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span></span></span><br></pre></td></tr></table></figure>

<p><code>isVisibleToUserFragment</code>标示当前Fragment是否处于对用户的可见状态, 贯穿整个<code>Fragment</code>生命周期, 也就是可能在<code>Fragment</code>生命周期以外被调用。 因此，在<code>setUserVisibleHint</code>方法中处理懒加载的话，需要保证其他变量以及<code>view</code>都已经初始化完成，防止空指针问题. </p>
<p>可以参考开源代码: <a href="https://github.com/TellH/FragmentLazyLoading" target="_blank" rel="noopener">https://github.com/TellH/FragmentLazyLoading</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ScorpioNeal</p>
              <p class="site-description motion-element" itemprop="description">Teaching is the best way to learn.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ScorpioNeal</span>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'Bp6gNEmnfgAF2Ci7moO9v4Rm-gzGzoHsz',
        appKey: 'xNstrbz0DRkVzIMvuDNrkAOh',
        placeholder: '要不要说点啥',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
